{
  "hash": "afa6920d255fa6209dfb5b9d7b349484",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Diffusion unet\njupyter: python3\n---\n\n::: {#da39ec7b .cell execution_count=1}\n``` {.python .cell-code}\nimport os\n# os.environ['CUDA_VISIBLE_DEVICES']='1'\n```\n:::\n\n\n::: {#4d0d15a8 .cell execution_count=2}\n``` {.python .cell-code}\nimport timm, torch, random, datasets, math, fastcore.all as fc, numpy as np, matplotlib as mpl, matplotlib.pyplot as plt\nimport k_diffusion as K, torchvision.transforms as T\nimport torchvision.transforms.functional as TF,torch.nn.functional as F\n\nfrom torch.utils.data import DataLoader,default_collate\nfrom pathlib import Path\nfrom torch.nn import init\nfrom fastcore.foundation import L\nfrom torch import nn,tensor\nfrom datasets import load_dataset\nfrom operator import itemgetter\nfrom torcheval.metrics import MulticlassAccuracy\nfrom functools import partial\nfrom torch.optim import lr_scheduler\nfrom torch import optim\n\nfrom miniai.datasets import *\nfrom miniai.conv import *\nfrom miniai.learner import *\nfrom miniai.activations import *\nfrom miniai.init import *\nfrom miniai.sgd import *\nfrom miniai.resnet import *\nfrom miniai.augment import *\nfrom miniai.accel import *\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[2], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">timm</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">random</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">datasets</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">math</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fastcore</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">all</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fc</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">numpy</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">np</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">mpl</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">pyplot</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">plt</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">k_diffusion</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">K</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torchvision</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">transforms</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">T</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torchvision</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">transforms</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">functional</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">TF</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">nn</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">functional</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">F</span>\n\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>: No module named 'timm'</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4692dee8 .cell execution_count=3}\n``` {.python .cell-code}\nfrom fastprogress import progress_bar\nfrom diffusers import UNet2DModel, DDIMPipeline, DDPMPipeline, DDIMScheduler, DDPMScheduler\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[3], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fastprogress</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> progress_bar\n<span class=\"ansi-green-fg\">----&gt; 2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">diffusers</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> UNet2DModel, DDIMPipeline, DDPMPipeline, DDIMScheduler, DDPMScheduler\n\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>: No module named 'diffusers'</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#9a315b5c .cell execution_count=4}\n``` {.python .cell-code}\ntorch.set_printoptions(precision=5, linewidth=140, sci_mode=False)\ntorch.manual_seed(1)\nmpl.rcParams['image.cmap'] = 'gray_r'\nmpl.rcParams['figure.dpi'] = 70\n\nimport logging\nlogging.disable(logging.WARNING)\n\nset_seed(42)\nif fc.defaults.cpus>8: fc.defaults.cpus=8\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[4], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>set_printoptions(precision<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">5</span>, linewidth<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">140</span>, sci_mode<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> torch<span style=\"color:rgb(98,98,98)\">.</span>manual_seed(<span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> mpl<span style=\"color:rgb(98,98,98)\">.</span>rcParams[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">image.cmap</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">gray_r</span><span style=\"color:rgb(175,0,0)\">'</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b04b74a3 .cell execution_count=5}\n``` {.python .cell-code}\nxl,yl = 'image','label'\nname = \"fashion_mnist\"\nn_steps = 1000\nbs = 512\ndsd = load_dataset(name)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[5], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> n_steps <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">1000</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> bs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">512</span>\n<span class=\"ansi-green-fg\">----&gt; 5</span> dsd <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">load_dataset</span>(name)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'load_dataset' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8fc3a13c .cell execution_count=6}\n``` {.python .cell-code}\nsig_data = 0.66\n```\n:::\n\n\n::: {#d9bdfd65 .cell execution_count=7}\n``` {.python .cell-code}\n@inplace\ndef transformi(b): b[xl] = [F.pad(TF.to_tensor(o), (2,2,2,2))*2-1 for o in b[xl]]\n\ndef scalings(sig):\n    totvar = sig**2+sig_data**2\n    # c_skip,c_out,c_in\n    return sig_data**2/totvar,sig*sig_data/totvar.sqrt(),1/totvar.sqrt()\n\ndef noisify(x0):\n    device = x0.device\n    sig = (torch.randn([len(x0)])*1.2-1.2).exp().to(x0).reshape(-1,1,1,1)\n    noise = torch.randn_like(x0, device=device)\n    c_skip,c_out,c_in = scalings(sig)\n    noised_input = x0 + noise*sig\n    target = (x0-c_skip*noised_input)/c_out\n    return (noised_input*c_in,sig.squeeze()),target\n\ndef collate_ddpm(b): return noisify(default_collate(b)[xl])\ndef dl_ddpm(ds): return DataLoader(ds, batch_size=bs, collate_fn=collate_ddpm, num_workers=0)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[7], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(175,0,255)\">@inplace</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">transformi</span>(b): b[xl] <span style=\"color:rgb(98,98,98)\">=</span> [F<span style=\"color:rgb(98,98,98)\">.</span>pad(TF<span style=\"color:rgb(98,98,98)\">.</span>to_tensor(o), (<span style=\"color:rgb(98,98,98)\">2</span>,<span style=\"color:rgb(98,98,98)\">2</span>,<span style=\"color:rgb(98,98,98)\">2</span>,<span style=\"color:rgb(98,98,98)\">2</span>))<span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">2</span><span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> o <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> b[xl]]\n<span class=\"ansi-green-fg ansi-bold\">      4</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">scalings</span>(sig):\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'inplace' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cc5e5897 .cell execution_count=8}\n``` {.python .cell-code}\ntds = dsd.with_transform(transformi)\ndls = DataLoaders(dl_ddpm(tds['train']), dl_ddpm(tds['test']))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[8], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> tds <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">dsd</span><span style=\"color:rgb(98,98,98)\">.</span>with_transform(transformi)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> dls <span style=\"color:rgb(98,98,98)\">=</span> DataLoaders(dl_ddpm(tds[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">train</span><span style=\"color:rgb(175,0,0)\">'</span>]), dl_ddpm(tds[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">test</span><span style=\"color:rgb(175,0,0)\">'</span>]))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dsd' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Train\n\nBased on Diffusers\n\n::: {#f9fabc3a .cell execution_count=9}\n``` {.python .cell-code}\ndef unet_conv(ni, nf, ks=3, stride=1, act=nn.SiLU, norm=None, bias=True):\n    layers = nn.Sequential()\n    if norm: layers.append(norm(ni))\n    if act : layers.append(act())\n    layers.append(nn.Conv2d(ni, nf, stride=stride, kernel_size=ks, padding=ks//2, bias=bias))\n    return layers\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[9], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">unet_conv</span>(ni, nf, ks<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, stride<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>, act<span style=\"color:rgb(98,98,98)\">=</span><span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>SiLU, norm<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>, bias<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     layers <span style=\"color:rgb(98,98,98)\">=</span> nn<span style=\"color:rgb(98,98,98)\">.</span>Sequential()\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> norm: layers<span style=\"color:rgb(98,98,98)\">.</span>append(norm(ni))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#458b2a32 .cell execution_count=10}\n``` {.python .cell-code}\nclass UnetResBlock(nn.Module):\n    def __init__(self, ni, nf=None, ks=3, act=nn.SiLU, norm=nn.BatchNorm2d):\n        super().__init__()\n        if nf is None: nf = ni\n        self.convs = nn.Sequential(unet_conv(ni, nf, ks, act=act, norm=norm),\n                                   unet_conv(nf, nf, ks, act=act, norm=norm))\n        self.idconv = fc.noop if ni==nf else nn.Conv2d(ni, nf, 1)\n\n    def forward(self, x): return self.convs(x) + self.idconv(x)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[10], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">UnetResBlock</span>(<span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Module):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>(<span style=\"color:rgb(0,135,0)\">self</span>, ni, nf<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>, ks<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, act<span style=\"color:rgb(98,98,98)\">=</span>nn<span style=\"color:rgb(98,98,98)\">.</span>SiLU, norm<span style=\"color:rgb(98,98,98)\">=</span>nn<span style=\"color:rgb(98,98,98)\">.</span>BatchNorm2d):\n<span class=\"ansi-green-fg ansi-bold\">      3</span>         <span style=\"color:rgb(0,135,0)\">super</span>()<span style=\"color:rgb(98,98,98)\">.</span><span style=\"color:rgb(0,0,255)\">__init__</span>()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ac1b7b65 .cell execution_count=11}\n``` {.python .cell-code}\nclass A:\n    def __call__(self):\n        super().__call__()\n        print('a')\n\nclass B:\n    def __call__(self): print('b')\n\nclass C(A,B): pass\n```\n:::\n\n\n::: {#4e446856 .cell execution_count=12}\n``` {.python .cell-code}\nC()()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nb\na\n```\n:::\n:::\n\n\n::: {#76c17679 .cell execution_count=13}\n``` {.python .cell-code}\nclass SaveModule:\n    def forward(self, x, *args, **kwargs):\n        self.saved = super().forward(x, *args, **kwargs)\n        return self.saved\n\nclass SavedResBlock(SaveModule, UnetResBlock): pass\nclass SavedConv(SaveModule, nn.Conv2d): pass\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[13], line 6</span>\n<span class=\"ansi-green-fg\">----&gt; 6</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">SavedResBlock</span>(SaveModule, UnetResBlock): <span style=\"font-weight:bold;color:rgb(0,135,0)\">pass</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'UnetResBlock' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#43660cd4 .cell execution_count=14}\n``` {.python .cell-code}\ndef down_block(ni, nf, add_down=True, num_layers=1):\n    res = nn.Sequential(*[SavedResBlock(ni=ni if i==0 else nf, nf=nf)\n                         for i in range(num_layers)])\n    if add_down: res.append(SavedConv(nf, nf, 3, stride=2, padding=1))\n    return res\n```\n:::\n\n\n::: {#30266f98 .cell execution_count=15}\n``` {.python .cell-code}\ndef upsample(nf): return nn.Sequential(nn.Upsample(scale_factor=2.), nn.Conv2d(nf, nf, 3, padding=1))\n```\n:::\n\n\n::: {#43370dc5 .cell execution_count=16}\n``` {.python .cell-code}\nclass UpBlock(nn.Module):\n    def __init__(self, ni, prev_nf, nf, add_up=True, num_layers=2):\n        super().__init__()\n        self.resnets = nn.ModuleList(\n            [UnetResBlock((prev_nf if i==0 else nf)+(ni if (i==num_layers-1) else nf), nf)\n            for i in range(num_layers)])\n        self.up = upsample(nf) if add_up else nn.Identity()\n\n    def forward(self, x, ups):\n        for resnet in self.resnets: x = resnet(torch.cat([x, ups.pop()], dim=1))\n        return self.up(x)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[16], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">UpBlock</span>(<span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Module):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>(<span style=\"color:rgb(0,135,0)\">self</span>, ni, prev_nf, nf, add_up<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>, num_layers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>):\n<span class=\"ansi-green-fg ansi-bold\">      3</span>         <span style=\"color:rgb(0,135,0)\">super</span>()<span style=\"color:rgb(98,98,98)\">.</span><span style=\"color:rgb(0,0,255)\">__init__</span>()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#9ca8f303 .cell execution_count=17}\n``` {.python .cell-code}\nclass UNet2DModel(nn.Module):\n    def __init__( self, in_channels=3, out_channels=3, nfs=(224,448,672,896), num_layers=1):\n        super().__init__()\n        self.conv_in = nn.Conv2d(in_channels, nfs[0], kernel_size=3, padding=1)\n        nf = nfs[0]\n        self.downs = nn.Sequential()\n        for i in range(len(nfs)):\n            ni = nf\n            nf = nfs[i]\n            self.downs.append(down_block(ni, nf, add_down=i!=len(nfs)-1, num_layers=num_layers))\n        self.mid_block = UnetResBlock(nfs[-1])\n\n        rev_nfs = list(reversed(nfs))\n        nf = rev_nfs[0]\n        self.ups = nn.ModuleList()\n        for i in range(len(nfs)):\n            prev_nf = nf\n            nf = rev_nfs[i]\n            ni = rev_nfs[min(i+1, len(nfs)-1)]\n            self.ups.append(UpBlock(ni, prev_nf, nf, add_up=i!=len(nfs)-1, num_layers=num_layers+1))\n        self.conv_out = unet_conv(nfs[0], out_channels, act=nn.SiLU, norm=nn.BatchNorm2d)\n\n    def forward(self, inp):\n        x = self.conv_in(inp[0])\n        saved = [x]\n        x = self.downs(x)\n        saved += [p.saved for o in self.downs for p in o]\n        x = self.mid_block(x)\n        for block in self.ups: x = block(x, saved)\n        return self.conv_out(x)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[17], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">UNet2DModel</span>(<span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Module):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>( <span style=\"color:rgb(0,135,0)\">self</span>, in_channels<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, out_channels<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, nfs<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">224</span>,<span style=\"color:rgb(98,98,98)\">448</span>,<span style=\"color:rgb(98,98,98)\">672</span>,<span style=\"color:rgb(98,98,98)\">896</span>), num_layers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>):\n<span class=\"ansi-green-fg ansi-bold\">      3</span>         <span style=\"color:rgb(0,135,0)\">super</span>()<span style=\"color:rgb(98,98,98)\">.</span><span style=\"color:rgb(0,0,255)\">__init__</span>()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#89a1cd18 .cell execution_count=18}\n``` {.python .cell-code}\nmodel = UNet2DModel(in_channels=1, out_channels=1, nfs=(32,64,128,256), num_layers=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[18], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> model <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">UNet2DModel</span>(in_channels<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>, out_channels<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>, nfs<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">32</span>,<span style=\"color:rgb(98,98,98)\">64</span>,<span style=\"color:rgb(98,98,98)\">128</span>,<span style=\"color:rgb(98,98,98)\">256</span>), num_layers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'UNet2DModel' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#af5fcee4 .cell execution_count=19}\n``` {.python .cell-code}\nlr = 3e-3\nepochs = 25\nopt_func = partial(optim.Adam, eps=1e-5)\ntmax = epochs * len(dls.train)\nsched = partial(lr_scheduler.OneCycleLR, max_lr=lr, total_steps=tmax)\ncbs = [DeviceCB(), MixedPrecision(), ProgressCB(plot=True), MetricsCB(), BatchSchedCB(sched)]\nlearn = Learner(model, dls, nn.MSELoss(), lr=lr, cbs=cbs, opt_func=opt_func)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[19], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> lr <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">3e-3</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> epochs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">25</span>\n<span class=\"ansi-green-fg\">----&gt; 3</span> opt_func <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">partial</span>(optim<span style=\"color:rgb(98,98,98)\">.</span>Adam, eps<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1e-5</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> tmax <span style=\"color:rgb(98,98,98)\">=</span> epochs <span style=\"color:rgb(98,98,98)\">*</span> <span style=\"color:rgb(0,135,0)\">len</span>(dls<span style=\"color:rgb(98,98,98)\">.</span>train)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> sched <span style=\"color:rgb(98,98,98)\">=</span> partial(lr_scheduler<span style=\"color:rgb(98,98,98)\">.</span>OneCycleLR, max_lr<span style=\"color:rgb(98,98,98)\">=</span>lr, total_steps<span style=\"color:rgb(98,98,98)\">=</span>tmax)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'partial' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f65360ce .cell execution_count=20}\n``` {.python .cell-code}\nlearn.fit(epochs)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[20], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">learn</span><span style=\"color:rgb(98,98,98)\">.</span>fit(epochs)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'learn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Timesteps\n\n::: {#869f6a72 .cell execution_count=21}\n``` {.python .cell-code}\nemb_dim = 16\ntsteps = torch.linspace(-10,10,100)\nmax_period = 10000\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[21], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> emb_dim <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">16</span>\n<span class=\"ansi-green-fg\">----&gt; 2</span> tsteps <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>linspace(<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">10</span>,<span style=\"color:rgb(98,98,98)\">10</span>,<span style=\"color:rgb(98,98,98)\">100</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> max_period <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">10000</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#712140b7 .cell execution_count=22}\n``` {.python .cell-code}\nmath.log(10000)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[22], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">math</span><span style=\"color:rgb(98,98,98)\">.</span>log(<span style=\"color:rgb(98,98,98)\">10000</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'math' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#492cac6a .cell execution_count=23}\n``` {.python .cell-code}\nexponent = -math.log(max_period) * torch.linspace(0, 1, emb_dim//2, device=tsteps.device)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[23], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> exponent <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">-</span><span class=\"ansi-yellow-bg\">math</span><span style=\"color:rgb(98,98,98)\">.</span>log(max_period) <span style=\"color:rgb(98,98,98)\">*</span> torch<span style=\"color:rgb(98,98,98)\">.</span>linspace(<span style=\"color:rgb(98,98,98)\">0</span>, <span style=\"color:rgb(98,98,98)\">1</span>, emb_dim<span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(98,98,98)\">2</span>, device<span style=\"color:rgb(98,98,98)\">=</span>tsteps<span style=\"color:rgb(98,98,98)\">.</span>device)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'math' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#6314b854 .cell execution_count=24}\n``` {.python .cell-code}\nplt.plot(exponent);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[24], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">plt</span><span style=\"color:rgb(98,98,98)\">.</span>plot(exponent);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'plt' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#140aa7dd .cell execution_count=25}\n``` {.python .cell-code}\nemb = tsteps[:,None].float() * exponent.exp()[None,:]\nemb.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[25], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> emb <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">tsteps</span>[:,<span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>]<span style=\"color:rgb(98,98,98)\">.</span>float() <span style=\"color:rgb(98,98,98)\">*</span> exponent<span style=\"color:rgb(98,98,98)\">.</span>exp()[<span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>,:]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> emb<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tsteps' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#81bb19a8 .cell execution_count=26}\n``` {.python .cell-code}\nplt.plot(emb[0])\nplt.plot(emb[10])\nplt.plot(emb[20])\nplt.plot(emb[50])\nplt.plot(emb[-1]);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[26], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">plt</span><span style=\"color:rgb(98,98,98)\">.</span>plot(emb[<span style=\"color:rgb(98,98,98)\">0</span>])\n<span class=\"ansi-green-fg ansi-bold\">      2</span> plt<span style=\"color:rgb(98,98,98)\">.</span>plot(emb[<span style=\"color:rgb(98,98,98)\">10</span>])\n<span class=\"ansi-green-fg ansi-bold\">      3</span> plt<span style=\"color:rgb(98,98,98)\">.</span>plot(emb[<span style=\"color:rgb(98,98,98)\">20</span>])\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'plt' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#115e8e3e .cell execution_count=27}\n``` {.python .cell-code}\nemb = torch.cat([torch.sin(emb), torch.cos(emb)], dim=-1)\nemb.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[27], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> emb <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>cat([torch<span style=\"color:rgb(98,98,98)\">.</span>sin(emb), torch<span style=\"color:rgb(98,98,98)\">.</span>cos(emb)], dim<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> emb<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#643d075a .cell execution_count=28}\n``` {.python .cell-code}\nplt.plot(emb[:,0])\nplt.plot(emb[:,1])\nplt.plot(emb[:,2])\nplt.plot(emb[:,3])\nplt.plot(emb[:,4]);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[28], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">plt</span><span style=\"color:rgb(98,98,98)\">.</span>plot(emb[:,<span style=\"color:rgb(98,98,98)\">0</span>])\n<span class=\"ansi-green-fg ansi-bold\">      2</span> plt<span style=\"color:rgb(98,98,98)\">.</span>plot(emb[:,<span style=\"color:rgb(98,98,98)\">1</span>])\n<span class=\"ansi-green-fg ansi-bold\">      3</span> plt<span style=\"color:rgb(98,98,98)\">.</span>plot(emb[:,<span style=\"color:rgb(98,98,98)\">2</span>])\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'plt' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d3fcfd53 .cell execution_count=29}\n``` {.python .cell-code}\nplt.plot(emb[:,8])\nplt.plot(emb[:,9])\nplt.plot(emb[:,10]);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[29], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">plt</span><span style=\"color:rgb(98,98,98)\">.</span>plot(emb[:,<span style=\"color:rgb(98,98,98)\">8</span>])\n<span class=\"ansi-green-fg ansi-bold\">      2</span> plt<span style=\"color:rgb(98,98,98)\">.</span>plot(emb[:,<span style=\"color:rgb(98,98,98)\">9</span>])\n<span class=\"ansi-green-fg ansi-bold\">      3</span> plt<span style=\"color:rgb(98,98,98)\">.</span>plot(emb[:,<span style=\"color:rgb(98,98,98)\">10</span>]);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'plt' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ec2b8715 .cell execution_count=30}\n``` {.python .cell-code}\nshow_image(emb.T, figsize=(7,7));\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[30], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_image</span>(emb<span style=\"color:rgb(98,98,98)\">.</span>T, figsize<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">7</span>,<span style=\"color:rgb(98,98,98)\">7</span>));\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#517e0d33 .cell execution_count=31}\n``` {.python .cell-code}\ndef timestep_embedding(tsteps, emb_dim, max_period= 10000):\n    exponent = -math.log(max_period) * torch.linspace(0, 1, emb_dim//2, device=tsteps.device)\n    emb = tsteps[:,None].float() * exponent.exp()[None,:]\n    emb = torch.cat([emb.sin(), emb.cos()], dim=-1)\n    return F.pad(emb, (0,1,0,0)) if emb_dim%2==1 else emb\n```\n:::\n\n\n::: {#a139ec2a .cell execution_count=32}\n``` {.python .cell-code}\nshow_image(timestep_embedding(tsteps, 32, max_period=1000).T, figsize=(7,7));\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[32], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_image</span>(timestep_embedding(tsteps, <span style=\"color:rgb(98,98,98)\">32</span>, max_period<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1000</span>)<span style=\"color:rgb(98,98,98)\">.</span>T, figsize<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">7</span>,<span style=\"color:rgb(98,98,98)\">7</span>));\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ee8a6f34 .cell execution_count=33}\n``` {.python .cell-code}\nshow_image(timestep_embedding(tsteps, 32, max_period=10).T, figsize=(7,7));\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[33], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_image</span>(timestep_embedding(tsteps, <span style=\"color:rgb(98,98,98)\">32</span>, max_period<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">10</span>)<span style=\"color:rgb(98,98,98)\">.</span>T, figsize<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">7</span>,<span style=\"color:rgb(98,98,98)\">7</span>));\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Timestep model\n\n::: {#f2e78202 .cell execution_count=34}\n``` {.python .cell-code}\nfrom functools import wraps\n```\n:::\n\n\n::: {#6cb8b8a9 .cell execution_count=35}\n``` {.python .cell-code}\ndef lin(ni, nf, act=nn.SiLU, norm=None, bias=True):\n    layers = nn.Sequential()\n    if norm: layers.append(norm(ni))\n    if act : layers.append(act())\n    layers.append(nn.Linear(ni, nf, bias=bias))\n    return layers\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[35], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">lin</span>(ni, nf, act<span style=\"color:rgb(98,98,98)\">=</span><span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>SiLU, norm<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>, bias<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     layers <span style=\"color:rgb(98,98,98)\">=</span> nn<span style=\"color:rgb(98,98,98)\">.</span>Sequential()\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> norm: layers<span style=\"color:rgb(98,98,98)\">.</span>append(norm(ni))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cabb2c6e .cell execution_count=36}\n``` {.python .cell-code}\nclass EmbResBlock(nn.Module):\n    def __init__(self, n_emb, ni, nf=None, ks=3, act=nn.SiLU, norm=nn.BatchNorm2d):\n        super().__init__()\n        if nf is None: nf = ni\n        self.emb_proj = nn.Linear(n_emb, nf*2)\n        self.conv1 = unet_conv(ni, nf, ks, act=act, norm=norm) #, bias=not norm)\n        self.conv2 = unet_conv(nf, nf, ks, act=act, norm=norm)\n        self.idconv = fc.noop if ni==nf else nn.Conv2d(ni, nf, 1)\n\n    def forward(self, x, t):\n        inp = x\n        x = self.conv1(x)\n        emb = self.emb_proj(F.silu(t))[:, :, None, None]\n        scale,shift = torch.chunk(emb, 2, dim=1)\n        x = x*(1+scale) + shift\n        x = self.conv2(x)\n        return x + self.idconv(inp)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[36], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">EmbResBlock</span>(<span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Module):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>(<span style=\"color:rgb(0,135,0)\">self</span>, n_emb, ni, nf<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>, ks<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, act<span style=\"color:rgb(98,98,98)\">=</span>nn<span style=\"color:rgb(98,98,98)\">.</span>SiLU, norm<span style=\"color:rgb(98,98,98)\">=</span>nn<span style=\"color:rgb(98,98,98)\">.</span>BatchNorm2d):\n<span class=\"ansi-green-fg ansi-bold\">      3</span>         <span style=\"color:rgb(0,135,0)\">super</span>()<span style=\"color:rgb(98,98,98)\">.</span><span style=\"color:rgb(0,0,255)\">__init__</span>()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1a23c29a .cell execution_count=37}\n``` {.python .cell-code}\ndef saved(m, blk):\n    m_ = m.forward\n\n    @wraps(m.forward)\n    def _f(*args, **kwargs):\n        res = m_(*args, **kwargs)\n        blk.saved.append(res)\n        return res\n\n    m.forward = _f\n    return m\n```\n:::\n\n\n::: {#ddd3afa5 .cell execution_count=38}\n``` {.python .cell-code}\nclass DownBlock(nn.Module):\n    def __init__(self, n_emb, ni, nf, add_down=True, num_layers=1):\n        super().__init__()\n        self.resnets = nn.ModuleList([saved(EmbResBlock(n_emb, ni if i==0 else nf, nf), self)\n                                      for i in range(num_layers)])\n        self.down = saved(nn.Conv2d(nf, nf, 3, stride=2, padding=1), self) if add_down else nn.Identity()\n\n    def forward(self, x, t):\n        self.saved = []\n        for resnet in self.resnets: x = resnet(x, t)\n        x = self.down(x)\n        return x\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[38], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">DownBlock</span>(<span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Module):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>(<span style=\"color:rgb(0,135,0)\">self</span>, n_emb, ni, nf, add_down<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>, num_layers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>):\n<span class=\"ansi-green-fg ansi-bold\">      3</span>         <span style=\"color:rgb(0,135,0)\">super</span>()<span style=\"color:rgb(98,98,98)\">.</span><span style=\"color:rgb(0,0,255)\">__init__</span>()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#64b3f61a .cell execution_count=39}\n``` {.python .cell-code}\nclass UpBlock(nn.Module):\n    def __init__(self, n_emb, ni, prev_nf, nf, add_up=True, num_layers=2):\n        super().__init__()\n        self.resnets = nn.ModuleList(\n            [EmbResBlock(n_emb, (prev_nf if i==0 else nf)+(ni if (i==num_layers-1) else nf), nf)\n            for i in range(num_layers)])\n        self.up = upsample(nf) if add_up else nn.Identity()\n\n    def forward(self, x, t, ups):\n        for resnet in self.resnets: x = resnet(torch.cat([x, ups.pop()], dim=1), t)\n        return self.up(x)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[39], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">UpBlock</span>(<span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Module):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>(<span style=\"color:rgb(0,135,0)\">self</span>, n_emb, ni, prev_nf, nf, add_up<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>, num_layers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>):\n<span class=\"ansi-green-fg ansi-bold\">      3</span>         <span style=\"color:rgb(0,135,0)\">super</span>()<span style=\"color:rgb(98,98,98)\">.</span><span style=\"color:rgb(0,0,255)\">__init__</span>()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#35162e87 .cell execution_count=40}\n``` {.python .cell-code}\nclass EmbUNetModel(nn.Module):\n    def __init__( self, in_channels=3, out_channels=3, nfs=(224,448,672,896), num_layers=1):\n        super().__init__()\n        self.conv_in = nn.Conv2d(in_channels, nfs[0], kernel_size=3, padding=1)\n        self.n_temb = nf = nfs[0]\n        n_emb = nf*4\n        # TODO: remove act func from 1st MLP layer\n        self.emb_mlp = nn.Sequential(lin(self.n_temb, n_emb, norm=nn.BatchNorm1d),\n                                     lin(n_emb, n_emb))\n        self.downs = nn.ModuleList()\n        for i in range(len(nfs)):\n            ni = nf\n            nf = nfs[i]\n            self.downs.append(DownBlock(n_emb, ni, nf, add_down=i!=len(nfs)-1, num_layers=num_layers))\n        self.mid_block = EmbResBlock(n_emb, nfs[-1])\n\n        rev_nfs = list(reversed(nfs))\n        nf = rev_nfs[0]\n        self.ups = nn.ModuleList()\n        for i in range(len(nfs)):\n            prev_nf = nf\n            nf = rev_nfs[i]\n            ni = rev_nfs[min(i+1, len(nfs)-1)]\n            self.ups.append(UpBlock(n_emb, ni, prev_nf, nf, add_up=i!=len(nfs)-1, num_layers=num_layers+1))\n        self.conv_out = unet_conv(nfs[0], out_channels, act=nn.SiLU, norm=nn.BatchNorm2d, bias=False)\n\n    def forward(self, inp):\n        x,t = inp\n        temb = timestep_embedding(t, self.n_temb)\n        emb = self.emb_mlp(temb)\n        x = self.conv_in(x)\n        saved = [x]\n        for block in self.downs: x = block(x, emb)\n        saved += [p for o in self.downs for p in o.saved]\n        x = self.mid_block(x, emb)\n        for block in self.ups: x = block(x, emb, saved)\n        return self.conv_out(x)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[40], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">EmbUNetModel</span>(<span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Module):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>( <span style=\"color:rgb(0,135,0)\">self</span>, in_channels<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, out_channels<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, nfs<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">224</span>,<span style=\"color:rgb(98,98,98)\">448</span>,<span style=\"color:rgb(98,98,98)\">672</span>,<span style=\"color:rgb(98,98,98)\">896</span>), num_layers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>):\n<span class=\"ansi-green-fg ansi-bold\">      3</span>         <span style=\"color:rgb(0,135,0)\">super</span>()<span style=\"color:rgb(98,98,98)\">.</span><span style=\"color:rgb(0,0,255)\">__init__</span>()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#940cc3ca .cell execution_count=41}\n``` {.python .cell-code}\nmodel = EmbUNetModel(in_channels=1, out_channels=1, nfs=(32,64,128,256), num_layers=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[41], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> model <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">EmbUNetModel</span>(in_channels<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>, out_channels<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>, nfs<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">32</span>,<span style=\"color:rgb(98,98,98)\">64</span>,<span style=\"color:rgb(98,98,98)\">128</span>,<span style=\"color:rgb(98,98,98)\">256</span>), num_layers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'EmbUNetModel' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#93d87611 .cell execution_count=42}\n``` {.python .cell-code}\nlr = 1e-2\nepochs = 25\nopt_func = partial(optim.Adam, eps=1e-5)\ntmax = epochs * len(dls.train)\nsched = partial(lr_scheduler.OneCycleLR, max_lr=lr, total_steps=tmax)\ncbs = [DeviceCB(), ProgressCB(plot=True), MetricsCB(), BatchSchedCB(sched), MixedPrecision()]\nmodel = EmbUNetModel(in_channels=1, out_channels=1, nfs=(32,64,128,256), num_layers=2)\nlearn = Learner(model, dls, nn.MSELoss(), lr=lr, cbs=cbs, opt_func=opt_func)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[42], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> lr <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">1e-2</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> epochs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">25</span>\n<span class=\"ansi-green-fg\">----&gt; 3</span> opt_func <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">partial</span>(optim<span style=\"color:rgb(98,98,98)\">.</span>Adam, eps<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1e-5</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> tmax <span style=\"color:rgb(98,98,98)\">=</span> epochs <span style=\"color:rgb(98,98,98)\">*</span> <span style=\"color:rgb(0,135,0)\">len</span>(dls<span style=\"color:rgb(98,98,98)\">.</span>train)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> sched <span style=\"color:rgb(98,98,98)\">=</span> partial(lr_scheduler<span style=\"color:rgb(98,98,98)\">.</span>OneCycleLR, max_lr<span style=\"color:rgb(98,98,98)\">=</span>lr, total_steps<span style=\"color:rgb(98,98,98)\">=</span>tmax)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'partial' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f9f02026 .cell execution_count=43}\n``` {.python .cell-code}\nlearn.fit(epochs)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[43], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">learn</span><span style=\"color:rgb(98,98,98)\">.</span>fit(epochs)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'learn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Sampling\n\n::: {#b6a3f57c .cell execution_count=44}\n``` {.python .cell-code}\nfrom miniai.fid import ImageEval\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[44], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">miniai</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">fid</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> ImageEval\n\nFile <span class=\"ansi-green-fg\">~/work/blog/notes/deeplearning_for_coders_p2/miniai/fid.py:8</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># %% ../nbs/18_fid.ipynb 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      7</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pickle</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">gzip</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">math</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">os</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">time</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">shutil</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">random</span>\n<span class=\"ansi-green-fg\">----&gt; 8</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fastcore</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">all</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fc</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">mpl</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">numpy</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">np</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">pyplot</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">plt</span>\n<span class=\"ansi-green-fg ansi-bold\">      9</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">collections</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">abc</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> Mapping\n<span class=\"ansi-green-fg ansi-bold\">     10</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pathlib</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> Path\n\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>: No module named 'fastcore'</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#875fdac4 .cell execution_count=45}\n``` {.python .cell-code}\ncmodel = torch.load('models/data_aug2.pkl')\ndel(cmodel[8])\ndel(cmodel[7])\n\nbs = 2048\ntds2 = dsd.with_transform(transformi)\ndls2 = DataLoaders.from_dd(tds, bs, num_workers=fc.defaults.cpus)\n\ndt = dls2.train\nxb,yb = next(iter(dt))\n\nie = ImageEval(cmodel, dls2, cbs=[DeviceCB()])\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[45], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> cmodel <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>load(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">models/data_aug2.pkl</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">del</span>(cmodel[<span style=\"color:rgb(98,98,98)\">8</span>])\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">del</span>(cmodel[<span style=\"color:rgb(98,98,98)\">7</span>])\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#840f02b4 .cell execution_count=46}\n``` {.python .cell-code}\nsz = (512,1,32,32)\n```\n:::\n\n\n::: {#8b9fb020 .cell execution_count=47}\n``` {.python .cell-code}\nsz = (2048,1,32,32)\n```\n:::\n\n\n::: {#aafe3e2b .cell execution_count=48}\n``` {.python .cell-code}\ndef sigmas_karras(n, sigma_min=0.01, sigma_max=80., rho=7.):\n    ramp = torch.linspace(0, 1, n)\n    min_inv_rho = sigma_min**(1/rho)\n    max_inv_rho = sigma_max**(1/rho)\n    sigmas = (max_inv_rho + ramp * (min_inv_rho-max_inv_rho))**rho\n    return torch.cat([sigmas, tensor([0.])]).cuda()\n\ndef denoise(model, x, sig):\n    sig = sig[None] #* torch.ones((len(x),1), device=x.device)\n    c_skip,c_out,c_in = scalings(sig)\n    return model((x*c_in, sig))*c_out + x*c_skip\n```\n:::\n\n\n::: {#99691f92 .cell execution_count=49}\n``` {.python .cell-code}\ndef get_ancestral_step(sigma_from, sigma_to, eta=1.):\n    if not eta: return sigma_to, 0.\n    var_to,var_from = sigma_to**2,sigma_from**2\n    sigma_up = min(sigma_to, eta * (var_to * (var_from-var_to)/var_from)**0.5)\n    return (var_to-sigma_up**2)**0.5, sigma_up\n\n@torch.no_grad()\ndef sample_euler_ancestral(x, sigs, i, model, eta=1.):\n    sig,sig2 = sigs[i],sigs[i+1]\n    denoised = denoise(model, x, sig)\n    sigma_down,sigma_up = get_ancestral_step(sig, sig2, eta=eta)\n    x = x + (x-denoised)/sig*(sigma_down-sig)\n    return x + torch.randn_like(x)*sigma_up\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[49], line 7</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     sigma_up <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">min</span>(sigma_to, eta <span style=\"color:rgb(98,98,98)\">*</span> (var_to <span style=\"color:rgb(98,98,98)\">*</span> (var_from<span style=\"color:rgb(98,98,98)\">-</span>var_to)<span style=\"color:rgb(98,98,98)\">/</span>var_from)<span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">0.5</span>)\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> (var_to<span style=\"color:rgb(98,98,98)\">-</span>sigma_up<span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">2</span>)<span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">0.5</span>, sigma_up\n<span class=\"ansi-green-fg\">----&gt; 7</span> <span style=\"color:rgb(175,0,255)\">@torch</span><span style=\"color:rgb(98,98,98)\">.</span>no_grad()\n<span class=\"ansi-green-fg ansi-bold\">      8</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">sample_euler_ancestral</span>(x, sigs, i, model, eta<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1.</span>):\n<span class=\"ansi-green-fg ansi-bold\">      9</span>     sig,sig2 <span style=\"color:rgb(98,98,98)\">=</span> sigs[i],sigs[i<span style=\"color:rgb(98,98,98)\">+</span><span style=\"color:rgb(98,98,98)\">1</span>]\n<span class=\"ansi-green-fg ansi-bold\">     10</span>     denoised <span style=\"color:rgb(98,98,98)\">=</span> denoise(model, x, sig)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#da99615a .cell execution_count=50}\n``` {.python .cell-code}\n@torch.no_grad()\ndef sample_euler(x, sigs, i, model):\n    sig,sig2 = sigs[i],sigs[i+1]\n    denoised = denoise(model, x, sig)\n    return x + (x-denoised)/sig*(sig2-sig)\n\n@torch.no_grad()\ndef sample_heun(x, sigs, i, model, s_churn=0., s_tmin=0., s_tmax=float('inf'), s_noise=1.):\n    sig,sig2 = sigs[i],sigs[i+1]\n    n = len(sigs)\n    gamma = min(s_churn/(n-1), 2**0.5-1) if s_tmin<=sig<=s_tmax else 0.\n    eps = torch.randn_like(x) * s_noise\n    sigma_hat = sig * (gamma+1)\n    if gamma > 0: x = x + eps * (sigma_hat**2-sig**2)**0.5\n    denoised = denoise(model, x, sig)\n    d = (x-denoised)/sig\n    dt = sig2-sigma_hat\n    x_2 = x + d*dt\n    if sig2==0: return x_2\n    denoised_2 = denoise(model, x_2, sig2)\n    d_2 = (x_2-denoised_2)/sig2\n    d_prime = (d+d_2)/2\n    return x + d_prime*dt\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[50], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(175,0,255)\">@torch</span><span style=\"color:rgb(98,98,98)\">.</span>no_grad()\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">sample_euler</span>(x, sigs, i, model):\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     sig,sig2 <span style=\"color:rgb(98,98,98)\">=</span> sigs[i],sigs[i<span style=\"color:rgb(98,98,98)\">+</span><span style=\"color:rgb(98,98,98)\">1</span>]\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     denoised <span style=\"color:rgb(98,98,98)\">=</span> denoise(model, x, sig)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8afa79f1 .cell execution_count=51}\n``` {.python .cell-code}\ndef sample(sampler, model, steps=100, sigma_max=80., **kwargs):\n    preds = []\n    x = torch.randn(sz).cuda()*sigma_max\n    sigs = sigmas_karras(steps, sigma_max=sigma_max)\n    for i in progress_bar(range(len(sigs)-1)):\n        x = sampler(x, sigs, i, model, **kwargs)\n        preds.append(x)\n    return preds\n```\n:::\n\n\n::: {#11694dfb .cell execution_count=52}\n``` {.python .cell-code}\npreds = sample_lms(model, steps=20, order=3)\n# preds = sample(sample_euler_ancestral, model, steps=100, eta=1.)\n# preds = sample(sample_euler, model, steps=100)\n# preds = sample(sample_heun, model, steps=20, s_churn=0.5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[52], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> preds <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">sample_lms</span>(model, steps<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">20</span>, order<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># preds = sample(sample_euler_ancestral, model, steps=100, eta=1.)</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># preds = sample(sample_euler, model, steps=100)</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># preds = sample(sample_heun, model, steps=20, s_churn=0.5)</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_lms' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#364bae47 .cell execution_count=53}\n``` {.python .cell-code}\ns = preds[-1]\ns.min(),s.max()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[53], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> s <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">preds</span>[<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> s<span style=\"color:rgb(98,98,98)\">.</span>min(),s<span style=\"color:rgb(98,98,98)\">.</span>max()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'preds' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4224d207 .cell execution_count=54}\n``` {.python .cell-code}\nshow_images(s[:25].clamp(-1,1), imsize=1.5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[54], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_images</span>(s[:<span style=\"color:rgb(98,98,98)\">25</span>]<span style=\"color:rgb(98,98,98)\">.</span>clamp(<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">1</span>), imsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1.5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_images' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#348b4ac3 .cell execution_count=55}\n``` {.python .cell-code}\n# lms 20\nie.fid(s),ie.kid(s),s.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[55], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># lms 20</span>\n<span class=\"ansi-green-fg\">----&gt; 2</span> <span class=\"ansi-yellow-bg\">ie</span><span style=\"color:rgb(98,98,98)\">.</span>fid(s),ie<span style=\"color:rgb(98,98,98)\">.</span>kid(s),s<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'ie' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b672b828 .cell execution_count=56}\n``` {.python .cell-code}\npreds = sample_lms(model, steps=20, order=3)\ns = preds[-1]\nie.fid(s),ie.kid(s),s.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[56], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> preds <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">sample_lms</span>(model, steps<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">20</span>, order<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> s <span style=\"color:rgb(98,98,98)\">=</span> preds[<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>]\n<span class=\"ansi-green-fg ansi-bold\">      3</span> ie<span style=\"color:rgb(98,98,98)\">.</span>fid(s),ie<span style=\"color:rgb(98,98,98)\">.</span>kid(s),s<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_lms' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#0f9d0d83 .cell execution_count=57}\n``` {.python .cell-code}\npreds = sample_lms(model, steps=20, order=3)\ns = preds[-1]\nie.fid(s),ie.kid(s),s.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[57], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> preds <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">sample_lms</span>(model, steps<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">20</span>, order<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> s <span style=\"color:rgb(98,98,98)\">=</span> preds[<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>]\n<span class=\"ansi-green-fg ansi-bold\">      3</span> ie<span style=\"color:rgb(98,98,98)\">.</span>fid(s),ie<span style=\"color:rgb(98,98,98)\">.</span>kid(s),s<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_lms' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8a551f21 .cell execution_count=58}\n``` {.python .cell-code}\nfrom scipy import integrate\n```\n:::\n\n\n::: {#5ea2b3fd .cell execution_count=59}\n``` {.python .cell-code}\ndef linear_multistep_coeff(order, t, i, j):\n    if order-1 > i: raise ValueError(f'Order {order} too high for step {i}')\n    def fn(tau):\n        prod = 1.\n        for k in range(order):\n            if j == k: continue\n            prod *= (tau-t[i-k]) / (t[i-j]-t[i-k])\n        return prod\n    return integrate.quad(fn, t[i], t[i+1], epsrel=1e-4)[0]\n\n@torch.no_grad()\ndef sample_lms(model, steps=100, order=4, sigma_max=80.):\n    preds = []\n    x = torch.randn(sz).cuda()*sigma_max\n    sigs = sigmas_karras(steps, sigma_max=sigma_max)\n    ds = []\n    for i in progress_bar(range(len(sigs)-1)):\n        sig = sigs[i]\n        denoised = denoise(model, x, sig)\n        d = (x-denoised)/sig\n        ds.append(d)\n        if len(ds) > order: ds.pop(0)\n        cur_order = min(i+1, order)\n        coeffs = [linear_multistep_coeff(cur_order, sigs, i, j) for j in range(cur_order)]\n        x = x + sum(coeff*d for coeff, d in zip(coeffs, reversed(ds)))\n        preds.append(x)\n    return preds\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[59], line 11</span>\n<span class=\"ansi-green-fg ansi-bold\">      8</span>         <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> prod\n<span class=\"ansi-green-fg ansi-bold\">      9</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> integrate<span style=\"color:rgb(98,98,98)\">.</span>quad(fn, t[i], t[i<span style=\"color:rgb(98,98,98)\">+</span><span style=\"color:rgb(98,98,98)\">1</span>], epsrel<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1e-4</span>)[<span style=\"color:rgb(98,98,98)\">0</span>]\n<span class=\"ansi-green-fg\">---&gt; 11</span> <span style=\"color:rgb(175,0,255)\">@torch</span><span style=\"color:rgb(98,98,98)\">.</span>no_grad()\n<span class=\"ansi-green-fg ansi-bold\">     12</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">sample_lms</span>(model, steps<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">100</span>, order<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">4</span>, sigma_max<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">80.</span>):\n<span class=\"ansi-green-fg ansi-bold\">     13</span>     preds <span style=\"color:rgb(98,98,98)\">=</span> []\n<span class=\"ansi-green-fg ansi-bold\">     14</span>     x <span style=\"color:rgb(98,98,98)\">=</span> torch<span style=\"color:rgb(98,98,98)\">.</span>randn(sz)<span style=\"color:rgb(98,98,98)\">.</span>cuda()<span style=\"color:rgb(98,98,98)\">*</span>sigma_max\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n",
    "supporting": [
      "26_diffusion_unet_files"
    ],
    "filters": [],
    "includes": {}
  }
}