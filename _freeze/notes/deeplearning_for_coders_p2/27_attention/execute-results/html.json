{
  "hash": "ea3cdf995d6f095270b52a6dc31ba466",
  "result": {
    "engine": "jupyter",
    "markdown": "---\njupyter: python3\n---\n\n::: {#333a3ff2 .cell execution_count=1}\n``` {.python .cell-code}\nimport math,torch\nfrom torch import nn\nfrom miniai.activations import *\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[1], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">math</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> nn\n<span class=\"ansi-green-fg\">----&gt; 3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">miniai</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">activations</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>\n\nFile <span class=\"ansi-green-fg\">~/work/blog/notes/deeplearning_for_coders_p2/miniai/activations.py:6</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">__future__</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> annotations\n<span class=\"ansi-green-fg ansi-bold\">      5</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">random</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">math</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">numpy</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">np</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">pyplot</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">plt</span>\n<span class=\"ansi-green-fg\">----&gt; 6</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fastcore</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">all</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fc</span>\n<span class=\"ansi-green-fg ansi-bold\">      7</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">functools</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> partial\n<span class=\"ansi-green-fg ansi-bold\">      9</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">datasets</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>\n\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>: No module named 'fastcore'</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#05e1e4a1 .cell execution_count=2}\n``` {.python .cell-code}\nimport matplotlib.pyplot as plt\n```\n:::\n\n\n::: {#dc6bb850 .cell execution_count=3}\n``` {.python .cell-code}\nfrom diffusers.models.attention import AttentionBlock\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[3], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">diffusers</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">models</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">attention</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> AttentionBlock\n\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>: No module named 'diffusers'</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4d1a407b .cell execution_count=4}\n``` {.python .cell-code}\nset_seed(42)\nx = torch.randn(64,32,16,16)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[4], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">set_seed</span>(<span style=\"color:rgb(98,98,98)\">42</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> x <span style=\"color:rgb(98,98,98)\">=</span> torch<span style=\"color:rgb(98,98,98)\">.</span>randn(<span style=\"color:rgb(98,98,98)\">64</span>,<span style=\"color:rgb(98,98,98)\">32</span>,<span style=\"color:rgb(98,98,98)\">16</span>,<span style=\"color:rgb(98,98,98)\">16</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'set_seed' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#719d87b2 .cell execution_count=5}\n``` {.python .cell-code}\nt = x.view(*x.shape[:2], -1).transpose(1, 2)\nt.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[5], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> t <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">x</span><span style=\"color:rgb(98,98,98)\">.</span>view(<span style=\"color:rgb(98,98,98)\">*</span>x<span style=\"color:rgb(98,98,98)\">.</span>shape[:<span style=\"color:rgb(98,98,98)\">2</span>], <span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>)<span style=\"color:rgb(98,98,98)\">.</span>transpose(<span style=\"color:rgb(98,98,98)\">1</span>, <span style=\"color:rgb(98,98,98)\">2</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> t<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#651a2afe .cell execution_count=6}\n``` {.python .cell-code}\nni = 32\n```\n:::\n\n\n::: {#a4148e35 .cell execution_count=7}\n``` {.python .cell-code}\nsk = nn.Linear(ni, ni)\nsq = nn.Linear(ni, ni)\nsv = nn.Linear(ni, ni)\n```\n:::\n\n\n::: {#215730d4 .cell execution_count=8}\n``` {.python .cell-code}\nk = sk(t)\nq = sq(t)\nv = sv(t)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[8], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> k <span style=\"color:rgb(98,98,98)\">=</span> sk(<span class=\"ansi-yellow-bg\">t</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> q <span style=\"color:rgb(98,98,98)\">=</span> sq(t)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> v <span style=\"color:rgb(98,98,98)\">=</span> sv(t)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 't' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#68d6ccb6 .cell execution_count=9}\n``` {.python .cell-code}\n(q@k.transpose(1,2)).shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[9], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> (<span class=\"ansi-yellow-bg\">q</span><span style=\"color:rgb(175,0,255)\">@k</span><span style=\"color:rgb(98,98,98)\">.</span>transpose(<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">2</span>))<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'q' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#6b5756a8 .cell execution_count=10}\n``` {.python .cell-code}\nclass SelfAttention(nn.Module):\n    def __init__(self, ni):\n        super().__init__()\n        self.scale = math.sqrt(ni)\n        self.norm = nn.GroupNorm(1, ni)\n        self.q = nn.Linear(ni, ni)\n        self.k = nn.Linear(ni, ni)\n        self.v = nn.Linear(ni, ni)\n        self.proj = nn.Linear(ni, ni)\n    \n    def forward(self, x):\n        inp = x\n        n,c,h,w = x.shape\n        x = self.norm(x)\n        x = x.view(n, c, -1).transpose(1, 2)\n        q = self.q(x)\n        k = self.k(x)\n        v = self.v(x)\n        s = (q@k.transpose(1,2))/self.scale\n        x = s.softmax(dim=-1)@v\n        x = self.proj(x)\n        x = x.transpose(1,2).reshape(n,c,h,w)\n        return x+inp\n```\n:::\n\n\n::: {#096416cb .cell execution_count=11}\n``` {.python .cell-code}\nsa = SelfAttention(32)\n```\n:::\n\n\n::: {#1c7cb9e7 .cell execution_count=12}\n``` {.python .cell-code}\nra = sa(x)\nra.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[12], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> ra <span style=\"color:rgb(98,98,98)\">=</span> sa(<span class=\"ansi-yellow-bg\">x</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> ra<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#09b83ca4 .cell execution_count=13}\n``` {.python .cell-code}\nra[0,0,0]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[13], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">ra</span>[<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">0</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'ra' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2d652900 .cell execution_count=14}\n``` {.python .cell-code}\ndef cp_parms(a,b):\n    b.weight = a.weight\n    b.bias = a.bias\n```\n:::\n\n\n::: {#868ffd54 .cell execution_count=15}\n``` {.python .cell-code}\nat = AttentionBlock(32, norm_num_groups=1)\nsrc = sa.q,sa.k,sa.v,sa.proj,sa.norm\ndst = at.query,at.key,at.value,at.proj_attn,at.group_norm\nfor s,d in zip(src,dst): cp_parms(s,d)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[15], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> at <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">AttentionBlock</span>(<span style=\"color:rgb(98,98,98)\">32</span>, norm_num_groups<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> src <span style=\"color:rgb(98,98,98)\">=</span> sa<span style=\"color:rgb(98,98,98)\">.</span>q,sa<span style=\"color:rgb(98,98,98)\">.</span>k,sa<span style=\"color:rgb(98,98,98)\">.</span>v,sa<span style=\"color:rgb(98,98,98)\">.</span>proj,sa<span style=\"color:rgb(98,98,98)\">.</span>norm\n<span class=\"ansi-green-fg ansi-bold\">      3</span> dst <span style=\"color:rgb(98,98,98)\">=</span> at<span style=\"color:rgb(98,98,98)\">.</span>query,at<span style=\"color:rgb(98,98,98)\">.</span>key,at<span style=\"color:rgb(98,98,98)\">.</span>value,at<span style=\"color:rgb(98,98,98)\">.</span>proj_attn,at<span style=\"color:rgb(98,98,98)\">.</span>group_norm\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'AttentionBlock' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#9e4576fd .cell execution_count=16}\n``` {.python .cell-code}\nrb = at(x)\nrb[0,0,0]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[16], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> rb <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">at</span>(x)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> rb[<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">0</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'at' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#46c6f9d1 .cell execution_count=17}\n``` {.python .cell-code}\nsqkv = nn.Linear(ni, ni*3)\nst = sqkv(t)\nst.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[17], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> sqkv <span style=\"color:rgb(98,98,98)\">=</span> nn<span style=\"color:rgb(98,98,98)\">.</span>Linear(ni, ni<span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">3</span>)\n<span class=\"ansi-green-fg\">----&gt; 2</span> st <span style=\"color:rgb(98,98,98)\">=</span> sqkv(<span class=\"ansi-yellow-bg\">t</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> st<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 't' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#11136600 .cell execution_count=18}\n``` {.python .cell-code}\nq,k,v = torch.chunk(st, 3, dim=-1)\nq.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[18], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> q,k,v <span style=\"color:rgb(98,98,98)\">=</span> torch<span style=\"color:rgb(98,98,98)\">.</span>chunk(<span class=\"ansi-yellow-bg\">st</span>, <span style=\"color:rgb(98,98,98)\">3</span>, dim<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> q<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'st' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#300a6878 .cell execution_count=19}\n``` {.python .cell-code}\n(k@q.transpose(1,2)).shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[19], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> (<span class=\"ansi-yellow-bg\">k</span><span style=\"color:rgb(175,0,255)\">@q</span><span style=\"color:rgb(98,98,98)\">.</span>transpose(<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">2</span>))<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'k' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#90b779ce .cell execution_count=20}\n``` {.python .cell-code}\nclass SelfAttention(nn.Module):\n    def __init__(self, ni):\n        super().__init__()\n        self.scale = math.sqrt(ni)\n        self.norm = nn.BatchNorm2d(ni)\n        self.qkv = nn.Linear(ni, ni*3)\n        self.proj = nn.Linear(ni, ni)\n    \n    def forward(self, inp):\n        n,c,h,w = inp.shape\n        x = self.norm(inp).view(n, c, -1).transpose(1, 2)\n        q,k,v = torch.chunk(self.qkv(x), 3, dim=-1)\n        s = (q@k.transpose(1,2))/self.scale\n        x = s.softmax(dim=-1)@v\n        x = self.proj(x).transpose(1,2).reshape(n,c,h,w)\n        return x+inp\n```\n:::\n\n\n::: {#14933bea .cell execution_count=21}\n``` {.python .cell-code}\nclass SelfAttention(nn.Module):\n    def __init__(self, ni):\n        super().__init__()\n        self.scale = math.sqrt(ni)\n        self.norm = nn.BatchNorm2d(ni)\n        self.qkv = nn.Linear(ni, ni*3)\n        self.proj = nn.Linear(ni, ni)\n    \n    def forward(self, x):\n        x = self.norm(x).transpose(1, 2)\n        q,k,v = torch.chunk(self.qkv(x), 3, dim=-1)\n        s = (q@k.transpose(1,2))/self.scale\n        x = s.softmax(dim=-1)@v\n        return self.proj(x).transpose(1,2)\n```\n:::\n\n\n::: {#75e94583 .cell execution_count=22}\n``` {.python .cell-code}\nsa = SelfAttention(32)\nsa(x).shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[22], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> sa <span style=\"color:rgb(98,98,98)\">=</span> SelfAttention(<span style=\"color:rgb(98,98,98)\">32</span>)\n<span class=\"ansi-green-fg\">----&gt; 2</span> sa(<span class=\"ansi-yellow-bg\">x</span>)<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b0a64406 .cell execution_count=23}\n``` {.python .cell-code}\nsa(x).std()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[23], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> sa(<span class=\"ansi-yellow-bg\">x</span>)<span style=\"color:rgb(98,98,98)\">.</span>std()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#901e8b03 .cell execution_count=24}\n``` {.python .cell-code}\ndef heads_to_batch(x, heads):\n    n,sl,d = x.shape\n    x = x.reshape(n, sl, heads, -1)\n    return x.transpose(2, 1).reshape(n*heads,sl,-1)\n\ndef batch_to_heads(x, heads):\n    n,sl,d = x.shape\n    x = x.reshape(-1, heads, sl, d)\n    return x.transpose(2, 1).reshape(-1,sl,d*heads)\n```\n:::\n\n\n::: {#3281968f .cell execution_count=25}\n``` {.python .cell-code}\nfrom einops import rearrange\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[25], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">einops</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> rearrange\n\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>: No module named 'einops'</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#83f7d163 .cell execution_count=26}\n``` {.python .cell-code}\nt2 = rearrange(t , 'n s (h d) -> (n h) s d', h=8)\nt.shape, t2.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[26], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> t2 <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">rearrange</span>(t , <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n s (h d) -&gt; (n h) s d</span><span style=\"color:rgb(175,0,0)\">'</span>, h<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">8</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> t<span style=\"color:rgb(98,98,98)\">.</span>shape, t2<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'rearrange' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#455c47a0 .cell execution_count=27}\n``` {.python .cell-code}\nt3 = rearrange(t2, '(n h) s d -> n s (h d)', h=8)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[27], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> t3 <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">rearrange</span>(t2, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">(n h) s d -&gt; n s (h d)</span><span style=\"color:rgb(175,0,0)\">'</span>, h<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">8</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'rearrange' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f5affbca .cell execution_count=28}\n``` {.python .cell-code}\nt2.shape,t3.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[28], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">t2</span><span style=\"color:rgb(98,98,98)\">.</span>shape,t3<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 't2' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ccd31fa0 .cell execution_count=29}\n``` {.python .cell-code}\n(t==t3).all()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[29], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> (<span class=\"ansi-yellow-bg\">t</span><span style=\"color:rgb(98,98,98)\">==</span>t3)<span style=\"color:rgb(98,98,98)\">.</span>all()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 't' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#e98ccd38 .cell execution_count=30}\n``` {.python .cell-code}\nclass SelfAttentionMultiHead(nn.Module):\n    def __init__(self, ni, nheads):\n        super().__init__()\n        self.nheads = nheads\n        self.scale = math.sqrt(ni/nheads)\n        self.norm = nn.BatchNorm2d(ni)\n        self.qkv = nn.Linear(ni, ni*3)\n        self.proj = nn.Linear(ni, ni)\n    \n    def forward(self, inp):\n        n,c,h,w = inp.shape\n        x = self.norm(inp).view(n, c, -1).transpose(1, 2)\n        x = self.qkv(x)\n        x = rearrange(x, 'n s (h d) -> (n h) s d', h=self.nheads)\n        q,k,v = torch.chunk(x, 3, dim=-1)\n        s = (q@k.transpose(1,2))/self.scale\n        x = s.softmax(dim=-1)@v\n        x = rearrange(x, '(n h) s d -> n s (h d)', h=self.nheads)\n        x = self.proj(x).transpose(1,2).reshape(n,c,h,w)\n        return x+inp\n```\n:::\n\n\n::: {#ce8041f8 .cell execution_count=31}\n``` {.python .cell-code}\nsa = SelfAttentionMultiHead(32, 4)\nsx = sa(x)\nsx.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[31], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> sa <span style=\"color:rgb(98,98,98)\">=</span> SelfAttentionMultiHead(<span style=\"color:rgb(98,98,98)\">32</span>, <span style=\"color:rgb(98,98,98)\">4</span>)\n<span class=\"ansi-green-fg\">----&gt; 2</span> sx <span style=\"color:rgb(98,98,98)\">=</span> sa(<span class=\"ansi-yellow-bg\">x</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> sx<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a862a35a .cell execution_count=32}\n``` {.python .cell-code}\nsx.mean(),sx.std()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[32], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">sx</span><span style=\"color:rgb(98,98,98)\">.</span>mean(),sx<span style=\"color:rgb(98,98,98)\">.</span>std()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sx' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a6ba3341 .cell execution_count=33}\n``` {.python .cell-code}\nnm = nn.MultiheadAttention(32, num_heads=8, batch_first=True)\nnmx,nmw = nm(t,t,t)\nnmx = nmx+t\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[33], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> nm <span style=\"color:rgb(98,98,98)\">=</span> nn<span style=\"color:rgb(98,98,98)\">.</span>MultiheadAttention(<span style=\"color:rgb(98,98,98)\">32</span>, num_heads<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">8</span>, batch_first<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>)\n<span class=\"ansi-green-fg\">----&gt; 2</span> nmx,nmw <span style=\"color:rgb(98,98,98)\">=</span> nm(<span class=\"ansi-yellow-bg\">t</span>,t,t)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> nmx <span style=\"color:rgb(98,98,98)\">=</span> nmx<span style=\"color:rgb(98,98,98)\">+</span>t\n\n<span class=\"ansi-red-fg\">NameError</span>: name 't' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2da20af3 .cell execution_count=34}\n``` {.python .cell-code}\nnmx.mean(),nmx.std()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[34], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">nmx</span><span style=\"color:rgb(98,98,98)\">.</span>mean(),nmx<span style=\"color:rgb(98,98,98)\">.</span>std()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nmx' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n",
    "supporting": [
      "27_attention_files"
    ],
    "filters": [],
    "includes": {}
  }
}