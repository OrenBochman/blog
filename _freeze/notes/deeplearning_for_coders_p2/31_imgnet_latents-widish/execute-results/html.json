{
  "hash": "8b9b4fa0202db78dce2db0b1cde17c34",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Full Imagenet\njupyter: python3\n---\n\n::: {#d4a02d4e .cell execution_count=1}\n``` {.python .cell-code}\nimport os\nos.environ['CUDA_VISIBLE_DEVICES']='0'\nos.environ['OMP_NUM_THREADS']='1'\n```\n:::\n\n\n::: {#0772cb36 .cell execution_count=2}\n``` {.python .cell-code}\nimport pickle,gzip\n\nfrom glob import glob\nfrom torcheval.metrics import MulticlassAccuracy\n\nfrom miniai.imports import *\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[2], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pickle</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">gzip</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">glob</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> glob\n<span class=\"ansi-green-fg\">----&gt; 4</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torcheval</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">metrics</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> MulticlassAccuracy\n<span class=\"ansi-green-fg ansi-bold\">      6</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">miniai</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">imports</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>\n\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>: No module named 'torcheval'</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c3a4ca84 .cell execution_count=3}\n``` {.python .cell-code}\nfrom fastprogress import progress_bar\nfrom diffusers import AutoencoderKL\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>                       Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[3], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fastprogress</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> progress_bar\n<span class=\"ansi-green-fg\">----&gt; 2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">diffusers</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> AutoencoderKL\n\n<span class=\"ansi-red-fg\">ModuleNotFoundError</span>: No module named 'diffusers'</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8260448b .cell execution_count=4}\n``` {.python .cell-code}\ntorch.set_printoptions(precision=5, linewidth=140, sci_mode=False)\ntorch.manual_seed(1)\nmpl.rcParams['figure.dpi'] = 70\n\nset_seed(42)\nif fc.defaults.cpus>8: fc.defaults.cpus=8\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[4], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>set_printoptions(precision<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">5</span>, linewidth<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">140</span>, sci_mode<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> torch<span style=\"color:rgb(98,98,98)\">.</span>manual_seed(<span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> mpl<span style=\"color:rgb(98,98,98)\">.</span>rcParams[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">figure.dpi</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">70</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#21870880 .cell execution_count=5}\n``` {.python .cell-code}\npath_data = Path('data')/'ILSVRC'\npath = path_data/'Data'/'CLS-LOC'\n\ndest = path_data/'latents'\ndest.mkdir(exist_ok=True)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[5], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> path_data <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">Path</span>(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">data</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">ILSVRC</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> path <span style=\"color:rgb(98,98,98)\">=</span> path_data<span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">Data</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">CLS-LOC</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> dest <span style=\"color:rgb(98,98,98)\">=</span> path_data<span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">latents</span><span style=\"color:rgb(175,0,0)\">'</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'Path' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8fd8cafd .cell execution_count=6}\n``` {.python .cell-code}\nvae = AutoencoderKL.from_pretrained(\"stabilityai/sd-vae-ft-ema\").cuda().requires_grad_(False)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[6], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> vae <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">AutoencoderKL</span><span style=\"color:rgb(98,98,98)\">.</span>from_pretrained(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">stabilityai/sd-vae-ft-ema</span><span style=\"color:rgb(175,0,0)\">\"</span>)<span style=\"color:rgb(98,98,98)\">.</span>cuda()<span style=\"color:rgb(98,98,98)\">.</span>requires_grad_(<span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'AutoencoderKL' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#00bb4420 .cell execution_count=7}\n``` {.python .cell-code}\nclass ImagesDS:\n    def __init__(self, path, spec):\n        cache = path/'files.zpkl'\n        if cache.exists():\n            with gzip.open(cache) as f: self.files = pickle.load(f)\n        else:\n            self.files = glob(str(path/spec), recursive=True)\n            with gzip.open(cache, 'wb', compresslevel=1) as f: pickle.dump(self.files, f)\n\n    def __len__(self): return len(self.files)\n\n    def __getitem__(self, i):\n        f = self.files[i]\n        im = read_image(f, mode=ImageReadMode.RGB)/255\n        im = TF.resize(TF.center_crop(im, min(im.shape[1:])), 256)\n        return im,f\n```\n:::\n\n\n::: {#09027457 .cell execution_count=8}\n``` {.python .cell-code}\nds = ImagesDS(path, '**/*.JPEG')\ndl = DataLoader(ds, batch_size=64, num_workers=fc.defaults.cpus)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[8], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> ds <span style=\"color:rgb(98,98,98)\">=</span> ImagesDS(<span class=\"ansi-yellow-bg\">path</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">**/*.JPEG</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> dl <span style=\"color:rgb(98,98,98)\">=</span> DataLoader(ds, batch_size<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">64</span>, num_workers<span style=\"color:rgb(98,98,98)\">=</span>fc<span style=\"color:rgb(98,98,98)\">.</span>defaults<span style=\"color:rgb(98,98,98)\">.</span>cpus)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'path' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c268f36f .cell execution_count=9}\n``` {.python .cell-code}\nxb,yb = next(iter(dl))\nxe = vae.encode(xb.cuda())\nxs = xe.latent_dist.mean\nxs.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[9], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> xb,yb <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">next</span>(<span style=\"color:rgb(0,135,0)\">iter</span>(<span class=\"ansi-yellow-bg\">dl</span>))\n<span class=\"ansi-green-fg ansi-bold\">      2</span> xe <span style=\"color:rgb(98,98,98)\">=</span> vae<span style=\"color:rgb(98,98,98)\">.</span>encode(xb<span style=\"color:rgb(98,98,98)\">.</span>cuda())\n<span class=\"ansi-green-fg ansi-bold\">      3</span> xs <span style=\"color:rgb(98,98,98)\">=</span> xe<span style=\"color:rgb(98,98,98)\">.</span>latent_dist<span style=\"color:rgb(98,98,98)\">.</span>mean\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dl' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4d643d39 .cell execution_count=10}\n``` {.python .cell-code}\nshow_images(((xs[:16,:3])/4).sigmoid(), imsize=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[10], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_images</span>(((xs[:<span style=\"color:rgb(98,98,98)\">16</span>,:<span style=\"color:rgb(98,98,98)\">3</span>])<span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(98,98,98)\">4</span>)<span style=\"color:rgb(98,98,98)\">.</span>sigmoid(), imsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_images' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#7bead99b .cell execution_count=11}\n``` {.python .cell-code}\nxd = to_cpu(vae.decode(xs))\nshow_images(xd['sample'][:16].clamp(0,1), imsize=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[11], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> xd <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">to_cpu</span>(vae<span style=\"color:rgb(98,98,98)\">.</span>decode(xs))\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_images(xd[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">sample</span><span style=\"color:rgb(175,0,0)\">'</span>][:<span style=\"color:rgb(98,98,98)\">16</span>]<span style=\"color:rgb(98,98,98)\">.</span>clamp(<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">1</span>), imsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'to_cpu' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#9f0c5865 .cell execution_count=12}\n``` {.python .cell-code}\nif not dest.exists():\n    dest.mkdir()\n    for xb,yb in progress_bar(dl):\n        eb = to_cpu(vae.encode(xb.cuda()).latent_dist.mean).numpy()\n        for ebi,ybi in zip(eb,yb):\n            ybi = dest/Path(ybi).relative_to(path).with_suffix('')\n            (ybi.parent).mkdir(parents=True, exist_ok=True)\n            np.save(ybi, ebi)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[12], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span class=\"ansi-yellow-bg\">dest</span><span style=\"color:rgb(98,98,98)\">.</span>exists():\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     dest<span style=\"color:rgb(98,98,98)\">.</span>mkdir()\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> xb,yb <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> progress_bar(dl):\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dest' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#e54b2915 .cell execution_count=13}\n``` {.python .cell-code}\nclass NumpyDS(ImagesDS):\n    def __getitem__(self, i):\n        f = self.files[i]\n        im = np.load(f)\n        return im,f\n```\n:::\n\n\n::: {#ab461fa5 .cell execution_count=14}\n``` {.python .cell-code}\nbs = 128\n```\n:::\n\n\n::: {#6de209eb .cell execution_count=15}\n``` {.python .cell-code}\ntds = NumpyDS(dest/'train', '**/*.npy')\nvds = NumpyDS(dest/'val', '**/*.npy')\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[15], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> tds <span style=\"color:rgb(98,98,98)\">=</span> NumpyDS(<span class=\"ansi-yellow-bg\">dest</span><span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">train</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">**/*.npy</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> vds <span style=\"color:rgb(98,98,98)\">=</span> NumpyDS(dest<span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">val</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">**/*.npy</span><span style=\"color:rgb(175,0,0)\">'</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dest' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#54c71c87 .cell execution_count=16}\n``` {.python .cell-code}\ntdl = DataLoader(tds, batch_size=bs, num_workers=0)\nxb,yb = next(iter(tdl))\nxb.mean((0,2,3)),xb.std((0,2,3))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[16], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> tdl <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">DataLoader</span>(tds, batch_size<span style=\"color:rgb(98,98,98)\">=</span>bs, num_workers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">0</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> xb,yb <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">next</span>(<span style=\"color:rgb(0,135,0)\">iter</span>(tdl))\n<span class=\"ansi-green-fg ansi-bold\">      3</span> xb<span style=\"color:rgb(98,98,98)\">.</span>mean((<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">2</span>,<span style=\"color:rgb(98,98,98)\">3</span>)),xb<span style=\"color:rgb(98,98,98)\">.</span>std((<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">2</span>,<span style=\"color:rgb(98,98,98)\">3</span>))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'DataLoader' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2a287e24 .cell execution_count=17}\n``` {.python .cell-code}\nxmean,xstd = (tensor([ 5.37007,  2.65468,  0.44876, -2.39154]),\n tensor([3.99512, 4.44317, 3.21629, 3.10339]))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[17], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> xmean,xstd <span style=\"color:rgb(98,98,98)\">=</span> (<span class=\"ansi-yellow-bg\">tensor</span>([ <span style=\"color:rgb(98,98,98)\">5.37007</span>,  <span style=\"color:rgb(98,98,98)\">2.65468</span>,  <span style=\"color:rgb(98,98,98)\">0.44876</span>, <span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">2.39154</span>]),\n<span class=\"ansi-green-fg ansi-bold\">      2</span>  tensor([<span style=\"color:rgb(98,98,98)\">3.99512</span>, <span style=\"color:rgb(98,98,98)\">4.44317</span>, <span style=\"color:rgb(98,98,98)\">3.21629</span>, <span style=\"color:rgb(98,98,98)\">3.10339</span>]))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tensor' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d69f2f59 .cell execution_count=18}\n``` {.python .cell-code}\nclass TfmDS:\n    def __init__(self, ds, tfmx=fc.noop, tfmy=fc.noop): self.ds,self.tfmx,self.tfmy = ds,tfmx,tfmy\n    def __len__(self): return len(self.ds)\n    def __getitem__(self, i):\n        x,y = self.ds[i]\n        return self.tfmx(x),self.tfmy(y)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[18], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">TfmDS</span>:\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>(<span style=\"color:rgb(0,135,0)\">self</span>, ds, tfmx<span style=\"color:rgb(98,98,98)\">=</span>fc<span style=\"color:rgb(98,98,98)\">.</span>noop, tfmy<span style=\"color:rgb(98,98,98)\">=</span>fc<span style=\"color:rgb(98,98,98)\">.</span>noop): <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>ds,<span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>tfmx,<span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>tfmy <span style=\"color:rgb(98,98,98)\">=</span> ds,tfmx,tfmy\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__len__</span>(<span style=\"color:rgb(0,135,0)\">self</span>): <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>ds)\n\nCell <span class=\"ansi-green-fg\">In[18], line 2</span>, in <span class=\"ansi-cyan-fg\">TfmDS</span><span class=\"ansi-blue-fg\">()</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">class</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">TfmDS</span>:\n<span class=\"ansi-green-fg\">----&gt; 2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__init__</span>(<span style=\"color:rgb(0,135,0)\">self</span>, ds, tfmx<span style=\"color:rgb(98,98,98)\">=</span><span class=\"ansi-yellow-bg\">fc</span><span style=\"color:rgb(98,98,98)\">.</span>noop, tfmy<span style=\"color:rgb(98,98,98)\">=</span>fc<span style=\"color:rgb(98,98,98)\">.</span>noop): <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>ds,<span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>tfmx,<span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>tfmy <span style=\"color:rgb(98,98,98)\">=</span> ds,tfmx,tfmy\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__len__</span>(<span style=\"color:rgb(0,135,0)\">self</span>): <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>ds)\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">__getitem__</span>(<span style=\"color:rgb(0,135,0)\">self</span>, i):\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'fc' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8ddd8d84 .cell execution_count=19}\n``` {.python .cell-code}\nid2str = (path_data/'imagenet_lsvrc_2015_synsets.txt').read_text().splitlines()\nstr2id = {v:k for k,v in enumerate(id2str)}\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[19], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> id2str <span style=\"color:rgb(98,98,98)\">=</span> (<span class=\"ansi-yellow-bg\">path_data</span><span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">imagenet_lsvrc_2015_synsets.txt</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>read_text()<span style=\"color:rgb(98,98,98)\">.</span>splitlines()\n<span class=\"ansi-green-fg ansi-bold\">      2</span> str2id <span style=\"color:rgb(98,98,98)\">=</span> {v:k <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> k,v <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span style=\"color:rgb(0,135,0)\">enumerate</span>(id2str)}\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'path_data' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c59842bf .cell execution_count=20}\n``` {.python .cell-code}\naug_tfms = nn.Sequential(T.Pad(2), T.RandomCrop(32), RandErase())\nnorm_tfm = T.Normalize(xmean, xstd)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[20], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> aug_tfms <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Sequential(T<span style=\"color:rgb(98,98,98)\">.</span>Pad(<span style=\"color:rgb(98,98,98)\">2</span>), T<span style=\"color:rgb(98,98,98)\">.</span>RandomCrop(<span style=\"color:rgb(98,98,98)\">32</span>), RandErase())\n<span class=\"ansi-green-fg ansi-bold\">      2</span> norm_tfm <span style=\"color:rgb(98,98,98)\">=</span> T<span style=\"color:rgb(98,98,98)\">.</span>Normalize(xmean, xstd)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#015036fc .cell execution_count=21}\n``` {.python .cell-code}\ndef tfmx(x, aug=False):\n    x = norm_tfm(tensor(x))\n    if aug: x = aug_tfms(x[None])[0]\n    return x\n\ndef tfmy(y): return tensor(str2id[Path(y).parent.name])\n\ntfm_tds = TfmDS(tds, partial(tfmx, aug=True), tfmy)\ntfm_vds = TfmDS(vds, tfmx, tfmy)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[21], line 8</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> x\n<span class=\"ansi-green-fg ansi-bold\">      6</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">tfmy</span>(y): <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> tensor(str2id[Path(y)<span style=\"color:rgb(98,98,98)\">.</span>parent<span style=\"color:rgb(98,98,98)\">.</span>name])\n<span class=\"ansi-green-fg\">----&gt; 8</span> tfm_tds <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">TfmDS</span>(tds, partial(tfmx, aug<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>), tfmy)\n<span class=\"ansi-green-fg ansi-bold\">      9</span> tfm_vds <span style=\"color:rgb(98,98,98)\">=</span> TfmDS(vds, tfmx, tfmy)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'TfmDS' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#fd7d35a9 .cell execution_count=22}\n``` {.python .cell-code}\ndef denorm(x): return (x*xstd[:,None,None]+xmean[:,None,None])\n```\n:::\n\n\n::: {#27c8a917 .cell execution_count=23}\n``` {.python .cell-code}\ndls = DataLoaders(*get_dls(tfm_tds, tfm_vds, bs=bs, num_workers=8))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[23], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> dls <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">DataLoaders</span>(<span style=\"color:rgb(98,98,98)\">*</span>get_dls(tfm_tds, tfm_vds, bs<span style=\"color:rgb(98,98,98)\">=</span>bs, num_workers<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">8</span>))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'DataLoaders' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2467edf9 .cell execution_count=24}\n``` {.python .cell-code}\nall_synsets = [o.split('\\t') for o in (path_data/'words.txt').read_text().splitlines()]\nsynsets = {k:v.split(',', maxsplit=1)[0] for k,v in all_synsets if k in id2str}\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[24], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> all_synsets <span style=\"color:rgb(98,98,98)\">=</span> [o<span style=\"color:rgb(98,98,98)\">.</span>split(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"font-weight:bold;color:rgb(175,95,0)\">\\t</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> o <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> (<span class=\"ansi-yellow-bg\">path_data</span><span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">words.txt</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>read_text()<span style=\"color:rgb(98,98,98)\">.</span>splitlines()]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> synsets <span style=\"color:rgb(98,98,98)\">=</span> {k:v<span style=\"color:rgb(98,98,98)\">.</span>split(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">,</span><span style=\"color:rgb(175,0,0)\">'</span>, maxsplit<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>)[<span style=\"color:rgb(98,98,98)\">0</span>] <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> k,v <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> all_synsets <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> k <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> id2str}\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'path_data' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#5a322248 .cell execution_count=25}\n``` {.python .cell-code}\nxb,yb = next(iter(dls.train))\ntitles = [synsets[id2str[o]] for o in yb]\nxb.mean(),xb.std()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[25], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> xb,yb <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">next</span>(<span style=\"color:rgb(0,135,0)\">iter</span>(<span class=\"ansi-yellow-bg\">dls</span><span style=\"color:rgb(98,98,98)\">.</span>train))\n<span class=\"ansi-green-fg ansi-bold\">      2</span> titles <span style=\"color:rgb(98,98,98)\">=</span> [synsets[id2str[o]] <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> o <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> yb]\n<span class=\"ansi-green-fg ansi-bold\">      3</span> xb<span style=\"color:rgb(98,98,98)\">.</span>mean(),xb<span style=\"color:rgb(98,98,98)\">.</span>std()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dls' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#e8006898 .cell execution_count=26}\n``` {.python .cell-code}\nxd = to_cpu(vae.decode(denorm(xb[:9]).cuda()))\nshow_images(xd['sample'].clamp(0,1), imsize=4, titles=titles[:9])\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[26], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> xd <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">to_cpu</span>(vae<span style=\"color:rgb(98,98,98)\">.</span>decode(denorm(xb[:<span style=\"color:rgb(98,98,98)\">9</span>])<span style=\"color:rgb(98,98,98)\">.</span>cuda()))\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_images(xd[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">sample</span><span style=\"color:rgb(175,0,0)\">'</span>]<span style=\"color:rgb(98,98,98)\">.</span>clamp(<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">1</span>), imsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">4</span>, titles<span style=\"color:rgb(98,98,98)\">=</span>titles[:<span style=\"color:rgb(98,98,98)\">9</span>])\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'to_cpu' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4cc2b223 .cell execution_count=27}\n``` {.python .cell-code}\nact_gr = partial(GeneralRelu, leak=0.1, sub=0.4)\niw = partial(init_weights, leaky=0.1)\n\nopt_func = partial(optim.AdamW, eps=1e-5)\nmetrics = MetricsCB(accuracy=MulticlassAccuracy())\ncbs = [DeviceCB(), metrics, ProgressCB(plot=True), MixedPrecision()]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[27], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> act_gr <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">partial</span>(GeneralRelu, leak<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">0.1</span>, sub<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">0.4</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> iw <span style=\"color:rgb(98,98,98)\">=</span> partial(init_weights, leaky<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">0.1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> opt_func <span style=\"color:rgb(98,98,98)\">=</span> partial(optim<span style=\"color:rgb(98,98,98)\">.</span>AdamW, eps<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1e-5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'partial' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c2a07e70 .cell execution_count=28}\n``` {.python .cell-code}\ndef conv(ni, nf, ks=3, stride=1, act=nn.ReLU, norm=None, bias=True):\n    layers = []\n    if norm: layers.append(norm(ni))\n    if act : layers.append(act())\n    layers.append(nn.Conv2d(ni, nf, stride=stride, kernel_size=ks, padding=ks//2, bias=bias))\n    return nn.Sequential(*layers)\n\ndef _conv_block(ni, nf, stride, act=act_gr, norm=None, ks=3):\n    return nn.Sequential(conv(ni, nf, stride=1     , act=act, norm=norm, ks=ks),\n                         conv(nf, nf, stride=stride, act=act, norm=norm, ks=ks))\n\nclass ResBlock(nn.Module):\n    def __init__(self, ni, nf, stride=1, ks=3, act=act_gr, norm=None):\n        super().__init__()\n        self.convs = _conv_block(ni, nf, stride, act=act, ks=ks, norm=norm)\n        self.idconv = fc.noop if ni==nf else conv(ni, nf, ks=1, stride=1, act=None, norm=norm)\n        self.pool = fc.noop if stride==1 else nn.AvgPool2d(2, ceil_mode=True)\n\n    def forward(self, x): return self.convs(x) + self.idconv(self.pool(x))\n\ndef res_blocks(n_bk, ni, nf, stride=1, ks=3, act=act_gr, norm=None):\n    return nn.Sequential(*[\n        ResBlock(ni if i==0 else nf, nf, stride=stride if i==n_bk-1 else 1, ks=ks, act=act, norm=norm)\n        for i in range(n_bk)])\n\ndef get_dropmodel(nfs, nbks, act=act_gr, norm=nn.BatchNorm2d, drop=0.2):\n    layers = [nn.Conv2d(4, nfs[0], 5, padding=2)]\n    layers += [res_blocks(nbks[i], nfs[i], nfs[i+1], act=act, norm=norm, stride=2)\n               for i in range(len(nfs)-1)]\n    layers += [act_gr(), norm(nfs[-1]), nn.AdaptiveAvgPool2d(1), nn.Flatten(), nn.Dropout(drop)]\n    layers += [nn.Linear(nfs[-1], 1000, bias=False), nn.BatchNorm1d(1000)]\n    return nn.Sequential(*layers).apply(iw)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[28], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">conv</span>(ni, nf, ks<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, stride<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>, act<span style=\"color:rgb(98,98,98)\">=</span><span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>ReLU, norm<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>, bias<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>):\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     layers <span style=\"color:rgb(98,98,98)\">=</span> []\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> norm: layers<span style=\"color:rgb(98,98,98)\">.</span>append(norm(ni))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#fc683a9b .cell execution_count=29}\n``` {.python .cell-code}\nepochs = 40\nlr = 1e-2\ntmax = epochs * len(dls.train)\nsched = partial(lr_scheduler.OneCycleLR, max_lr=lr, total_steps=tmax)\nxtra = [BatchSchedCB(sched)]\nmodel = get_dropmodel(nbks=(1,2,4,3), nfs=(32, 64, 128, 512, 1024), drop=0.1)\nlearn = Learner(model, dls, F.cross_entropy, lr=lr, cbs=cbs+xtra, opt_func=opt_func)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[29], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> epochs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">40</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> lr <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">1e-2</span>\n<span class=\"ansi-green-fg\">----&gt; 3</span> tmax <span style=\"color:rgb(98,98,98)\">=</span> epochs <span style=\"color:rgb(98,98,98)\">*</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span class=\"ansi-yellow-bg\">dls</span><span style=\"color:rgb(98,98,98)\">.</span>train)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> sched <span style=\"color:rgb(98,98,98)\">=</span> partial(lr_scheduler<span style=\"color:rgb(98,98,98)\">.</span>OneCycleLR, max_lr<span style=\"color:rgb(98,98,98)\">=</span>lr, total_steps<span style=\"color:rgb(98,98,98)\">=</span>tmax)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> xtra <span style=\"color:rgb(98,98,98)\">=</span> [BatchSchedCB(sched)]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dls' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ba188e0e .cell execution_count=30}\n``` {.python .cell-code}\nlearn.fit(epochs)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[30], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">learn</span><span style=\"color:rgb(98,98,98)\">.</span>fit(epochs)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'learn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a7491f6f .cell execution_count=31}\n``` {.python .cell-code}\ntorch.save(learn.model, 'models/imgnet-latents')\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[31], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>save(learn<span style=\"color:rgb(98,98,98)\">.</span>model, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">models/imgnet-latents</span><span style=\"color:rgb(175,0,0)\">'</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n### fin -\n\n",
    "supporting": [
      "31_imgnet_latents-widish_files"
    ],
    "filters": [],
    "includes": {}
  }
}