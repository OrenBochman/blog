{
  "hash": "5ed61b65fa970e4bd64b9de13c6eafb2",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Convolutions\njupyter:\n  jupytext:\n    split_at_heading: true\n  kernelspec:\n    display_name: Python 3 (ipykernel)\n    language: python\n    name: python3\nimage: cover.png\n---\n\n::: {#e2c399a6 .cell execution_count=1}\n``` {.python .cell-code}\nimport torch\nfrom torch import nn\n\nfrom torch.utils.data import default_collate\nfrom typing import Mapping\n\nfrom miniai.training import *\nfrom miniai.datasets import *\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ImportError</span>                               Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[1], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> nn\n<span class=\"ansi-green-fg ansi-bold\">      4</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">utils</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">data</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> default_collate\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/torch/__init__.py:237</span>\n<span class=\"ansi-green-fg ansi-bold\">    235</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> USE_GLOBAL_DEPS:\n<span class=\"ansi-green-fg ansi-bold\">    236</span>         _load_global_deps()\n<span class=\"ansi-green-fg\">--&gt; 237</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">_C</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>  <span style=\"font-style:italic;color:rgb(95,135,135)\"># noqa: F403</span>\n<span class=\"ansi-green-fg ansi-bold\">    239</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Appease the type checker; ordinarily this binding is inserted by the</span>\n<span class=\"ansi-green-fg ansi-bold\">    240</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># torch._C module initialization code in C</span>\n<span class=\"ansi-green-fg ansi-bold\">    241</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> TYPE_CHECKING:\n\n<span class=\"ansi-red-fg\">ImportError</span>: libcudnn.so.8: cannot open shared object file: No such file or directory</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c431f83f .cell execution_count=2}\n``` {.python .cell-code}\nimport pickle,gzip,math,os,time,shutil,torch,matplotlib as mpl, numpy as np\nimport pandas as pd,matplotlib.pyplot as plt\nfrom pathlib import Path\nfrom torch import tensor\n\nfrom torch.utils.data import DataLoader\nfrom typing import Mapping\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ImportError</span>                               Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[2], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pickle</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">gzip</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">math</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">os</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">time</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">shutil</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">mpl</span><span style=\"color:rgb(98,98,98)\">,</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">numpy</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">np</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pandas</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pd</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">pyplot</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">plt</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pathlib</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> Path\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/torch/__init__.py:237</span>\n<span class=\"ansi-green-fg ansi-bold\">    235</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> USE_GLOBAL_DEPS:\n<span class=\"ansi-green-fg ansi-bold\">    236</span>         _load_global_deps()\n<span class=\"ansi-green-fg\">--&gt; 237</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">_C</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>  <span style=\"font-style:italic;color:rgb(95,135,135)\"># noqa: F403</span>\n<span class=\"ansi-green-fg ansi-bold\">    239</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Appease the type checker; ordinarily this binding is inserted by the</span>\n<span class=\"ansi-green-fg ansi-bold\">    240</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># torch._C module initialization code in C</span>\n<span class=\"ansi-green-fg ansi-bold\">    241</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> TYPE_CHECKING:\n\n<span class=\"ansi-red-fg\">ImportError</span>: libcudnn.so.8: cannot open shared object file: No such file or directory</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d48445a7 .cell execution_count=3}\n``` {.python .cell-code}\nmpl.rcParams['image.cmap'] = 'gray'\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[3], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">mpl</span><span style=\"color:rgb(98,98,98)\">.</span>rcParams[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">image.cmap</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">gray</span><span style=\"color:rgb(175,0,0)\">'</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'mpl' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8fefa08f .cell execution_count=4}\n``` {.python .cell-code}\npath_data = Path('data')\npath_gz = path_data/'mnist.pkl.gz'\nwith gzip.open(path_gz, 'rb') as f: ((x_train, y_train), (x_valid, y_valid), _) = pickle.load(f, encoding='latin-1')\nx_train, y_train, x_valid, y_valid = map(tensor, [x_train, y_train, x_valid, y_valid])\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[4], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> path_data <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">Path</span>(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">data</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> path_gz <span style=\"color:rgb(98,98,98)\">=</span> path_data<span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">mnist.pkl.gz</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">with</span> gzip<span style=\"color:rgb(98,98,98)\">.</span>open(path_gz, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">rb</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> f: ((x_train, y_train), (x_valid, y_valid), _) <span style=\"color:rgb(98,98,98)\">=</span> pickle<span style=\"color:rgb(98,98,98)\">.</span>load(f, encoding<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">latin-1</span><span style=\"color:rgb(175,0,0)\">'</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'Path' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\nIn the context of an image, a feature is a visually distinctive attribute. For example, the number 7 is characterized by a horizontal edge near the top of the digit, and a top-right to bottom-left diagonal edge underneath that.\n\nIt turns out that finding the edges in an image is a very common task in computer vision, and is surprisingly straightforward. To do it, we use a *convolution*. A convolution requires nothing more than multiplication, and addition.\n\n### Understanding the Convolution Equations\n\nTo explain the math behind convolutions, fast.ai student Matt Kleinsmith came up with the very clever idea of showing [CNNs from different viewpoints](https://medium.com/impactai/cnns-from-different-viewpoints-fab7f52d159c).\n\nHere's the input:\n\n<img alt=\"The image\" width=\"75\" src=\"images/att_00032.png\">\n\nHere's our kernel:\n\n<img alt=\"The kernel\" width=\"55\" src=\"images/att_00033.png\">\n\nSince the filter fits in the image four times, we have four results:\n\n<img alt=\"The activations\" width=\"52\" src=\"images/att_00034.png\">\n\n<img alt=\"Applying the kernel\" width=\"366\" caption=\"Applying the kernel\" id=\"apply_kernel\" src=\"images/att_00035.png\">\n\n<img alt=\"The equation\" width=\"436\" caption=\"The equation\" id=\"eq_view\" src=\"images/att_00036.png\">\n\n::: {#bbeeedc0 .cell execution_count=5}\n``` {.python .cell-code}\nx_imgs = x_train.view(-1,28,28)\nxv_imgs = x_valid.view(-1,28,28)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[5], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> x_imgs <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">x_train</span><span style=\"color:rgb(98,98,98)\">.</span>view(<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">28</span>,<span style=\"color:rgb(98,98,98)\">28</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> xv_imgs <span style=\"color:rgb(98,98,98)\">=</span> x_valid<span style=\"color:rgb(98,98,98)\">.</span>view(<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">28</span>,<span style=\"color:rgb(98,98,98)\">28</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x_train' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ac73bd7f .cell execution_count=6}\n``` {.python .cell-code}\nmpl.rcParams['figure.dpi'] = 30\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[6], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">mpl</span><span style=\"color:rgb(98,98,98)\">.</span>rcParams[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">figure.dpi</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">30</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'mpl' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#80c24e18 .cell execution_count=7}\n``` {.python .cell-code}\nim3 = x_imgs[7]\nshow_image(im3);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[7], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> im3 <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">x_imgs</span>[<span style=\"color:rgb(98,98,98)\">7</span>]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_image(im3);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x_imgs' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#173ad26d .cell execution_count=8}\n``` {.python .cell-code}\ntop_edge = tensor([[-1,-1,-1],\n                   [ 0, 0, 0],\n                   [ 1, 1, 1]]).float()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[8], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> top_edge <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">tensor</span>([[<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>],\n<span class=\"ansi-green-fg ansi-bold\">      2</span>                    [ <span style=\"color:rgb(98,98,98)\">0</span>, <span style=\"color:rgb(98,98,98)\">0</span>, <span style=\"color:rgb(98,98,98)\">0</span>],\n<span class=\"ansi-green-fg ansi-bold\">      3</span>                    [ <span style=\"color:rgb(98,98,98)\">1</span>, <span style=\"color:rgb(98,98,98)\">1</span>, <span style=\"color:rgb(98,98,98)\">1</span>]])<span style=\"color:rgb(98,98,98)\">.</span>float()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tensor' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\nWe're going to call this our kernel (because that's what fancy computer vision researchers call these).\n\n::: {#cb5aa79f .cell execution_count=9}\n``` {.python .cell-code}\nshow_image(top_edge, noframe=False);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[9], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_image</span>(top_edge, noframe<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\nThe filter will take any window of size 3×3 in our images, and if we name the pixel values like this:\n\n$$\\begin{matrix} a1 & a2 & a3 \\\\ a4 & a5 & a6 \\\\ a7 & a8 & a9 \\end{matrix}$$\n\nit will return $-a1-a2-a3+a7+a8+a9$.\n\n::: {#399c28ef .cell execution_count=10}\n``` {.python .cell-code}\ndf = pd.DataFrame(im3[:13,:23])\ndf.style.format(precision=2).set_properties(**{'font-size':'7pt'}).background_gradient('Greys')\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[10], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">pd</span><span style=\"color:rgb(98,98,98)\">.</span>DataFrame(im3[:<span style=\"color:rgb(98,98,98)\">13</span>,:<span style=\"color:rgb(98,98,98)\">23</span>])\n<span class=\"ansi-green-fg ansi-bold\">      2</span> df<span style=\"color:rgb(98,98,98)\">.</span>style<span style=\"color:rgb(98,98,98)\">.</span>format(precision<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)<span style=\"color:rgb(98,98,98)\">.</span>set_properties(<span style=\"color:rgb(98,98,98)\">*</span><span style=\"color:rgb(98,98,98)\">*</span>{<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">font-size</span><span style=\"color:rgb(175,0,0)\">'</span>:<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">7pt</span><span style=\"color:rgb(175,0,0)\">'</span>})<span style=\"color:rgb(98,98,98)\">.</span>background_gradient(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">Greys</span><span style=\"color:rgb(175,0,0)\">'</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'pd' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#9b409581 .cell execution_count=11}\n``` {.python .cell-code}\n(im3[3:6,14:17] * top_edge).sum()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[11], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> (<span class=\"ansi-yellow-bg\">im3</span>[<span style=\"color:rgb(98,98,98)\">3</span>:<span style=\"color:rgb(98,98,98)\">6</span>,<span style=\"color:rgb(98,98,98)\">14</span>:<span style=\"color:rgb(98,98,98)\">17</span>] <span style=\"color:rgb(98,98,98)\">*</span> top_edge)<span style=\"color:rgb(98,98,98)\">.</span>sum()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'im3' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a44cd8cd .cell execution_count=12}\n``` {.python .cell-code}\n(im3[7:10,14:17] * top_edge).sum()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[12], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> (<span class=\"ansi-yellow-bg\">im3</span>[<span style=\"color:rgb(98,98,98)\">7</span>:<span style=\"color:rgb(98,98,98)\">10</span>,<span style=\"color:rgb(98,98,98)\">14</span>:<span style=\"color:rgb(98,98,98)\">17</span>] <span style=\"color:rgb(98,98,98)\">*</span> top_edge)<span style=\"color:rgb(98,98,98)\">.</span>sum()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'im3' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#287d43b5 .cell execution_count=13}\n``` {.python .cell-code}\ndef apply_kernel(row, col, kernel): return (im3[row-1:row+2,col-1:col+2] * kernel).sum()\n```\n:::\n\n\n::: {#ab86435e .cell execution_count=14}\n``` {.python .cell-code}\napply_kernel(4,15,top_edge)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[14], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> apply_kernel(<span style=\"color:rgb(98,98,98)\">4</span>,<span style=\"color:rgb(98,98,98)\">15</span>,<span class=\"ansi-yellow-bg\">top_edge</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'top_edge' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n<img src=\"images/chapter9_nopadconv.svg\" id=\"nopad_conv\" caption=\"Applying a kernel across a grid\" alt=\"Applying a kernel across a grid\" width=\"400\">\n\n::: {#3fe7d032 .cell execution_count=15}\n``` {.python .cell-code}\n[[(i,j) for j in range(5)] for i in range(5)]\n```\n\n::: {.cell-output .cell-output-display execution_count=15}\n```\n[[(0, 0), (0, 1), (0, 2), (0, 3), (0, 4)],\n [(1, 0), (1, 1), (1, 2), (1, 3), (1, 4)],\n [(2, 0), (2, 1), (2, 2), (2, 3), (2, 4)],\n [(3, 0), (3, 1), (3, 2), (3, 3), (3, 4)],\n [(4, 0), (4, 1), (4, 2), (4, 3), (4, 4)]]\n```\n:::\n:::\n\n\n::: {#19e67f81 .cell execution_count=16}\n``` {.python .cell-code}\nrng = range(1,27)\ntop_edge3 = tensor([[apply_kernel(i,j,top_edge) for j in rng] for i in rng])\nshow_image(top_edge3);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[16], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> rng <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">range</span>(<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">27</span>)\n<span class=\"ansi-green-fg\">----&gt; 2</span> top_edge3 <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">tensor</span>([[apply_kernel(i,j,top_edge) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> j <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> rng] <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> i <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> rng])\n<span class=\"ansi-green-fg ansi-bold\">      3</span> show_image(top_edge3);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tensor' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f7464ee0 .cell execution_count=17}\n``` {.python .cell-code}\nleft_edge = tensor([[-1,0,1],\n                    [-1,0,1],\n                    [-1,0,1]]).float()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[17], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> left_edge <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">tensor</span>([[<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">1</span>],\n<span class=\"ansi-green-fg ansi-bold\">      2</span>                     [<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">1</span>],\n<span class=\"ansi-green-fg ansi-bold\">      3</span>                     [<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">1</span>]])<span style=\"color:rgb(98,98,98)\">.</span>float()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tensor' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b73de0e7 .cell execution_count=18}\n``` {.python .cell-code}\nshow_image(left_edge, noframe=False);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[18], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_image</span>(left_edge, noframe<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2e773bfd .cell execution_count=19}\n``` {.python .cell-code}\nleft_edge3 = tensor([[apply_kernel(i,j,left_edge) for j in rng] for i in rng])\nshow_image(left_edge3);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[19], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> left_edge3 <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">tensor</span>([[apply_kernel(i,j,left_edge) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> j <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> rng] <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> i <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> rng])\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_image(left_edge3);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tensor' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n<img alt=\"Result of applying a 3×3 kernel to a 4×4 image\" width=\"782\" caption=\"Result of applying a 3×3 kernel to a 4×4 image (courtesy of Vincent Dumoulin and Francesco Visin)\" id=\"three_ex_four_conv\" src=\"images/att_00028.png\">\n\n### Convolutions in PyTorch\n\n::: {#863db20d .cell execution_count=20}\n``` {.python .cell-code}\nimport torch.nn.functional as F\nimport torch\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ImportError</span>                               Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[20], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">nn</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">functional</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">F</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span>\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/torch/__init__.py:237</span>\n<span class=\"ansi-green-fg ansi-bold\">    235</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> USE_GLOBAL_DEPS:\n<span class=\"ansi-green-fg ansi-bold\">    236</span>         _load_global_deps()\n<span class=\"ansi-green-fg\">--&gt; 237</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">_C</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>  <span style=\"font-style:italic;color:rgb(95,135,135)\"># noqa: F403</span>\n<span class=\"ansi-green-fg ansi-bold\">    239</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Appease the type checker; ordinarily this binding is inserted by the</span>\n<span class=\"ansi-green-fg ansi-bold\">    240</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># torch._C module initialization code in C</span>\n<span class=\"ansi-green-fg ansi-bold\">    241</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> TYPE_CHECKING:\n\n<span class=\"ansi-red-fg\">ImportError</span>: libcudnn.so.8: cannot open shared object file: No such file or directory</pre>\n```\n:::\n\n:::\n:::\n\n\nWhat to do if you have [2 months to complete your thesis](https://github.com/Yangqing/caffe/wiki/Convolution-in-Caffe:-a-memo)? Use [im2col](https://hal.inria.fr/inria-00112631/).\n\n![image.png](attachment:image.png)\n\nHere's a sample [numpy implementation](https://github.com/3outeille/CNNumpy/blob/5394f13e7ed67a808a3e39fd381f168825d65ff5/src/fast/utils.py#L360).\n\n::: {#f6660540 .cell execution_count=21}\n``` {.python .cell-code}\ninp = im3[None,None,:,:].float()\ninp_unf = F.unfold(inp, (3,3))[0]\ninp_unf.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[21], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> inp <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">im3</span>[<span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>,<span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>,:,:]<span style=\"color:rgb(98,98,98)\">.</span>float()\n<span class=\"ansi-green-fg ansi-bold\">      2</span> inp_unf <span style=\"color:rgb(98,98,98)\">=</span> F<span style=\"color:rgb(98,98,98)\">.</span>unfold(inp, (<span style=\"color:rgb(98,98,98)\">3</span>,<span style=\"color:rgb(98,98,98)\">3</span>))[<span style=\"color:rgb(98,98,98)\">0</span>]\n<span class=\"ansi-green-fg ansi-bold\">      3</span> inp_unf<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'im3' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c4023403 .cell execution_count=22}\n``` {.python .cell-code}\nw = left_edge.view(-1)\nw.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[22], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> w <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">left_edge</span><span style=\"color:rgb(98,98,98)\">.</span>view(<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> w<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'left_edge' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cb7d5bc4 .cell execution_count=23}\n``` {.python .cell-code}\nout_unf = w@inp_unf\nout_unf.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[23], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> out_unf <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">w</span><span style=\"color:rgb(175,0,255)\">@inp_unf</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> out_unf<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'w' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#60e0b4c3 .cell execution_count=24}\n``` {.python .cell-code}\nout = out_unf.view(26,26)\nshow_image(out);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[24], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> out <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">out_unf</span><span style=\"color:rgb(98,98,98)\">.</span>view(<span style=\"color:rgb(98,98,98)\">26</span>,<span style=\"color:rgb(98,98,98)\">26</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_image(out);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'out_unf' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#633717f2 .cell execution_count=25}\n``` {.python .cell-code}\n%timeit -n 1 tensor([[apply_kernel(i,j,left_edge) for j in rng] for i in rng]);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[25], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">get_ipython</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">)</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">run_line_magic</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">timeit</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">-n 1 tensor([[apply_kernel(i,j,left_edge) for j in rng] for i in rng]);</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py:2456</span>, in <span class=\"ansi-cyan-fg\">InteractiveShell.run_line_magic</span><span class=\"ansi-blue-fg\">(self, magic_name, line, _stack_depth)</span>\n<span class=\"ansi-green-fg ansi-bold\">   2454</span>     kwargs[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">local_ns</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>get_local_scope(stack_depth)\n<span class=\"ansi-green-fg ansi-bold\">   2455</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">with</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>builtin_trap:\n<span class=\"ansi-green-fg\">-&gt; 2456</span>     result <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">fn</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-yellow-bg\">args</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-yellow-bg\">kwargs</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   2458</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># The code below prevents the output from being displayed</span>\n<span class=\"ansi-green-fg ansi-bold\">   2459</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># when using magics with decorator @output_can_be_silenced</span>\n<span class=\"ansi-green-fg ansi-bold\">   2460</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># when the last Python token in the expression is a ';'.</span>\n<span class=\"ansi-green-fg ansi-bold\">   2461</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">getattr</span>(fn, magic<span style=\"color:rgb(98,98,98)\">.</span>MAGIC_OUTPUT_CAN_BE_SILENCED, <span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>):\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/magics/execution.py:1189</span>, in <span class=\"ansi-cyan-fg\">ExecutionMagics.timeit</span><span class=\"ansi-blue-fg\">(self, line, cell, local_ns)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1186</span>         <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> time_number <span style=\"color:rgb(98,98,98)\">&gt;</span><span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">0.2</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1187</span>             <span style=\"font-weight:bold;color:rgb(0,135,0)\">break</span>\n<span class=\"ansi-green-fg\">-&gt; 1189</span> all_runs <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">timer</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">repeat</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">repeat</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">number</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1190</span> best <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">min</span>(all_runs) <span style=\"color:rgb(98,98,98)\">/</span> number\n<span class=\"ansi-green-fg ansi-bold\">   1191</span> worst <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">max</span>(all_runs) <span style=\"color:rgb(98,98,98)\">/</span> number\n\nFile <span class=\"ansi-green-fg\">/usr/lib/python3.10/timeit.py:206</span>, in <span class=\"ansi-cyan-fg\">Timer.repeat</span><span class=\"ansi-blue-fg\">(self, repeat, number)</span>\n<span class=\"ansi-green-fg ansi-bold\">    204</span> r <span style=\"color:rgb(98,98,98)\">=</span> []\n<span class=\"ansi-green-fg ansi-bold\">    205</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> i <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span style=\"color:rgb(0,135,0)\">range</span>(repeat):\n<span class=\"ansi-green-fg\">--&gt; 206</span>     t <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">timeit</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">number</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    207</span>     r<span style=\"color:rgb(98,98,98)\">.</span>append(t)\n<span class=\"ansi-green-fg ansi-bold\">    208</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> r\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/magics/execution.py:173</span>, in <span class=\"ansi-cyan-fg\">Timer.timeit</span><span class=\"ansi-blue-fg\">(self, number)</span>\n<span class=\"ansi-green-fg ansi-bold\">    171</span> gc<span style=\"color:rgb(98,98,98)\">.</span>disable()\n<span class=\"ansi-green-fg ansi-bold\">    172</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">try</span>:\n<span class=\"ansi-green-fg\">--&gt; 173</span>     timing <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">inner</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">it</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">timer</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    174</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">finally</span>:\n<span class=\"ansi-green-fg ansi-bold\">    175</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> gcold:\n\nFile <span class=\"ansi-green-fg\">&lt;magic-timeit&gt;:1</span>, in <span class=\"ansi-cyan-fg\">inner</span><span class=\"ansi-blue-fg\">(_it, _timer)</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tensor' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#0c0081cf .cell execution_count=26}\n``` {.python .cell-code}\n%timeit -n 100 (w@F.unfold(inp, (3,3))[0]).view(26,26);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[26], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">get_ipython</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">)</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">run_line_magic</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">timeit</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">-n 100 (w@F.unfold(inp, (3,3))[0]).view(26,26);</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py:2456</span>, in <span class=\"ansi-cyan-fg\">InteractiveShell.run_line_magic</span><span class=\"ansi-blue-fg\">(self, magic_name, line, _stack_depth)</span>\n<span class=\"ansi-green-fg ansi-bold\">   2454</span>     kwargs[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">local_ns</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>get_local_scope(stack_depth)\n<span class=\"ansi-green-fg ansi-bold\">   2455</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">with</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>builtin_trap:\n<span class=\"ansi-green-fg\">-&gt; 2456</span>     result <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">fn</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-yellow-bg\">args</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-yellow-bg\">kwargs</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   2458</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># The code below prevents the output from being displayed</span>\n<span class=\"ansi-green-fg ansi-bold\">   2459</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># when using magics with decorator @output_can_be_silenced</span>\n<span class=\"ansi-green-fg ansi-bold\">   2460</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># when the last Python token in the expression is a ';'.</span>\n<span class=\"ansi-green-fg ansi-bold\">   2461</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">getattr</span>(fn, magic<span style=\"color:rgb(98,98,98)\">.</span>MAGIC_OUTPUT_CAN_BE_SILENCED, <span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>):\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/magics/execution.py:1189</span>, in <span class=\"ansi-cyan-fg\">ExecutionMagics.timeit</span><span class=\"ansi-blue-fg\">(self, line, cell, local_ns)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1186</span>         <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> time_number <span style=\"color:rgb(98,98,98)\">&gt;</span><span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">0.2</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1187</span>             <span style=\"font-weight:bold;color:rgb(0,135,0)\">break</span>\n<span class=\"ansi-green-fg\">-&gt; 1189</span> all_runs <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">timer</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">repeat</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">repeat</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">number</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1190</span> best <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">min</span>(all_runs) <span style=\"color:rgb(98,98,98)\">/</span> number\n<span class=\"ansi-green-fg ansi-bold\">   1191</span> worst <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">max</span>(all_runs) <span style=\"color:rgb(98,98,98)\">/</span> number\n\nFile <span class=\"ansi-green-fg\">/usr/lib/python3.10/timeit.py:206</span>, in <span class=\"ansi-cyan-fg\">Timer.repeat</span><span class=\"ansi-blue-fg\">(self, repeat, number)</span>\n<span class=\"ansi-green-fg ansi-bold\">    204</span> r <span style=\"color:rgb(98,98,98)\">=</span> []\n<span class=\"ansi-green-fg ansi-bold\">    205</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> i <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span style=\"color:rgb(0,135,0)\">range</span>(repeat):\n<span class=\"ansi-green-fg\">--&gt; 206</span>     t <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">timeit</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">number</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    207</span>     r<span style=\"color:rgb(98,98,98)\">.</span>append(t)\n<span class=\"ansi-green-fg ansi-bold\">    208</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> r\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/magics/execution.py:173</span>, in <span class=\"ansi-cyan-fg\">Timer.timeit</span><span class=\"ansi-blue-fg\">(self, number)</span>\n<span class=\"ansi-green-fg ansi-bold\">    171</span> gc<span style=\"color:rgb(98,98,98)\">.</span>disable()\n<span class=\"ansi-green-fg ansi-bold\">    172</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">try</span>:\n<span class=\"ansi-green-fg\">--&gt; 173</span>     timing <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">inner</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">it</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">timer</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    174</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">finally</span>:\n<span class=\"ansi-green-fg ansi-bold\">    175</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> gcold:\n\nFile <span class=\"ansi-green-fg\">&lt;magic-timeit&gt;:1</span>, in <span class=\"ansi-cyan-fg\">inner</span><span class=\"ansi-blue-fg\">(_it, _timer)</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'w' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2fc9ccac .cell execution_count=27}\n``` {.python .cell-code}\n%timeit -n 100 F.conv2d(inp, left_edge[None,None])\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[27], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">get_ipython</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">)</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">run_line_magic</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">timeit</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">-n 100 F.conv2d(inp, left_edge[None,None])</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">'</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py:2456</span>, in <span class=\"ansi-cyan-fg\">InteractiveShell.run_line_magic</span><span class=\"ansi-blue-fg\">(self, magic_name, line, _stack_depth)</span>\n<span class=\"ansi-green-fg ansi-bold\">   2454</span>     kwargs[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">local_ns</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>get_local_scope(stack_depth)\n<span class=\"ansi-green-fg ansi-bold\">   2455</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">with</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>builtin_trap:\n<span class=\"ansi-green-fg\">-&gt; 2456</span>     result <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">fn</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-yellow-bg\">args</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-yellow-bg\">kwargs</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   2458</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># The code below prevents the output from being displayed</span>\n<span class=\"ansi-green-fg ansi-bold\">   2459</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># when using magics with decorator @output_can_be_silenced</span>\n<span class=\"ansi-green-fg ansi-bold\">   2460</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># when the last Python token in the expression is a ';'.</span>\n<span class=\"ansi-green-fg ansi-bold\">   2461</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">getattr</span>(fn, magic<span style=\"color:rgb(98,98,98)\">.</span>MAGIC_OUTPUT_CAN_BE_SILENCED, <span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>):\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/magics/execution.py:1189</span>, in <span class=\"ansi-cyan-fg\">ExecutionMagics.timeit</span><span class=\"ansi-blue-fg\">(self, line, cell, local_ns)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1186</span>         <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> time_number <span style=\"color:rgb(98,98,98)\">&gt;</span><span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">0.2</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1187</span>             <span style=\"font-weight:bold;color:rgb(0,135,0)\">break</span>\n<span class=\"ansi-green-fg\">-&gt; 1189</span> all_runs <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">timer</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">repeat</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">repeat</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">number</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1190</span> best <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">min</span>(all_runs) <span style=\"color:rgb(98,98,98)\">/</span> number\n<span class=\"ansi-green-fg ansi-bold\">   1191</span> worst <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">max</span>(all_runs) <span style=\"color:rgb(98,98,98)\">/</span> number\n\nFile <span class=\"ansi-green-fg\">/usr/lib/python3.10/timeit.py:206</span>, in <span class=\"ansi-cyan-fg\">Timer.repeat</span><span class=\"ansi-blue-fg\">(self, repeat, number)</span>\n<span class=\"ansi-green-fg ansi-bold\">    204</span> r <span style=\"color:rgb(98,98,98)\">=</span> []\n<span class=\"ansi-green-fg ansi-bold\">    205</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> i <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span style=\"color:rgb(0,135,0)\">range</span>(repeat):\n<span class=\"ansi-green-fg\">--&gt; 206</span>     t <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">timeit</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">number</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    207</span>     r<span style=\"color:rgb(98,98,98)\">.</span>append(t)\n<span class=\"ansi-green-fg ansi-bold\">    208</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> r\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/IPython/core/magics/execution.py:173</span>, in <span class=\"ansi-cyan-fg\">Timer.timeit</span><span class=\"ansi-blue-fg\">(self, number)</span>\n<span class=\"ansi-green-fg ansi-bold\">    171</span> gc<span style=\"color:rgb(98,98,98)\">.</span>disable()\n<span class=\"ansi-green-fg ansi-bold\">    172</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">try</span>:\n<span class=\"ansi-green-fg\">--&gt; 173</span>     timing <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">inner</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">it</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">timer</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    174</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">finally</span>:\n<span class=\"ansi-green-fg ansi-bold\">    175</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> gcold:\n\nFile <span class=\"ansi-green-fg\">&lt;magic-timeit&gt;:1</span>, in <span class=\"ansi-cyan-fg\">inner</span><span class=\"ansi-blue-fg\">(_it, _timer)</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'F' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f20deafd .cell execution_count=28}\n``` {.python .cell-code}\ndiag1_edge = tensor([[ 0,-1, 1],\n                     [-1, 1, 0],\n                     [ 1, 0, 0]]).float()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[28], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> diag1_edge <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">tensor</span>([[ <span style=\"color:rgb(98,98,98)\">0</span>,<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>, <span style=\"color:rgb(98,98,98)\">1</span>],\n<span class=\"ansi-green-fg ansi-bold\">      2</span>                      [<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>, <span style=\"color:rgb(98,98,98)\">1</span>, <span style=\"color:rgb(98,98,98)\">0</span>],\n<span class=\"ansi-green-fg ansi-bold\">      3</span>                      [ <span style=\"color:rgb(98,98,98)\">1</span>, <span style=\"color:rgb(98,98,98)\">0</span>, <span style=\"color:rgb(98,98,98)\">0</span>]])<span style=\"color:rgb(98,98,98)\">.</span>float()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tensor' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d46e053f .cell execution_count=29}\n``` {.python .cell-code}\nshow_image(diag1_edge, noframe=False);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[29], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_image</span>(diag1_edge, noframe<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#60e123a7 .cell execution_count=30}\n``` {.python .cell-code}\ndiag2_edge = tensor([[ 1,-1, 0],\n                     [ 0, 1,-1],\n                     [ 0, 0, 1]]).float()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[30], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> diag2_edge <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">tensor</span>([[ <span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>, <span style=\"color:rgb(98,98,98)\">0</span>],\n<span class=\"ansi-green-fg ansi-bold\">      2</span>                      [ <span style=\"color:rgb(98,98,98)\">0</span>, <span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>],\n<span class=\"ansi-green-fg ansi-bold\">      3</span>                      [ <span style=\"color:rgb(98,98,98)\">0</span>, <span style=\"color:rgb(98,98,98)\">0</span>, <span style=\"color:rgb(98,98,98)\">1</span>]])<span style=\"color:rgb(98,98,98)\">.</span>float()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tensor' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f82da0f8 .cell execution_count=31}\n``` {.python .cell-code}\nshow_image(diag2_edge, noframe=False);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[31], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_image</span>(diag2_edge, noframe<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#30399771 .cell execution_count=32}\n``` {.python .cell-code}\nxb = x_imgs[:16][:,None]\nxb.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[32], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> xb <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">x_imgs</span>[:<span style=\"color:rgb(98,98,98)\">16</span>][:,<span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> xb<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x_imgs' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a283a779 .cell execution_count=33}\n``` {.python .cell-code}\nedge_kernels = torch.stack([left_edge, top_edge, diag1_edge, diag2_edge])[:,None]\nedge_kernels.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[33], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> edge_kernels <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>stack([left_edge, top_edge, diag1_edge, diag2_edge])[:,<span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> edge_kernels<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f1a7fc8f .cell execution_count=34}\n``` {.python .cell-code}\nbatch_features = F.conv2d(xb, edge_kernels)\nbatch_features.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[34], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> batch_features <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">F</span><span style=\"color:rgb(98,98,98)\">.</span>conv2d(xb, edge_kernels)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> batch_features<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'F' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\nThe output shape shows we gave 64 images in the mini-batch, 4 kernels, and 26×26 edge maps (we started with 28×28 images, but lost one pixel from each side as discussed earlier). We can see we get the same results as when we did this manually:\n\n::: {#0aa3d2bb .cell execution_count=35}\n``` {.python .cell-code}\nimg0 = xb[1,0]\nshow_image(img0);\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[35], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> img0 <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">xb</span>[<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">0</span>]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_image(img0);\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'xb' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2e02a8a8 .cell execution_count=36}\n``` {.python .cell-code}\nshow_images([batch_features[1,i] for i in range(4)])\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[36], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_images</span>([batch_features[<span style=\"color:rgb(98,98,98)\">1</span>,i] <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> i <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span style=\"color:rgb(0,135,0)\">range</span>(<span style=\"color:rgb(98,98,98)\">4</span>)])\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_images' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n### Strides and Padding\n\nWith appropriate padding, we can ensure that the output activation map is the same size as the original image.\n\n<img src=\"images/chapter9_padconv.svg\" id=\"pad_conv\" caption=\"A convolution with padding\" alt=\"A convolution with padding\" width=\"600\">\n\nWith a 5×5 input, 4×4 kernel, and 2 pixels of padding, we end up with a 6×6 activation map.\n\n<img alt=\"A 4×4 kernel with 5×5 input and 2 pixels of padding\" width=\"783\" caption=\"A 4×4 kernel with 5×5 input and 2 pixels of padding (courtesy of Vincent Dumoulin and Francesco Visin)\" id=\"four_by_five_conv\" src=\"images/att_00029.png\">\n\nIf we add a kernel of size `ks` by `ks` (with `ks` an odd number), the necessary padding on each side to keep the same shape is `ks//2`.\n\nWe could move over two pixels after each kernel application. This is known as a *stride-2* convolution.\n\n<img alt=\"A 3×3 kernel with 5×5 input, stride-2 convolution, and 1 pixel of padding\" width=\"774\" caption=\"A 3×3 kernel with 5×5 input, stride-2 convolution, and 1 pixel of padding (courtesy of Vincent Dumoulin and Francesco Visin)\" id=\"three_by_five_conv\" src=\"images/att_00030.png\">\n\n## Creating the CNN\n\n::: {#e61af6cf .cell execution_count=37}\n``` {.python .cell-code}\nn,m = x_train.shape\nc = y_train.max()+1\nnh = 50\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[37], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> n,m <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">x_train</span><span style=\"color:rgb(98,98,98)\">.</span>shape\n<span class=\"ansi-green-fg ansi-bold\">      2</span> c <span style=\"color:rgb(98,98,98)\">=</span> y_train<span style=\"color:rgb(98,98,98)\">.</span>max()<span style=\"color:rgb(98,98,98)\">+</span><span style=\"color:rgb(98,98,98)\">1</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> nh <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">50</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x_train' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a3e85d47 .cell execution_count=38}\n``` {.python .cell-code}\nmodel = nn.Sequential(nn.Linear(m,nh), nn.ReLU(), nn.Linear(nh,10))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[38], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> model <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Sequential(nn<span style=\"color:rgb(98,98,98)\">.</span>Linear(m,nh), nn<span style=\"color:rgb(98,98,98)\">.</span>ReLU(), nn<span style=\"color:rgb(98,98,98)\">.</span>Linear(nh,<span style=\"color:rgb(98,98,98)\">10</span>))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f632ae2c .cell execution_count=39}\n``` {.python .cell-code}\nbroken_cnn = nn.Sequential(\n    nn.Conv2d(1,30, kernel_size=3, padding=1),\n    nn.ReLU(),\n    nn.Conv2d(30,10, kernel_size=3, padding=1)\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[39], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> broken_cnn <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Sequential(\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     nn<span style=\"color:rgb(98,98,98)\">.</span>Conv2d(<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">30</span>, kernel_size<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, padding<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>),\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     nn<span style=\"color:rgb(98,98,98)\">.</span>ReLU(),\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     nn<span style=\"color:rgb(98,98,98)\">.</span>Conv2d(<span style=\"color:rgb(98,98,98)\">30</span>,<span style=\"color:rgb(98,98,98)\">10</span>, kernel_size<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>, padding<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#36d26285 .cell execution_count=40}\n``` {.python .cell-code}\nbroken_cnn(xb).shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[40], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">broken_cnn</span>(xb)<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'broken_cnn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#af4e8151 .cell execution_count=41}\n``` {.python .cell-code}\ndef conv(ni, nf, ks=3, stride=2, act=True):\n    res = nn.Conv2d(ni, nf, stride=stride, kernel_size=ks, padding=ks//2)\n    if act: res = nn.Sequential(res, nn.ReLU())\n    return res\n```\n:::\n\n\nRefactoring parts of your neural networks like this makes it much less likely you'll get errors due to inconsistencies in your architectures, and makes it more obvious to the reader which parts of your layers are actually changing.\n\n::: {#8f41fd9d .cell execution_count=42}\n``` {.python .cell-code}\nsimple_cnn = nn.Sequential(\n    conv(1 ,4),            #14x14\n    conv(4 ,8),            #7x7\n    conv(8 ,16),           #4x4\n    conv(16,16),           #2x2\n    conv(16,10, act=False), #1x1\n    nn.Flatten(),\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[42], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> simple_cnn <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Sequential(\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     conv(<span style=\"color:rgb(98,98,98)\">1</span> ,<span style=\"color:rgb(98,98,98)\">4</span>),            <span style=\"font-style:italic;color:rgb(95,135,135)\">#14x14</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     conv(<span style=\"color:rgb(98,98,98)\">4</span> ,<span style=\"color:rgb(98,98,98)\">8</span>),            <span style=\"font-style:italic;color:rgb(95,135,135)\">#7x7</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     conv(<span style=\"color:rgb(98,98,98)\">8</span> ,<span style=\"color:rgb(98,98,98)\">16</span>),           <span style=\"font-style:italic;color:rgb(95,135,135)\">#4x4</span>\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     conv(<span style=\"color:rgb(98,98,98)\">16</span>,<span style=\"color:rgb(98,98,98)\">16</span>),           <span style=\"font-style:italic;color:rgb(95,135,135)\">#2x2</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span>     conv(<span style=\"color:rgb(98,98,98)\">16</span>,<span style=\"color:rgb(98,98,98)\">10</span>, act<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>), <span style=\"font-style:italic;color:rgb(95,135,135)\">#1x1</span>\n<span class=\"ansi-green-fg ansi-bold\">      7</span>     nn<span style=\"color:rgb(98,98,98)\">.</span>Flatten(),\n<span class=\"ansi-green-fg ansi-bold\">      8</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c1d0f5a3 .cell execution_count=43}\n``` {.python .cell-code}\nsimple_cnn(xb).shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[43], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">simple_cnn</span>(xb)<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'simple_cnn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#37b49e94 .cell execution_count=44}\n``` {.python .cell-code}\nx_imgs = x_train.view(-1,1,28,28)\nxv_imgs = x_valid.view(-1,1,28,28)\ntrain_ds,valid_ds = Dataset(x_imgs, y_train),Dataset(xv_imgs, y_valid)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[44], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> x_imgs <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">x_train</span><span style=\"color:rgb(98,98,98)\">.</span>view(<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">28</span>,<span style=\"color:rgb(98,98,98)\">28</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> xv_imgs <span style=\"color:rgb(98,98,98)\">=</span> x_valid<span style=\"color:rgb(98,98,98)\">.</span>view(<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">28</span>,<span style=\"color:rgb(98,98,98)\">28</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> train_ds,valid_ds <span style=\"color:rgb(98,98,98)\">=</span> Dataset(x_imgs, y_train),Dataset(xv_imgs, y_valid)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'x_train' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d8499051 .cell execution_count=45}\n``` {.python .cell-code}\ndef_device = 'mps' if torch.backends.mps.is_available() else 'cuda' if torch.cuda.is_available() else 'cpu'\n\ndef to_device(x, device=def_device):\n    if isinstance(x, torch.Tensor): return x.to(device)\n    if isinstance(x, Mapping): return {k:v.to(device) for k,v in x.items()}\n    return type(x)(to_device(o, device) for o in x)\n\ndef collate_device(b): return to_device(default_collate(b))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[45], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> def_device <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">mps</span><span style=\"color:rgb(175,0,0)\">'</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>backends<span style=\"color:rgb(98,98,98)\">.</span>mps<span style=\"color:rgb(98,98,98)\">.</span>is_available() <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">cuda</span><span style=\"color:rgb(175,0,0)\">'</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> torch<span style=\"color:rgb(98,98,98)\">.</span>cuda<span style=\"color:rgb(98,98,98)\">.</span>is_available() <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">cpu</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">to_device</span>(x, device<span style=\"color:rgb(98,98,98)\">=</span>def_device):\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(x, torch<span style=\"color:rgb(98,98,98)\">.</span>Tensor): <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> x<span style=\"color:rgb(98,98,98)\">.</span>to(device)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f630c3ee .cell execution_count=46}\n``` {.python .cell-code}\nfrom torch import optim\n\nbs = 256\nlr = 0.4\ntrain_dl,valid_dl = get_dls(train_ds, valid_ds, bs, collate_fn=collate_device)\nopt = optim.SGD(simple_cnn.parameters(), lr=lr)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ImportError</span>                               Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[46], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> optim\n<span class=\"ansi-green-fg ansi-bold\">      3</span> bs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">256</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> lr <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">0.4</span>\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/torch/__init__.py:237</span>\n<span class=\"ansi-green-fg ansi-bold\">    235</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> USE_GLOBAL_DEPS:\n<span class=\"ansi-green-fg ansi-bold\">    236</span>         _load_global_deps()\n<span class=\"ansi-green-fg\">--&gt; 237</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">_C</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>  <span style=\"font-style:italic;color:rgb(95,135,135)\"># noqa: F403</span>\n<span class=\"ansi-green-fg ansi-bold\">    239</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Appease the type checker; ordinarily this binding is inserted by the</span>\n<span class=\"ansi-green-fg ansi-bold\">    240</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># torch._C module initialization code in C</span>\n<span class=\"ansi-green-fg ansi-bold\">    241</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> TYPE_CHECKING:\n\n<span class=\"ansi-red-fg\">ImportError</span>: libcudnn.so.8: cannot open shared object file: No such file or directory</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#32d8deda .cell execution_count=47}\n``` {.python .cell-code}\nloss,acc = fit(5, simple_cnn.to(def_device), F.cross_entropy, opt, train_dl, valid_dl)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[47], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> loss,acc <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">fit</span>(<span style=\"color:rgb(98,98,98)\">5</span>, simple_cnn<span style=\"color:rgb(98,98,98)\">.</span>to(def_device), F<span style=\"color:rgb(98,98,98)\">.</span>cross_entropy, opt, train_dl, valid_dl)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'fit' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#19368f70 .cell execution_count=48}\n``` {.python .cell-code}\nopt = optim.SGD(simple_cnn.parameters(), lr=lr/4)\nloss,acc = fit(5, simple_cnn.to(def_device), F.cross_entropy, opt, train_dl, valid_dl)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[48], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> opt <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">optim</span><span style=\"color:rgb(98,98,98)\">.</span>SGD(simple_cnn<span style=\"color:rgb(98,98,98)\">.</span>parameters(), lr<span style=\"color:rgb(98,98,98)\">=</span>lr<span style=\"color:rgb(98,98,98)\">/</span><span style=\"color:rgb(98,98,98)\">4</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> loss,acc <span style=\"color:rgb(98,98,98)\">=</span> fit(<span style=\"color:rgb(98,98,98)\">5</span>, simple_cnn<span style=\"color:rgb(98,98,98)\">.</span>to(def_device), F<span style=\"color:rgb(98,98,98)\">.</span>cross_entropy, opt, train_dl, valid_dl)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'optim' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n### Understanding Convolution Arithmetic\n\nIn an input of size `64x1x28x28` the axes are `batch,channel,height,width`. This is often represented as `NCHW` (where `N` refers to batch size). Tensorflow, on the other hand, uses `NHWC` axis order (aka \"channels-last\"). Channels-last is faster for many models, so recently it's become more common to see this as an option in PyTorch too.\n\nWe have 1 input channel, 4 output channels, and a 3×3 kernel.\n\n::: {#948770e1 .cell execution_count=49}\n``` {.python .cell-code}\nsimple_cnn[0][0]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[49], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">simple_cnn</span>[<span style=\"color:rgb(98,98,98)\">0</span>][<span style=\"color:rgb(98,98,98)\">0</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'simple_cnn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#373873a5 .cell execution_count=50}\n``` {.python .cell-code}\nconv1 = simple_cnn[0][0]\nconv1.weight.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[50], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> conv1 <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">simple_cnn</span>[<span style=\"color:rgb(98,98,98)\">0</span>][<span style=\"color:rgb(98,98,98)\">0</span>]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> conv1<span style=\"color:rgb(98,98,98)\">.</span>weight<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'simple_cnn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cb37028b .cell execution_count=51}\n``` {.python .cell-code}\nconv1.bias.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[51], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">conv1</span><span style=\"color:rgb(98,98,98)\">.</span>bias<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'conv1' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\nThe *receptive field* is the area of an image that is involved in the calculation of a layer. *conv-example.xlsx* shows the calculation of two stride-2 convolutional layers using an MNIST digit. Here's what we see if we click on one of the cells in the *conv2* section, which shows the output of the second convolutional layer, and click *trace precedents*.\n\n<img alt=\"Immediate precedents of conv2 layer\" width=\"308\" caption=\"Immediate precedents of Conv2 layer\" id=\"preced1\" src=\"images/att_00068.png\">\n\nThe blue highlighted cells are its *precedents*—that is, the cells used to calculate its value. These cells are the corresponding 3×3 area of cells from the input layer (on the left), and the cells from the filter (on the right). Click *trace precedents* again:\n\n<img alt=\"Secondary precedents of conv2 layer\" width=\"601\" caption=\"Secondary precedents of Conv2 layer\" id=\"preced2\" src=\"images/att_00069.png\">\n\nIn this example, we have just two convolutional layers. We can see that a 7×7 area of cells in the input layer is used to calculate the single green cell in the Conv2 layer. This is the *receptive field*\n\nThe deeper we are in the network (specifically, the more stride-2 convs we have before a layer), the larger the receptive field for an activation in that layer.\n\n## Color Images\n\nA colour picture is a rank-3 tensor:\n\n::: {#600bd9a7 .cell execution_count=52}\n``` {.python .cell-code}\nfrom torchvision.io import read_image\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ImportError</span>                               Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[52], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torchvision</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">io</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> read_image\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/torchvision/__init__.py:5</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">warnings</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">modulefinder</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> Module\n<span class=\"ansi-green-fg\">----&gt; 5</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torchvision</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> _meta_registrations, datasets, io, models, ops, transforms, utils\n<span class=\"ansi-green-fg ansi-bold\">      8</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">extension</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> _HAS_OPS\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/torch/__init__.py:237</span>\n<span class=\"ansi-green-fg ansi-bold\">    235</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> USE_GLOBAL_DEPS:\n<span class=\"ansi-green-fg ansi-bold\">    236</span>         _load_global_deps()\n<span class=\"ansi-green-fg\">--&gt; 237</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">_C</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>  <span style=\"font-style:italic;color:rgb(95,135,135)\"># noqa: F403</span>\n<span class=\"ansi-green-fg ansi-bold\">    239</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Appease the type checker; ordinarily this binding is inserted by the</span>\n<span class=\"ansi-green-fg ansi-bold\">    240</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># torch._C module initialization code in C</span>\n<span class=\"ansi-green-fg ansi-bold\">    241</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> TYPE_CHECKING:\n\n<span class=\"ansi-red-fg\">ImportError</span>: libcudnn.so.8: cannot open shared object file: No such file or directory</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#5942e838 .cell execution_count=53}\n``` {.python .cell-code}\nim = read_image('images/grizzly.jpg')\nim.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[53], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> im <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">read_image</span>(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">images/grizzly.jpg</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> im<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'read_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a8226c09 .cell execution_count=54}\n``` {.python .cell-code}\nshow_image(im.permute(1,2,0));\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[54], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_image</span>(im<span style=\"color:rgb(98,98,98)\">.</span>permute(<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">2</span>,<span style=\"color:rgb(98,98,98)\">0</span>));\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_image' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a82d93d9 .cell execution_count=55}\n``` {.python .cell-code}\n_,axs = plt.subplots(1,3)\nfor bear,ax,color in zip(im,axs,('Reds','Greens','Blues')): show_image(255-bear, ax=ax, cmap=color)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[55], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> _,axs <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">plt</span><span style=\"color:rgb(98,98,98)\">.</span>subplots(<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">3</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> bear,ax,color <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span style=\"color:rgb(0,135,0)\">zip</span>(im,axs,(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">Reds</span><span style=\"color:rgb(175,0,0)\">'</span>,<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">Greens</span><span style=\"color:rgb(175,0,0)\">'</span>,<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">Blues</span><span style=\"color:rgb(175,0,0)\">'</span>)): show_image(<span style=\"color:rgb(98,98,98)\">255</span><span style=\"color:rgb(98,98,98)\">-</span>bear, ax<span style=\"color:rgb(98,98,98)\">=</span>ax, cmap<span style=\"color:rgb(98,98,98)\">=</span>color)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'plt' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n<img src=\"images/chapter9_rgbconv.svg\" id=\"rgbconv\" caption=\"Convolution over an RGB image\" alt=\"Convolution over an RGB image\" width=\"550\">\n\nThese are then all added together, to produce a single number, for each grid location, for each output feature.\n\n<img src=\"images/chapter9_rgb_conv_stack.svg\" id=\"rgbconv2\" caption=\"Adding the RGB filters\" alt=\"Adding the RGB filters\" width=\"500\">\n\nWe have `ch_out` filters like this, so in the end, the result of our convolutional layer will be a batch of images with `ch_out` channels.\n\n## Export -\n\n::: {#6882fd88 .cell execution_count=56}\n``` {.python .cell-code}\nimport nbdev; nbdev.nbdev_export()\n```\n:::\n\n\n",
    "supporting": [
      "07_convolutions_files"
    ],
    "filters": [],
    "includes": {}
  }
}