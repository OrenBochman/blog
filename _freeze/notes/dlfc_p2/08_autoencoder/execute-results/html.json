{
  "hash": "063946a57f410072612e7114bb881bdb",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Autoencoders\njupyter: python3\nimage: cover.png\n---\n\n::: {#11c0c07c .cell execution_count=1}\n``` {.python .cell-code}\nimport pickle,gzip,math,os,time,shutil,torch,matplotlib as mpl,numpy as np,matplotlib.pyplot as plt\nimport fastcore.all as fc\nfrom collections.abc import Mapping\nfrom pathlib import Path\nfrom operator import attrgetter,itemgetter\nfrom functools import partial\n\nfrom torch import tensor,nn,optim\nfrom torch.utils.data import DataLoader,default_collate\nimport torch.nn.functional as F\nimport torchvision.transforms.functional as TF\nfrom datasets import load_dataset,load_dataset_builder\n\nfrom fastprogress import progress_bar,master_bar\nfrom miniai.datasets import *\nfrom miniai.training import *\nfrom miniai.conv import *\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ImportError</span>                               Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[1], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pickle</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">gzip</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">math</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">os</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">time</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">shutil</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">mpl</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">numpy</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">np</span><span style=\"color:rgb(98,98,98)\">,</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">matplotlib</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">pyplot</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">plt</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fastcore</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">all</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fc</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">collections</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">abc</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> Mapping\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/torch/__init__.py:237</span>\n<span class=\"ansi-green-fg ansi-bold\">    235</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> USE_GLOBAL_DEPS:\n<span class=\"ansi-green-fg ansi-bold\">    236</span>         _load_global_deps()\n<span class=\"ansi-green-fg\">--&gt; 237</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">_C</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>  <span style=\"font-style:italic;color:rgb(95,135,135)\"># noqa: F403</span>\n<span class=\"ansi-green-fg ansi-bold\">    239</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Appease the type checker; ordinarily this binding is inserted by the</span>\n<span class=\"ansi-green-fg ansi-bold\">    240</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># torch._C module initialization code in C</span>\n<span class=\"ansi-green-fg ansi-bold\">    241</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> TYPE_CHECKING:\n\n<span class=\"ansi-red-fg\">ImportError</span>: libcudnn.so.8: cannot open shared object file: No such file or directory</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#56b6a929 .cell execution_count=2}\n``` {.python .cell-code}\nfrom fastcore.test import test_close\n\ntorch.set_printoptions(precision=2, linewidth=140, sci_mode=False)\ntorch.manual_seed(1)\nmpl.rcParams['image.cmap'] = 'gray'\n\nimport logging\nlogging.disable(logging.WARNING)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[2], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">fastcore</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">test</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> test_close\n<span class=\"ansi-green-fg\">----&gt; 3</span> <span class=\"ansi-yellow-bg\">torch</span><span style=\"color:rgb(98,98,98)\">.</span>set_printoptions(precision<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>, linewidth<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">140</span>, sci_mode<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> torch<span style=\"color:rgb(98,98,98)\">.</span>manual_seed(<span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> mpl<span style=\"color:rgb(98,98,98)\">.</span>rcParams[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">image.cmap</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">gray</span><span style=\"color:rgb(175,0,0)\">'</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'torch' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Data\n\n::: {#2a55f1cc .cell execution_count=3}\n``` {.python .cell-code}\nx,y = 'image','label'\nname = \"fashion_mnist\"\ndsd = load_dataset(name, ignore_verifications=True)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[3], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> x,y <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">image</span><span style=\"color:rgb(175,0,0)\">'</span>,<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">label</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> name <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">fashion_mnist</span><span style=\"color:rgb(175,0,0)\">\"</span>\n<span class=\"ansi-green-fg\">----&gt; 3</span> dsd <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">load_dataset</span>(name, ignore_verifications<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'load_dataset' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ebfd16ce .cell execution_count=4}\n``` {.python .cell-code}\n@inplace\ndef transformi(b): b[x] = [TF.to_tensor(o) for o in b[x]]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[4], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(175,0,255)\">@inplace</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">def</span> <span style=\"color:rgb(0,0,255)\">transformi</span>(b): b[x] <span style=\"color:rgb(98,98,98)\">=</span> [TF<span style=\"color:rgb(98,98,98)\">.</span>to_tensor(o) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> o <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> b[x]]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'inplace' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#7678bd63 .cell execution_count=5}\n``` {.python .cell-code}\nbs = 256\ntds = dsd.with_transform(transformi)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[5], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> bs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">256</span>\n<span class=\"ansi-green-fg\">----&gt; 2</span> tds <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">dsd</span><span style=\"color:rgb(98,98,98)\">.</span>with_transform(transformi)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dsd' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cb17677a .cell execution_count=6}\n``` {.python .cell-code}\nds = tds['train']\nimg = ds[0]['image']\nshow_image(img, figsize=(1,1));\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[6], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> ds <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">tds</span>[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">train</span><span style=\"color:rgb(175,0,0)\">'</span>]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> img <span style=\"color:rgb(98,98,98)\">=</span> ds[<span style=\"color:rgb(98,98,98)\">0</span>][<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">image</span><span style=\"color:rgb(175,0,0)\">'</span>]\n<span class=\"ansi-green-fg ansi-bold\">      3</span> show_image(img, figsize<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">1</span>));\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tds' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b7ab65dd .cell execution_count=7}\n``` {.python .cell-code}\ncf = collate_dict(ds)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[7], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> cf <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">collate_dict</span>(ds)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'collate_dict' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#52b8652f .cell execution_count=8}\n``` {.python .cell-code}\ndef collate_(b): return to_device(cf(b))\ndef data_loaders(dsd, bs, **kwargs): return {k:DataLoader(v, bs, **kwargs) for k,v in dsd.items()}\n```\n:::\n\n\n::: {#ff06b0b7 .cell execution_count=9}\n``` {.python .cell-code}\ndls = data_loaders(tds, bs, collate_fn=collate_)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[9], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> dls <span style=\"color:rgb(98,98,98)\">=</span> data_loaders(<span class=\"ansi-yellow-bg\">tds</span>, bs, collate_fn<span style=\"color:rgb(98,98,98)\">=</span>collate_)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'tds' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#757be1d4 .cell execution_count=10}\n``` {.python .cell-code}\ndt = dls['train']\ndv = dls['test']\n\nxb,yb = next(iter(dt))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[10], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> dt <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">dls</span>[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">train</span><span style=\"color:rgb(175,0,0)\">'</span>]\n<span class=\"ansi-green-fg ansi-bold\">      2</span> dv <span style=\"color:rgb(98,98,98)\">=</span> dls[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">test</span><span style=\"color:rgb(175,0,0)\">'</span>]\n<span class=\"ansi-green-fg ansi-bold\">      4</span> xb,yb <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">next</span>(<span style=\"color:rgb(0,135,0)\">iter</span>(dt))\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dls' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f96a797e .cell execution_count=11}\n``` {.python .cell-code}\nlabels = ds.features[y].names\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[11], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> labels <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">ds</span><span style=\"color:rgb(98,98,98)\">.</span>features[y]<span style=\"color:rgb(98,98,98)\">.</span>names\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'ds' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#5cc3559d .cell execution_count=12}\n``` {.python .cell-code}\nlabels\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[12], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">labels</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'labels' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#73d1c050 .cell execution_count=13}\n``` {.python .cell-code}\nlbl_getter = itemgetter(*yb[:16])\ntitles = lbl_getter(labels)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[13], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> lbl_getter <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">itemgetter</span>(<span style=\"color:rgb(98,98,98)\">*</span>yb[:<span style=\"color:rgb(98,98,98)\">16</span>])\n<span class=\"ansi-green-fg ansi-bold\">      2</span> titles <span style=\"color:rgb(98,98,98)\">=</span> lbl_getter(labels)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'itemgetter' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8f842bc3 .cell execution_count=14}\n``` {.python .cell-code}\nmpl.rcParams['figure.dpi'] = 70\nshow_images(xb[:16], imsize=1.7, titles=titles)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[14], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">mpl</span><span style=\"color:rgb(98,98,98)\">.</span>rcParams[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">figure.dpi</span><span style=\"color:rgb(175,0,0)\">'</span>] <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">70</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_images(xb[:<span style=\"color:rgb(98,98,98)\">16</span>], imsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1.7</span>, titles<span style=\"color:rgb(98,98,98)\">=</span>titles)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'mpl' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Warmup - classify\n\n::: {#eee4c564 .cell execution_count=15}\n``` {.python .cell-code}\nfrom torch import optim\n\nbs = 256\nlr = 0.4\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">ImportError</span>                               Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[15], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> optim\n<span class=\"ansi-green-fg ansi-bold\">      3</span> bs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">256</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> lr <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(98,98,98)\">0.4</span>\n\nFile <span class=\"ansi-green-fg\">~/work/blog/.venv/lib/python3.10/site-packages/torch/__init__.py:237</span>\n<span class=\"ansi-green-fg ansi-bold\">    235</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> USE_GLOBAL_DEPS:\n<span class=\"ansi-green-fg ansi-bold\">    236</span>         _load_global_deps()\n<span class=\"ansi-green-fg\">--&gt; 237</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">torch</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">_C</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"color:rgb(98,98,98)\">*</span>  <span style=\"font-style:italic;color:rgb(95,135,135)\"># noqa: F403</span>\n<span class=\"ansi-green-fg ansi-bold\">    239</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Appease the type checker; ordinarily this binding is inserted by the</span>\n<span class=\"ansi-green-fg ansi-bold\">    240</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># torch._C module initialization code in C</span>\n<span class=\"ansi-green-fg ansi-bold\">    241</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> TYPE_CHECKING:\n\n<span class=\"ansi-red-fg\">ImportError</span>: libcudnn.so.8: cannot open shared object file: No such file or directory</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#85d59ce9 .cell execution_count=16}\n``` {.python .cell-code}\ncnn = nn.Sequential(\n    conv(1 ,4),            #14x14\n    conv(4 ,8),            #7x7\n    conv(8 ,16),           #4x4\n    conv(16,16),           #2x2\n    conv(16,10, act=False),\n    nn.Flatten()).to(def_device)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[16], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> cnn <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Sequential(\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     conv(<span style=\"color:rgb(98,98,98)\">1</span> ,<span style=\"color:rgb(98,98,98)\">4</span>),            <span style=\"font-style:italic;color:rgb(95,135,135)\">#14x14</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     conv(<span style=\"color:rgb(98,98,98)\">4</span> ,<span style=\"color:rgb(98,98,98)\">8</span>),            <span style=\"font-style:italic;color:rgb(95,135,135)\">#7x7</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     conv(<span style=\"color:rgb(98,98,98)\">8</span> ,<span style=\"color:rgb(98,98,98)\">16</span>),           <span style=\"font-style:italic;color:rgb(95,135,135)\">#4x4</span>\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     conv(<span style=\"color:rgb(98,98,98)\">16</span>,<span style=\"color:rgb(98,98,98)\">16</span>),           <span style=\"font-style:italic;color:rgb(95,135,135)\">#2x2</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span>     conv(<span style=\"color:rgb(98,98,98)\">16</span>,<span style=\"color:rgb(98,98,98)\">10</span>, act<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>),\n<span class=\"ansi-green-fg ansi-bold\">      7</span>     nn<span style=\"color:rgb(98,98,98)\">.</span>Flatten())<span style=\"color:rgb(98,98,98)\">.</span>to(def_device)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#36f77258 .cell execution_count=17}\n``` {.python .cell-code}\nopt = optim.SGD(cnn.parameters(), lr=lr)\nloss,acc = fit(5, cnn, F.cross_entropy, opt, dt, dv)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[17], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> opt <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">optim</span><span style=\"color:rgb(98,98,98)\">.</span>SGD(cnn<span style=\"color:rgb(98,98,98)\">.</span>parameters(), lr<span style=\"color:rgb(98,98,98)\">=</span>lr)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> loss,acc <span style=\"color:rgb(98,98,98)\">=</span> fit(<span style=\"color:rgb(98,98,98)\">5</span>, cnn, F<span style=\"color:rgb(98,98,98)\">.</span>cross_entropy, opt, dt, dv)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'optim' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4951845d .cell execution_count=18}\n``` {.python .cell-code}\ndsd['train'][0]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[18], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">dsd</span>[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">train</span><span style=\"color:rgb(175,0,0)\">'</span>][<span style=\"color:rgb(98,98,98)\">0</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dsd' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Autoencoder\n\n::: {#f83ee6ca .cell execution_count=19}\n``` {.python .cell-code}\ndef deconv(ni, nf, ks=3, act=True):\n    layers = [nn.UpsamplingNearest2d(scale_factor=2),\n              nn.Conv2d(ni, nf, stride=1, kernel_size=ks, padding=ks//2)]\n    if act: layers.append(nn.ReLU())\n    return nn.Sequential(*layers)\n```\n:::\n\n\n::: {#abdd4bed .cell execution_count=20}\n``` {.python .cell-code}\ndef eval(model, loss_func, valid_dl, epoch=0):\n    model.eval()\n    with torch.no_grad():\n        tot_loss,count = 0.,0\n        for xb,_ in valid_dl:\n            pred = model(xb)\n            n = len(xb)\n            count += n\n            tot_loss += loss_func(pred,xb).item()*n\n    print(epoch, f'{tot_loss/count:.3f}')\n```\n:::\n\n\n::: {#270b18f7 .cell execution_count=21}\n``` {.python .cell-code}\ndef fit(epochs, model, loss_func, opt, train_dl, valid_dl):\n    for epoch in range(epochs):\n        model.train()\n        for xb,_ in train_dl:\n            loss = loss_func(model(xb), xb)\n            loss.backward()\n            opt.step()\n            opt.zero_grad()\n        eval(model, loss_func, valid_dl, epoch)\n```\n:::\n\n\n::: {#e3d25328 .cell execution_count=22}\n``` {.python .cell-code}\nae = nn.Sequential(   #28x28\n    nn.ZeroPad2d(2),  #32x32\n    conv(1,2),        #16x16\n    conv(2,4),        #8x8\n#     conv(4,8),        #4x4\n#     deconv(8,4),      #8x8\n    deconv(4,2),      #16x16\n    deconv(2,1, act=False), #32x32\n    nn.ZeroPad2d(-2), #28x28\n    nn.Sigmoid()\n).to(def_device)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[22], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> ae <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">nn</span><span style=\"color:rgb(98,98,98)\">.</span>Sequential(   <span style=\"font-style:italic;color:rgb(95,135,135)\">#28x28</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     nn<span style=\"color:rgb(98,98,98)\">.</span>ZeroPad2d(<span style=\"color:rgb(98,98,98)\">2</span>),  <span style=\"font-style:italic;color:rgb(95,135,135)\">#32x32</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     conv(<span style=\"color:rgb(98,98,98)\">1</span>,<span style=\"color:rgb(98,98,98)\">2</span>),        <span style=\"font-style:italic;color:rgb(95,135,135)\">#16x16</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     conv(<span style=\"color:rgb(98,98,98)\">2</span>,<span style=\"color:rgb(98,98,98)\">4</span>),        <span style=\"font-style:italic;color:rgb(95,135,135)\">#8x8</span>\n<span class=\"ansi-green-fg ansi-bold\">      5</span> <span style=\"font-style:italic;color:rgb(95,135,135)\">#     conv(4,8),        #4x4</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span> <span style=\"font-style:italic;color:rgb(95,135,135)\">#     deconv(8,4),      #8x8</span>\n<span class=\"ansi-green-fg ansi-bold\">      7</span>     deconv(<span style=\"color:rgb(98,98,98)\">4</span>,<span style=\"color:rgb(98,98,98)\">2</span>),      <span style=\"font-style:italic;color:rgb(95,135,135)\">#16x16</span>\n<span class=\"ansi-green-fg ansi-bold\">      8</span>     deconv(<span style=\"color:rgb(98,98,98)\">2</span>,<span style=\"color:rgb(98,98,98)\">1</span>, act<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>), <span style=\"font-style:italic;color:rgb(95,135,135)\">#32x32</span>\n<span class=\"ansi-green-fg ansi-bold\">      9</span>     nn<span style=\"color:rgb(98,98,98)\">.</span>ZeroPad2d(<span style=\"color:rgb(98,98,98)\">-</span><span style=\"color:rgb(98,98,98)\">2</span>), <span style=\"font-style:italic;color:rgb(95,135,135)\">#28x28</span>\n<span class=\"ansi-green-fg ansi-bold\">     10</span>     nn<span style=\"color:rgb(98,98,98)\">.</span>Sigmoid()\n<span class=\"ansi-green-fg ansi-bold\">     11</span> )<span style=\"color:rgb(98,98,98)\">.</span>to(def_device)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'nn' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#09beff41 .cell execution_count=23}\n``` {.python .cell-code}\neval(ae, F.mse_loss, dv)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[23], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">eval</span>(<span class=\"ansi-yellow-bg\">ae</span>, F<span style=\"color:rgb(98,98,98)\">.</span>mse_loss, dv)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'ae' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b9b74d42 .cell execution_count=24}\n``` {.python .cell-code}\nopt = optim.SGD(ae.parameters(), lr=0.01)\nfit(5, ae, F.mse_loss, opt, dt, dv)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[24], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> opt <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">optim</span><span style=\"color:rgb(98,98,98)\">.</span>SGD(ae<span style=\"color:rgb(98,98,98)\">.</span>parameters(), lr<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">0.01</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> fit(<span style=\"color:rgb(98,98,98)\">5</span>, ae, F<span style=\"color:rgb(98,98,98)\">.</span>mse_loss, opt, dt, dv)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'optim' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2b5b48c4 .cell execution_count=25}\n``` {.python .cell-code}\nopt = optim.SGD(ae.parameters(), lr=0.1)\nfit(5, ae, F.mse_loss, opt, dt, dv)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[25], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> opt <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">optim</span><span style=\"color:rgb(98,98,98)\">.</span>SGD(ae<span style=\"color:rgb(98,98,98)\">.</span>parameters(), lr<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">0.1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> fit(<span style=\"color:rgb(98,98,98)\">5</span>, ae, F<span style=\"color:rgb(98,98,98)\">.</span>mse_loss, opt, dt, dv)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'optim' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#43e85acc .cell execution_count=26}\n``` {.python .cell-code}\np = ae(xb)\nshow_images(p[:16].data.cpu(), imsize=1.5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[26], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> p <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">ae</span>(xb)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_images(p[:<span style=\"color:rgb(98,98,98)\">16</span>]<span style=\"color:rgb(98,98,98)\">.</span>data<span style=\"color:rgb(98,98,98)\">.</span>cpu(), imsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1.5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'ae' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#3b811274 .cell execution_count=27}\n``` {.python .cell-code}\np = ae(xb)\nshow_images(p[:16].data.cpu(), imsize=1.5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[27], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> p <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">ae</span>(xb)\n<span class=\"ansi-green-fg ansi-bold\">      2</span> show_images(p[:<span style=\"color:rgb(98,98,98)\">16</span>]<span style=\"color:rgb(98,98,98)\">.</span>data<span style=\"color:rgb(98,98,98)\">.</span>cpu(), imsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1.5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'ae' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#62d8a3ed .cell execution_count=28}\n``` {.python .cell-code}\nshow_images(xb[:16].data.cpu(), imsize=1.5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[28], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">show_images</span>(xb[:<span style=\"color:rgb(98,98,98)\">16</span>]<span style=\"color:rgb(98,98,98)\">.</span>data<span style=\"color:rgb(98,98,98)\">.</span>cpu(), imsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1.5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'show_images' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n",
    "supporting": [
      "08_autoencoder_files"
    ],
    "filters": [],
    "includes": {}
  }
}