<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oren Bochman">
<meta name="dcterms.date" content="2021-05-16">
<meta name="description" content="Different Multilevel Models Types">

<title>Oren Bochman’s Blog - Multilevel Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<style>html{ scroll-behavior: smooth; }</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta name="twitter:title" content="Oren Bochman’s Blog - Multilevel Models">
<meta name="twitter:description" content="Different Multilevel Models Types">
<meta name="twitter:image" content="https://orenbochman.github.io/blog/posts/2021/2021-05-16-mulitlevel-models/notes-formulas.jpg">
<meta name="twitter:creator" content="@orenbochman">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Oren Bochman’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-book" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-book" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bi-book">    
        <li>
    <a class="dropdown-item" href="../../../dnn.html">
 <span class="dropdown-text">Neural Networks for Machine Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../model-thinking.html">
 <span class="dropdown-text">Model Thinking</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/orenbochman"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/OrenBochman/blog">
 <span class="dropdown-text">Source Code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/OrenBochman/blog/issues">
 <span class="dropdown-text">Report a Bug</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="../../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../archive.html"> <i class="bi bi-archive" role="img">
</i> 
<span class="menu-text">Archive</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Multilevel Models</h1>
                  <div>
        <div class="description">
          Different Multilevel Models Types
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">NLP</div>
                <div class="quarto-category">notes</div>
                <div class="quarto-category">summarization task</div>
                <div class="quarto-category">lecture notes</div>
                <div class="quarto-category">bibliography</div>
                <div class="quarto-category">literature review</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Oren Bochman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 16, 2021</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">April 24, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#fundamental-concepts" id="toc-fundamental-concepts" class="nav-link active" data-scroll-target="#fundamental-concepts">Fundamental Concepts:</a></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data">The Data</a>
  <ul class="collapse">
  <li><a href="#plate-notation-remainder" id="toc-plate-notation-remainder" class="nav-link" data-scroll-target="#plate-notation-remainder">Plate notation remainder:</a></li>
  </ul></li>
  <li><a href="#complete-pooling-model" id="toc-complete-pooling-model" class="nav-link" data-scroll-target="#complete-pooling-model">Complete Pooling Model:</a></li>
  <li><a href="#non-pooling-model" id="toc-non-pooling-model" class="nav-link" data-scroll-target="#non-pooling-model">Non-Pooling Model:</a></li>
  <li><a href="#multilevel-and-hierarchical-models" id="toc-multilevel-and-hierarchical-models" class="nav-link" data-scroll-target="#multilevel-and-hierarchical-models">Multilevel and Hierarchical models</a>
  <ul class="collapse">
  <li><a href="#partial-pooling" id="toc-partial-pooling" class="nav-link" data-scroll-target="#partial-pooling">Partial Pooling</a></li>
  <li><a href="#varying-intercepts" id="toc-varying-intercepts" class="nav-link" data-scroll-target="#varying-intercepts">Varying Intercepts</a></li>
  <li><a href="#varying-slopes" id="toc-varying-slopes" class="nav-link" data-scroll-target="#varying-slopes">Varying Slopes</a></li>
  <li><a href="#varying-intercepts-and-slopes" id="toc-varying-intercepts-and-slopes" class="nav-link" data-scroll-target="#varying-intercepts-and-slopes">Varying Intercepts and Slopes</a></li>
  <li><a href="#hierarchical-intercepts-and-slopes" id="toc-hierarchical-intercepts-and-slopes" class="nav-link" data-scroll-target="#hierarchical-intercepts-and-slopes">Hierarchical Intercepts and Slopes</a></li>
  <li><a href="#correlation-amongst-levels" id="toc-correlation-amongst-levels" class="nav-link" data-scroll-target="#correlation-amongst-levels">Correlation amongst levels</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">7 Conclusions</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<blockquote class="blockquote">
<p>Multilevel (hierarchical) modeling is a generalization of linear and generalized linear modeling in which regression coefficients are themselves given a model, whose parameters are also estimated from data. We illustrate the strengths and limitations of multilevel modeling through an example of the prediction of home radon levels in U.S. counties. The multilevel model is highly effective for predictions at both levels of the model, but could easily be misinterpreted for causal inference. Gelman, A. (2006).</p>
</blockquote>
<section id="fundamental-concepts" class="level2">
<h2 class="anchored" data-anchor-id="fundamental-concepts">Fundamental Concepts:</h2>
<p><a href="https://stats.stackexchange.com/questions/4700/what-is-the-difference-between-fixed-effect-random-effect-and-mixed-effect-mode#:~:text=Fixed%20effects%20are%20constant%20across,between%20fixed%20and%20random%20coefficients.">What is the difference between fixed effect, random effect and mixed effect models?</a></p>
<ul>
<li>Under the <strong>Fixed Effect</strong> model we assume that the true effect size for all individuals is identical, and the only reason the effect size varies between studies is sampling error (error in estimating the effect size). Fixed effects are estimated using least squares (or, more generally, maximum likelihood)</li>
<li>Under the <strong>Random Effect</strong> or Population Average Effects* model we assume that the true effect size varies for each individuals and has a population statistic. random effects are estimated with shrinkage (“linear unbiased prediction” in the terminology of Robinson, 1991)</li>
<li>Multilevel (hierarchical) models get their name from their functional form which relates higher level features depend on the lower level ones.</li>
<li><strong>Pooling</strong></li>
<li><strong>Shrinkage</strong> AKA <strong>Partial-Pooling</strong> county specific means are pulled toward the population mean. More generally shrinkage is predictions shifting towards the population average. See <a href="https://m-clark.github.io/posts/2019-05-14-shrinkage-in-mixed-models/">Shrinkage in Mixed Effects Models</a></li>
<li>Smoothing of uncertainty: Uncertainty about the county-specific means is lower (sometimes much lower) than if these parameters were estimated independently. (Better than the non-pooling model)</li>
<li><strong>Proportional borrowing of information</strong>: <em>Shrinkage</em> and <em>uncertainty</em> reduction do not occur uniformly - information-poor counties must borrow a great deal of information from the other counties, while information-rich counties do not.</li>
<li>non-IID or <strong>Multicolinearity</strong> - Multilevel models can handle data at different levels that would be</li>
<li>Homoscedasticity of the data can be handled by the model (when gradients are allowed to vary).</li>
</ul>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The Data</h2>
<p>This is based on the dataset from ‘Radon contamination’ (Gelman and Hill 2006). Radon is a radiactive gas that is a by product of radioactive decay of uranium within the soil. The EPA did a study of radon levels in 80,000 houses. The two important predictors are:</p>
<ol type="1">
<li>Measurement in the basement or the first floor (radon higher in basements)</li>
<li>County uranium level (positive correlation with radon levels).</li>
</ol>
<p>The ‘natural’ hierarchy in the data is:</p>
<ol type="1">
<li>the state</li>
<li>county level,</li>
<li>house.</li>
</ol>
<p>In these different models we are considering how to share information on within and between groups. This sharing of data is called pooling and is a type of learning mechanism. (It is the same pooling from game theory’s pooling equilibrium.)</p>
<p>One way to organize the different models is by increasing number of parameters.</p>
<section id="plate-notation-remainder" class="level3">
<h3 class="anchored" data-anchor-id="plate-notation-remainder">Plate notation remainder:</h3>
<p>Recall that plate notation is used in bayesian graphical model with repeating entities:</p>
<ul>
<li>arrows indicate a dependency relation.</li>
<li>filled nodes are observed variables.</li>
<li>empty nodes are latent variables</li>
<li>small nodes are parameters</li>
<li>nodes in plates/boxes with index = N repeat N times.</li>
</ul>
</section>
</section>
<section id="complete-pooling-model" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="complete-pooling-model">Complete Pooling Model:</h2>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="pooled-plate-model.png" class="lightbox page-columns page-full" data-glightbox="description: .lightbox-desc-1" data-gallery="quarto-lightbox-gallery-1" title="pooled-plate-model"><div class="no-row-height column-margin column-container"><img src="pooled-plate-model.png" class="img-fluid figure-img" alt="pooled-plate-model"></div></a></p>
<figcaption>pooled-plate-model</figcaption>
</figure>
</div>
<p>This is the simplest of all where one treat all counties the same, and estimate a single radon level.</p>
<p>The is a parametric model with 2 parameters, with alpha giving state wide radon level at the basements and <span class="math inline">\beta</span> the adjustment for going up a floor (there are only two floor and beta is the gradient associated with drop of levels when going up a floor.)</p>
<p><span class="math display">y_i=\alpha + \beta x_i + \epsilon_i</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">i</span> is the house number (919)</li>
<li><span class="math inline">x</span> is the floor of the house</li>
<li><span class="math inline">y</span> log radon level</li>
<li><span class="math inline">\alpha</span> is the intercept parameter corresponding to a base radon level. In this model it’s a fixed effect across all counties.</li>
<li><span class="math inline">\beta</span> gradient parameter - corresponding to drop of radon level between floors. Again it’s a fixed effect across all counties.</li>
<li><span class="math inline">\epsilon</span> is an error term may represent measurement error, temporal within-house variation, or variation among houses.</li>
</ul>
<p>the model model:</p>
<ul>
<li><span class="math inline">\alpha</span> ~ <span class="math inline">N(0,10^5)</span></li>
<li><span class="math inline">\beta</span> ~ <span class="math inline">N(0,10^5)</span></li>
<li><span class="math inline">\sigma</span> ~ <span class="math inline">HalfCauchy(0,5)</span></li>
<li><span class="math inline">y_i</span> ~ $N(+ x_i,^2) $</li>
</ul>
<p>The main issue with this model is that is ignores variation between counties. When we pool our data, we lose the information that different data points came from different counties. This means that each radon-level observation is sampled from the same probability distribution. Such a model fails to learn any variation in the sampling unit that is inherent within a group (e.g.&nbsp;a county). It only accounts for sampling variance.</p>
</section>
<section id="non-pooling-model" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="non-pooling-model">Non-Pooling Model:</h2>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="unpooled-plate-model.png" class="lightbox page-columns page-full" data-glightbox="description: .lightbox-desc-2" data-gallery="quarto-lightbox-gallery-2" title="unpooled-plate-model"><div class="no-row-height column-margin column-container"><img src="unpooled-plate-model.png" class="img-fluid figure-img" alt="unpooled-plate-model"></div></a></p>
<figcaption>unpooled-plate-model</figcaption>
</figure>
</div>
<p>Model radon in each county independently.</p>
<p><span class="math display">
y_i=\alpha_{j[i]} + \beta x_{j[i]} + \epsilon_i
</span></p>
<p>where where:</p>
<ul>
<li>j is the county number (1,…,85)</li>
<li>i is the house number (1,…,919) - though just the ones in the county</li>
<li>x is the floor of the house</li>
<li>y log radon measurement</li>
<li><span class="math inline">\alpha</span> intercept or bias parameter</li>
<li><span class="math inline">\beta</span> gradient parameter</li>
<li><span class="math inline">\epsilon</span> error term</li>
</ul>
<p>we model:</p>
<ul>
<li>[ <span class="math inline">\alpha_j</span> ~ <span class="math inline">N(0,10^5)</span> for j in counties]</li>
<li>[ <span class="math inline">y_i</span> ~ $N $ for i in houses ] with parameters:
<ul>
<li><span class="math inline">\beta</span> ~ <span class="math inline">N(0,10^5)</span></li>
<li><span class="math inline">\sigma</span> ~ <span class="math inline">HalfCauchy(0,5)</span></li>
</ul></li>
</ul>
<p>providing us with a parametric model with 920 parameters.</p>
<p>Next one would use MCMC to learn which parameters minimize the total error.</p>
<p>The main issue with this model is that there are lots of parameters and in some counties very few point to estimate them. (for some just two). The unpolled estimates are difficult to trust.</p>
<p>When we analyze data unpooled, we imply that they are sampled independently from separate models. At the opposite extreme from the pooled case, this approach claims that differences between sampling units are too large to combine them:</p>
</section>
<section id="multilevel-and-hierarchical-models" class="level1 page-columns page-full">
<h1>Multilevel and Hierarchical models</h1>
<section id="partial-pooling" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="partial-pooling">Partial Pooling</h2>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="partialy-pooled-plate-model.png" class="lightbox page-columns page-full" data-glightbox="description: .lightbox-desc-3" data-gallery="quarto-lightbox-gallery-3" title="partially-pooled-plate-model"><div class="no-row-height column-margin column-container"><img src="partialy-pooled-plate-model.png" class="img-fluid figure-img" alt="partially-pooled-plate-model"></div></a></p>
<figcaption>partially-pooled-plate-model</figcaption>
</figure>
</div>
<p>In a hierarchical model, parameters are viewed as a <strong>sample from a population distribution of parameters</strong> considering them as neither entirely different or exactly the same. This is known as <em>partial pooling</em>.</p>
<p>recall: <span class="math display">y_i=\alpha_{j[i]} + \beta x_{j[i]} + \epsilon_i</span></p>
<p>we now want to estimate an county level using a weighed average between the county level and the over all level average. <span class="math display">\hat{\alpha}_j \approx \frac{(n_j/\sigma_y^2)\bar{y}_j +
(1/\sigma_{\alpha}^2)\bar{y}}{(n_j/\sigma_y^2) + (1/\sigma_{\alpha}^2)}</span></p>
<p>where where:</p>
<ul>
<li>j is the county number (1,…,85)</li>
<li>i is the house number (1,…,919) - though just the ones in the county</li>
<li>y log radon measurement</li>
<li><span class="math inline">\alpha</span> intercept or bias parameter</li>
<li><span class="math inline">\beta</span> gradient parameter</li>
<li><span class="math inline">\epsilon</span> error term</li>
</ul>
<p>we model:</p>
<ul>
<li>[ <span class="math inline">\alpha_j</span> ~ <span class="math inline">N(\mu_a,\sigma_a)</span> for j in counties] with parameters:
<ul>
<li><span class="math inline">\mu_a</span> ~ <span class="math inline">N(0,10^5)</span>]</li>
<li><span class="math inline">\sigma_a</span> ~ <span class="math inline">HalfCauchy(0,5)</span></li>
</ul></li>
<li>[ <span class="math inline">y_i</span> ~ $N $ for i in houses ] with parameters:
<ul>
<li><span class="math inline">\mu_y</span> ~ <span class="math inline">N(0,10^5)</span>] (ignored)</li>
<li><span class="math inline">\sigma_y</span> ~ <span class="math inline">HalfCauchy(0,5)</span></li>
</ul></li>
</ul>
<p>With partial pooling one expects:</p>
<ul>
<li>Estimates for counties with smaller sample sizes will shrink towards the state-wide average.</li>
<li>Estimates for counties with larger sample sizes will be closer to the unpooled county estimates.</li>
</ul>
</section>
<section id="varying-intercepts" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="varying-intercepts">Varying Intercepts</h2>
<p class="page-columns page-full"><a href="varying-intercepts-plate-model.png" class="lightbox page-columns page-full" data-gallery="quarto-lightbox-gallery-4"><div class="no-row-height column-margin column-container"><img src="varying-intercepts-plate-model.png" class="img-fluid"></div></a></p>
<p>We now a consider a more complex model that allows intercepts to vary across county, according to a <strong>random effect</strong>.</p>
<p><span class="math display">
y_i = \alpha_{j[i]} + \beta x_{i} + \epsilon_i
</span></p>
<p>where</p>
<p><span class="math display">
\epsilon_i \sim N(0, \sigma_y^2)
</span></p>
<p>and the intercept random effect:</p>
<p><span class="math display">
\alpha_{j[i]} \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)
</span></p>
<p>The slope <span class="math inline">\beta</span>, which lets the observation vary according to the location of measurement (basement or first floor), is still a fixed effect shared between different counties. As with the the unpooling model, we set a separate intercept for each county, but rather than fitting separate least squares regression models for each county, multilevel modeling <em>shares strength</em> among counties, allowing for more reasonable inference in counties with little data.</p>
</section>
<section id="varying-slopes" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="varying-slopes">Varying Slopes</h2>
<p class="page-columns page-full"><a href="varying-slopes-plate-model.png" class="lightbox page-columns page-full" data-gallery="quarto-lightbox-gallery-5"><div class="no-row-height column-margin column-container"><img src="varying-slopes-plate-model.png" class="img-fluid"></div></a></p>
<p>In this model, one posits that counties vary according to how the location of measurement (basement or first floor) influences the radon reading. In this case the intercept <span class="math inline">\alpha</span> is shared between counties.</p>
<p><span class="math display">
y_i = \alpha + \beta_{j[i]} x_{i} + \epsilon_i
</span></p>
<ul>
<li><span class="math inline">j</span> is the county number. (1,…,85)</li>
<li><span class="math inline">i</span> is the house number. (1,…,919) - though just the ones in the county</li>
<li><span class="math inline">x</span> (0 for basement 1 for 1st) floor of the house.</li>
<li><span class="math inline">y</span> log radon measurement</li>
<li><span class="math inline">\alpha</span> intercept parameter corresponding to a base radon level fixed across all counties.</li>
<li><span class="math inline">\beta</span> gradient parameter - corresponding to drop of radon level between floors</li>
<li><span class="math inline">\epsilon_i</span> error term considered at the house level.</li>
</ul>
</section>
<section id="varying-intercepts-and-slopes" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="varying-intercepts-and-slopes">Varying Intercepts and Slopes</h2>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="varying-intercepts-and-slopes-plate-model.png" class="lightbox page-columns page-full" data-glightbox="description: .lightbox-desc-6" data-gallery="quarto-lightbox-gallery-6" title="varying-intercepts-and-slopes-plate-model"><div class="no-row-height column-margin column-container"><img src="varying-intercepts-and-slopes-plate-model.png" class="img-fluid figure-img" alt="varying-intercepts-and-slopes-plate-model"></div></a></p>
<figcaption>varying-intercepts-and-slopes-plate-model</figcaption>
</figure>
</div>
<p>note: the plate model would be clearer if a and b were in the same plate making the level more explicit.</p>
<p>The most general model allows both the intercept and slope to vary by county:</p>
<p><span class="math display">
y_i = \alpha_{j[i]} + \beta_{j[i]} x_{i} + \epsilon_i
</span></p>
<p>where:</p>
<ul>
<li>j is the county number. (1,…,85)</li>
<li>i is the house number. (1,…,919) - though just the ones in the county</li>
<li>x (0 for basement 1 for 1st) floor of the house.</li>
<li>y log radon measurement</li>
<li><span class="math inline">\alpha_{ji}</span> intercept parameter (corresponding to a base radon level) partially pooled across all counties.</li>
<li><span class="math inline">\beta_{ji}</span> gradient parameter (corresponding to drop of radon level between floors) partially pooled across all counties.</li>
<li><span class="math inline">\epsilon_i</span> error term considered at the house level.</li>
</ul>
</section>
<section id="hierarchical-intercepts-and-slopes" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="hierarchical-intercepts-and-slopes">Hierarchical Intercepts and Slopes</h2>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="hierarchical-intercepts-model.png" class="lightbox page-columns page-full" data-glightbox="description: .lightbox-desc-7" data-gallery="quarto-lightbox-gallery-7" title="hierarchical-intercepts-model"><div class="no-row-height column-margin column-container"><img src="hierarchical-intercepts-model.png" class="img-fluid figure-img" alt="hierarchical-intercepts-model"></div></a></p>
<figcaption>hierarchical-intercepts-model</figcaption>
</figure>
</div>
<p>A primary strength of multilevel models is the ability to handle predictors on multiple levels simultaneously. If we consider the varying-intercepts model above:</p>
<p><span class="math display">
y_i = \alpha_{j[i]} + \beta x_{i} + \epsilon_i
</span></p>
<p>we may, instead of a simple random effect to describe variation in the expected radon value, specify another regression model with a county-level covariate. Here, we use the county uranium reading <span class="math inline">u_j</span>, which is thought to be related to radon levels:</p>
<p><span class="math display">
\alpha_j = \gamma_0 + \gamma_1 u_j + \zeta_j
</span></p>
<p><span class="math display">
\zeta_j \sim N(0,\sigma_{\alpha}^2)
</span></p>
<p>Thus, we are now incorporating a house-level predictor (floor or basement) as well as a county-level predictor (uranium).</p>
<p>Note that the model has both indicator variables for each county, plus a county-level covariate.</p>
<p>In classical regression, this would result in collinearity. In a multilevel model, the partial pooling of the intercepts towards the expected value of the group-level linear model avoids this.</p>
<p>Group-level predictors also serve to reduce group-level variation <span class="math inline">\sigma_{\alpha}</span>. An important implication of this is that the group-level estimate induces stronger pooling.</p>
</section>
<section id="correlation-amongst-levels" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="correlation-amongst-levels">Correlation amongst levels</h2>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="correlations-among-levels-plate-model.png" class="lightbox page-columns page-full" data-glightbox="description: .lightbox-desc-8" data-gallery="quarto-lightbox-gallery-8" title="correlations-among-levels-plate-model"><div class="no-row-height column-margin column-container"><img src="correlations-among-levels-plate-model.png" class="img-fluid figure-img" alt="correlations-among-levels-plate-model"></div></a></p>
<figcaption>correlations-among-levels-plate-model</figcaption>
</figure>
</div>
<p>In some instances, having predictors at multiple levels can reveal correlation between individual-level variables and group residuals. We can account for this by including the average of the individual predictors as a covariate in the model for the group intercept.</p>
<p><span class="math display">
\alpha_j = \gamma_0 + \gamma_1 u_j + \gamma_2 \bar{x} + \zeta_j
</span></p>
<p>These are broadly referred to as <strong>contextual effects</strong>.</p>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">7 Conclusions</h2>
<p>Benefits of Multilevel Models:</p>
<ul>
<li>Accounting for natural hierarchical structure of observational data.</li>
<li>Estimation of coefficients for (under-represented) groups.</li>
<li>Incorporating individual- and group-level information when estimating group-level coefficients.</li>
<li>Allowing for variation among individual-level coefficients across groups.</li>
</ul>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li>Gelman, A., &amp; Hill, J. (2006). Data Analysis Using Regression and Multilevel/Hierarchical Models (1st ed.). Cambridge University Press.</li>
<li>Gelman, A. (2006). Multilevel (Hierarchical) modeling: what it can and cannot do. Technometrics, 48(3), 432–435.</li>
</ul>


<div class="hidden" aria-hidden="true">
<span class="glightbox-desc lightbox-desc-1">pooled-plate-model</span>
<span class="glightbox-desc lightbox-desc-2">unpooled-plate-model</span>
<span class="glightbox-desc lightbox-desc-3">partially-pooled-plate-model</span>
<span class="glightbox-desc lightbox-desc-6">varying-intercepts-and-slopes-plate-model</span>
<span class="glightbox-desc lightbox-desc-7">hierarchical-intercepts-model</span>
<span class="glightbox-desc lightbox-desc-8">correlations-among-levels-plate-model</span>
</div>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{bochman2021,
  author = {Bochman, Oren},
  title = {Multilevel {Models}},
  date = {2021-05-16},
  url = {https://orenbochman.github.io/blog//posts/2021/2021-05-16-mulitlevel-models/2021-05-16-mulitlevel-models.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-bochman2021" class="csl-entry quarto-appendix-citeas" role="listitem">
Bochman, Oren. 2021. <span>“Multilevel Models.”</span> May 16, 2021. <a href="https://orenbochman.github.io/blog//posts/2021/2021-05-16-mulitlevel-models/2021-05-16-mulitlevel-models.html">https://orenbochman.github.io/blog//posts/2021/2021-05-16-mulitlevel-models/2021-05-16-mulitlevel-models.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="OrenBochman/blogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Copyright 2024, Oren Bochman
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../about.html">
<p>About</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../license.html">
<p>License</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../trademark.html">
<p>Trademark</p>
</a>
  </li>  
</ul>
    <div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"openEffect":"zoom","closeEffect":"zoom","selector":".lightbox","descPosition":"bottom","loop":false});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>