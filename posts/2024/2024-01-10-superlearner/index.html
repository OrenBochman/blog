<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oren Bochman">
<meta name="dcterms.date" content="2024-01-10">

<title>Oren Bochman’s Blog - SuperLearner</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<style>html{ scroll-behavior: smooth; }</style>


<meta name="twitter:title" content="Oren Bochman’s Blog - SuperLearner">
<meta name="twitter:description" content="Personal website, portfolio and blog">
<meta name="twitter:image" content="https://orenbochman.github.io/blog/posts/2024/2024-01-10-superlearner/thumbnail_blog.png">
<meta name="twitter:creator" content="@orenbochman">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Oren Bochman’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-book" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-book" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bi-book">    
        <li>
    <a class="dropdown-item" href="../../../dnn.html">
 <span class="dropdown-text">Neural Networks for Machine Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../model-thinking.html">
 <span class="dropdown-text">Model Thinking</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../xai.html">
 <span class="dropdown-text">XAI</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../rl.html">
 <span class="dropdown-text">rl</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../rhetoric.html">
 <span class="dropdown-text">rhetoric</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../tfp.html">
 <span class="dropdown-text">TFP</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../ab-testing.html">
 <span class="dropdown-text">AB testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../cognitiveai.html">
 <span class="dropdown-text">cognitive AI</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/orenbochman"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/OrenBochman/blog">
 <span class="dropdown-text">Source Code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/OrenBochman/blog/issues">
 <span class="dropdown-text">Report a Bug</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="../../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../archive.html"> <i class="bi bi-archive" role="img">
</i> 
<span class="menu-text">Archive</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">SuperLearner</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">demos</div>
                <div class="quarto-category">code</div>
                <div class="quarto-category">r</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Oren Bochman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 10, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup-dataset" id="toc-setup-dataset" class="nav-link active" data-scroll-target="#setup-dataset">Setup dataset</a></li>
  <li><a href="#review-available-models" id="toc-review-available-models" class="nav-link" data-scroll-target="#review-available-models">Review available models</a></li>
  <li><a href="#fit-individual-models" id="toc-fit-individual-models" class="nav-link" data-scroll-target="#fit-individual-models">Fit individual models</a></li>
  <li><a href="#fit-multiple-models" id="toc-fit-multiple-models" class="nav-link" data-scroll-target="#fit-multiple-models">Fit multiple models</a></li>
  <li><a href="#predict-on-new-data" id="toc-predict-on-new-data" class="nav-link" data-scroll-target="#predict-on-new-data">Predict on new data</a></li>
  <li><a href="#fit-ensemble-with-external-cross-validation" id="toc-fit-ensemble-with-external-cross-validation" class="nav-link" data-scroll-target="#fit-ensemble-with-external-cross-validation">Fit ensemble with external cross-validation</a>
  <ul class="collapse">
  <li><a href="#customize-a-model-hyperparameter" id="toc-customize-a-model-hyperparameter" class="nav-link" data-scroll-target="#customize-a-model-hyperparameter">Customize a model hyperparameter</a></li>
  <li><a href="#test-algorithm-with-multiple-hyperparameter-settings" id="toc-test-algorithm-with-multiple-hyperparameter-settings" class="nav-link" data-scroll-target="#test-algorithm-with-multiple-hyperparameter-settings">Test algorithm with multiple hyperparameter settings</a></li>
  <li><a href="#weight-distribution-for-superlearner" id="toc-weight-distribution-for-superlearner" class="nav-link" data-scroll-target="#weight-distribution-for-superlearner">Weight distribution for SuperLearner</a></li>
  <li><a href="#feature-selection-screening" id="toc-feature-selection-screening" class="nav-link" data-scroll-target="#feature-selection-screening">Feature selection (screening)</a></li>
  <li><a href="#optimize-for-auc" id="toc-optimize-for-auc" class="nav-link" data-scroll-target="#optimize-for-auc">Optimize for AUC</a></li>
  <li><a href="#xgboost-hyperparameter-exploration" id="toc-xgboost-hyperparameter-exploration" class="nav-link" data-scroll-target="#xgboost-hyperparameter-exploration">XGBoost hyperparameter exploration</a></li>
  <li><a href="#troubleshooting" id="toc-troubleshooting" class="nav-link" data-scroll-target="#troubleshooting">Troubleshooting</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>This is a SuperLearner demo.</p>
<p>SuperLearner is an ensableing library.</p>
<p>This page is taken out of the documenation</p>
<section id="setup-dataset" class="level2">
<h2 class="anchored" data-anchor-id="setup-dataset">Setup dataset</h2>
<div class="cell">
<div id="lst-mass-data-set" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;1: dataset setup
</figcaption>
<div aria-describedby="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-mass-data-set"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-mass-data-set-1"><a href="#lst-mass-data-set-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(c("SuperLearner","caret", "glmnet", "randomForest", "ggplot2", "RhpcBLASctl","xgboost","ranger"))</span></span>
<span id="lst-mass-data-set-2"><a href="#lst-mass-data-set-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Boston, <span class="at">package =</span> <span class="st">"MASS"</span>)</span>
<span id="lst-mass-data-set-3"><a href="#lst-mass-data-set-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-4"><a href="#lst-mass-data-set-4" aria-hidden="true" tabindex="-1"></a>?MASS<span class="sc">::</span>Boston  <span class="co"># Review info on the Boston dataset.&gt;</span></span>
<span id="lst-mass-data-set-5"><a href="#lst-mass-data-set-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-6"><a href="#lst-mass-data-set-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(Boston)) <span class="co"># Check for any missing data - looks like we don't have any.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   crim      zn   indus    chas     nox      rm     age     dis     rad     tax 
      0       0       0       0       0       0       0       0       0       0 
ptratio   black   lstat    medv 
      0       0       0       0 </code></pre>
</div>
<div id="lst-mass-data-set" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;2: dataset setup
</figcaption>
<div aria-describedby="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-mass-data-set"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-mass-data-set-1"><a href="#lst-mass-data-set-1" aria-hidden="true" tabindex="-1"></a>outcome <span class="ot">=</span> Boston<span class="sc">$</span>medv <span class="co">#Extract our outcome variable from the dataframe.</span></span>
<span id="lst-mass-data-set-2"><a href="#lst-mass-data-set-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-3"><a href="#lst-mass-data-set-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">subset</span>(Boston, <span class="at">select =</span> <span class="sc">-</span>medv) <span class="co"># Create a dataframe to contain our explanatory variables.</span></span>
<span id="lst-mass-data-set-4"><a href="#lst-mass-data-set-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 3%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">crim</th>
<th style="text-align: right;">zn</th>
<th style="text-align: right;">indus</th>
<th style="text-align: right;">chas</th>
<th style="text-align: right;">nox</th>
<th style="text-align: right;">rm</th>
<th style="text-align: right;">age</th>
<th style="text-align: right;">dis</th>
<th style="text-align: right;">rad</th>
<th style="text-align: right;">tax</th>
<th style="text-align: right;">ptratio</th>
<th style="text-align: right;">black</th>
<th style="text-align: right;">lstat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.00632</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">2.31</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.538</td>
<td style="text-align: right;">6.575</td>
<td style="text-align: right;">65.2</td>
<td style="text-align: right;">4.0900</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">296</td>
<td style="text-align: right;">15.3</td>
<td style="text-align: right;">396.90</td>
<td style="text-align: right;">4.98</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.02731</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7.07</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.469</td>
<td style="text-align: right;">6.421</td>
<td style="text-align: right;">78.9</td>
<td style="text-align: right;">4.9671</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">17.8</td>
<td style="text-align: right;">396.90</td>
<td style="text-align: right;">9.14</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.02729</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7.07</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.469</td>
<td style="text-align: right;">7.185</td>
<td style="text-align: right;">61.1</td>
<td style="text-align: right;">4.9671</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">17.8</td>
<td style="text-align: right;">392.83</td>
<td style="text-align: right;">4.03</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.03237</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2.18</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.458</td>
<td style="text-align: right;">6.998</td>
<td style="text-align: right;">45.8</td>
<td style="text-align: right;">6.0622</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">222</td>
<td style="text-align: right;">18.7</td>
<td style="text-align: right;">394.63</td>
<td style="text-align: right;">2.94</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.06905</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2.18</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.458</td>
<td style="text-align: right;">7.147</td>
<td style="text-align: right;">54.2</td>
<td style="text-align: right;">6.0622</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">222</td>
<td style="text-align: right;">18.7</td>
<td style="text-align: right;">396.90</td>
<td style="text-align: right;">5.33</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.02985</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2.18</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.458</td>
<td style="text-align: right;">6.430</td>
<td style="text-align: right;">58.7</td>
<td style="text-align: right;">6.0622</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">222</td>
<td style="text-align: right;">18.7</td>
<td style="text-align: right;">394.12</td>
<td style="text-align: right;">5.21</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="lst-mass-data-set" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;3: dataset setup
</figcaption>
<div aria-describedby="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-mass-data-set"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-mass-data-set-1"><a href="#lst-mass-data-set-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(data) <span class="co"># Check structure of our dataframe.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   506 obs. of  13 variables:
 $ crim   : num  0.00632 0.02731 0.02729 0.03237 0.06905 ...
 $ zn     : num  18 0 0 0 0 0 12.5 12.5 12.5 12.5 ...
 $ indus  : num  2.31 7.07 7.07 2.18 2.18 2.18 7.87 7.87 7.87 7.87 ...
 $ chas   : int  0 0 0 0 0 0 0 0 0 0 ...
 $ nox    : num  0.538 0.469 0.469 0.458 0.458 0.458 0.524 0.524 0.524 0.524 ...
 $ rm     : num  6.58 6.42 7.18 7 7.15 ...
 $ age    : num  65.2 78.9 61.1 45.8 54.2 58.7 66.6 96.1 100 85.9 ...
 $ dis    : num  4.09 4.97 4.97 6.06 6.06 ...
 $ rad    : int  1 2 2 3 3 3 5 5 5 5 ...
 $ tax    : num  296 242 242 222 222 222 311 311 311 311 ...
 $ ptratio: num  15.3 17.8 17.8 18.7 18.7 18.7 15.2 15.2 15.2 15.2 ...
 $ black  : num  397 397 393 395 397 ...
 $ lstat  : num  4.98 9.14 4.03 2.94 5.33 ...</code></pre>
</div>
<div id="lst-mass-data-set" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;4: dataset setup
</figcaption>
<div aria-describedby="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-mass-data-set"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-mass-data-set-1"><a href="#lst-mass-data-set-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(data) <span class="co"># Review our dimensions.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 506  13</code></pre>
</div>
<div id="lst-mass-data-set" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;5: dataset setup
</figcaption>
<div aria-describedby="lst-mass-data-set-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-mass-data-set"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-mass-data-set-1"><a href="#lst-mass-data-set-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)<span class="co"># Set a seed for reproducibility in this random sampling.</span></span>
<span id="lst-mass-data-set-2"><a href="#lst-mass-data-set-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-3"><a href="#lst-mass-data-set-3" aria-hidden="true" tabindex="-1"></a>train_obs <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="dv">150</span>) <span class="co"># Reduce to a dataset of 150 observations to speed up model fitting.</span></span>
<span id="lst-mass-data-set-4"><a href="#lst-mass-data-set-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-5"><a href="#lst-mass-data-set-5" aria-hidden="true" tabindex="-1"></a>x_train <span class="ot">=</span> data[train_obs, ] <span class="co"># X is our training sample.</span></span>
<span id="lst-mass-data-set-6"><a href="#lst-mass-data-set-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-7"><a href="#lst-mass-data-set-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-8"><a href="#lst-mass-data-set-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-9"><a href="#lst-mass-data-set-9" aria-hidden="true" tabindex="-1"></a>x_holdout <span class="ot">=</span> data[<span class="sc">-</span>train_obs, ] <span class="co"># Create a holdout set for evaluating model performance.</span></span>
<span id="lst-mass-data-set-10"><a href="#lst-mass-data-set-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: cross-validation is even better than a single holdout sample.</span></span>
<span id="lst-mass-data-set-11"><a href="#lst-mass-data-set-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-12"><a href="#lst-mass-data-set-12" aria-hidden="true" tabindex="-1"></a>outcome_bin <span class="ot">=</span> <span class="fu">as.numeric</span>(outcome <span class="sc">&gt;</span> <span class="dv">22</span>) <span class="co"># Create a binary outcome variable: towns in which median home value is &gt; 22,000.</span></span>
<span id="lst-mass-data-set-13"><a href="#lst-mass-data-set-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-14"><a href="#lst-mass-data-set-14" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">=</span> outcome_bin[train_obs]</span>
<span id="lst-mass-data-set-15"><a href="#lst-mass-data-set-15" aria-hidden="true" tabindex="-1"></a>y_holdout <span class="ot">=</span> outcome_bin[<span class="sc">-</span>train_obs]</span>
<span id="lst-mass-data-set-16"><a href="#lst-mass-data-set-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-17"><a href="#lst-mass-data-set-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-mass-data-set-18"><a href="#lst-mass-data-set-18" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(y_train, <span class="at">useNA =</span> <span class="st">"ifany"</span>) <span class="co"># Review the outcome variable distribution.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>y_train
 0  1 
92 58 </code></pre>
</div>
</div>
</section>
<section id="review-available-models" class="level2">
<h2 class="anchored" data-anchor-id="review-available-models">Review available models</h2>
<div class="cell">
<div id="lst-model-review" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-review-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;6: model review
</figcaption>
<div aria-describedby="lst-model-review-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-review"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-review-1"><a href="#lst-model-review-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="lst-model-review-2"><a href="#lst-model-review-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-model-review-3"><a href="#lst-model-review-3" aria-hidden="true" tabindex="-1"></a><span class="fu">listWrappers</span>() <span class="co"># Review available models.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>All prediction algorithm wrappers in SuperLearner:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "SL.bartMachine"      "SL.bayesglm"         "SL.biglasso"        
 [4] "SL.caret"            "SL.caret.rpart"      "SL.cforest"         
 [7] "SL.earth"            "SL.gam"              "SL.gbm"             
[10] "SL.glm"              "SL.glm.interaction"  "SL.glmnet"          
[13] "SL.ipredbagg"        "SL.kernelKnn"        "SL.knn"             
[16] "SL.ksvm"             "SL.lda"              "SL.leekasso"        
[19] "SL.lm"               "SL.loess"            "SL.logreg"          
[22] "SL.mean"             "SL.nnet"             "SL.nnls"            
[25] "SL.polymars"         "SL.qda"              "SL.randomForest"    
[28] "SL.ranger"           "SL.ridge"            "SL.rpart"           
[31] "SL.rpartPrune"       "SL.speedglm"         "SL.speedlm"         
[34] "SL.step"             "SL.step.forward"     "SL.step.interaction"
[37] "SL.stepAIC"          "SL.svm"              "SL.template"        
[40] "SL.xgboost"         </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
All screening algorithm wrappers in SuperLearner:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "All"
[1] "screen.corP"           "screen.corRank"        "screen.glmnet"        
[4] "screen.randomForest"   "screen.SIS"            "screen.template"      
[7] "screen.ttest"          "write.screen.template"</code></pre>
</div>
<div id="lst-model-review" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-review-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;7: model review
</figcaption>
<div aria-describedby="lst-model-review-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-review"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-review-1"><a href="#lst-model-review-1" aria-hidden="true" tabindex="-1"></a>SL.glmnet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>function (Y, X, newX, family, obsWeights, id, alpha = 1, nfolds = 10, 
    nlambda = 100, useMin = TRUE, loss = "deviance", ...) 
{
    .SL.require("glmnet")
    if (!is.matrix(X)) {
        X &lt;- model.matrix(~-1 + ., X)
        newX &lt;- model.matrix(~-1 + ., newX)
    }
    fitCV &lt;- glmnet::cv.glmnet(x = X, y = Y, weights = obsWeights, 
        lambda = NULL, type.measure = loss, nfolds = nfolds, 
        family = family$family, alpha = alpha, nlambda = nlambda, 
        ...)
    pred &lt;- predict(fitCV, newx = newX, type = "response", s = ifelse(useMin, 
        "lambda.min", "lambda.1se"))
    fit &lt;- list(object = fitCV, useMin = useMin)
    class(fit) &lt;- "SL.glmnet"
    out &lt;- list(pred = pred, fit = fit)
    return(out)
}
&lt;bytecode: 0x648245d66b50&gt;
&lt;environment: namespace:SuperLearner&gt;</code></pre>
</div>
</div>
</section>
<section id="fit-individual-models" class="level2">
<h2 class="anchored" data-anchor-id="fit-individual-models">Fit individual models</h2>
<p>Let’s fit 2 separate models: lasso (sparse, penalized OLS) and random forest. We specify family = binomial() because we are predicting a binary outcome, aka classification. With a continuous outcome we would specify family = gaussian().</p>
<div class="cell">
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;8: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>) <span class="co"># Set the seed for reproducibility.</span></span>
<span id="lst-model-fit-lasso-2"><a href="#lst-model-fit-lasso-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-model-fit-lasso-3"><a href="#lst-model-fit-lasso-3" aria-hidden="true" tabindex="-1"></a>sl_lasso <span class="ot">=</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="lst-model-fit-lasso-4"><a href="#lst-model-fit-lasso-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="st">"SL.glmnet"</span>) <span class="co"># Fit lasso model.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: glmnet</code></pre>
</div>
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;9: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a>sl_lasso</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
SuperLearner(Y = y_train, X = x_train, family = binomial(), SL.library = "SL.glmnet") 

                    Risk Coef
SL.glmnet_All 0.08484849    1</code></pre>
</div>
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;10: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sl_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "call"              "libraryNames"      "SL.library"       
 [4] "SL.predict"        "coef"              "library.predict"  
 [7] "Z"                 "cvRisk"            "family"           
[10] "fitLibrary"        "cvFitLibrary"      "varNames"         
[13] "validRows"         "method"            "whichScreen"      
[16] "control"           "cvControl"         "errorsInCVLibrary"
[19] "errorsInLibrary"   "metaOptimizer"     "env"              
[22] "times"            </code></pre>
</div>
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;11: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a>sl_lasso<span class="sc">$</span>cvRisk[<span class="fu">which.min</span>(sl_lasso<span class="sc">$</span>cvRisk)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>SL.glmnet_All 
   0.08484849 </code></pre>
</div>
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;12: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(sl_lasso<span class="sc">$</span>fitLibrary<span class="sc">$</span>SL.glmnet_All<span class="sc">$</span>object, <span class="at">max.level =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 12
 $ lambda    : num [1:90] 0.317 0.289 0.263 0.24 0.218 ...
 $ cvm       : num [1:90] 1.34 1.28 1.21 1.16 1.1 ...
 $ cvsd      : num [1:90] 0.0359 0.033 0.0304 0.0292 0.0291 ...
 $ cvup      : num [1:90] 1.38 1.31 1.24 1.18 1.13 ...
 $ cvlo      : num [1:90] 1.31 1.24 1.18 1.13 1.08 ...
 $ nzero     : Named int [1:90] 0 1 1 1 1 1 2 2 2 2 ...
  ..- attr(*, "names")= chr [1:90] "s0" "s1" "s2" "s3" ...
 $ call      : language glmnet::cv.glmnet(x = X, y = Y, weights = obsWeights, lambda = NULL, type.measure = loss,      nfolds = nfolds, f| __truncated__
 $ name      : Named chr "Binomial Deviance"
  ..- attr(*, "names")= chr "deviance"
 $ glmnet.fit:List of 13
  ..- attr(*, "class")= chr [1:2] "lognet" "glmnet"
 $ lambda.min: num 0.0161
 $ lambda.1se: num 0.0652
 $ index     : int [1:2, 1] 33 18
  ..- attr(*, "dimnames")=List of 2
 - attr(*, "class")= chr "cv.glmnet"</code></pre>
</div>
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;13: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a>sl_rf <span class="ot">=</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="lst-model-fit-lasso-2"><a href="#lst-model-fit-lasso-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SL.library =</span> <span class="st">"SL.ranger"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: ranger</code></pre>
</div>
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;14: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sl_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "call"              "libraryNames"      "SL.library"       
 [4] "SL.predict"        "coef"              "library.predict"  
 [7] "Z"                 "cvRisk"            "family"           
[10] "fitLibrary"        "cvFitLibrary"      "varNames"         
[13] "validRows"         "method"            "whichScreen"      
[16] "control"           "cvControl"         "errorsInCVLibrary"
[19] "errorsInLibrary"   "metaOptimizer"     "env"              
[22] "times"            </code></pre>
</div>
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;15: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a>sl_lasso<span class="sc">$</span>cvRisk[<span class="fu">which.min</span>(sl_lasso<span class="sc">$</span>cvRisk)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>SL.glmnet_All 
   0.08484849 </code></pre>
</div>
<div id="lst-model-fit-lasso" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;16: fit lasso
</figcaption>
<div aria-describedby="lst-model-fit-lasso-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-model-fit-lasso"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-model-fit-lasso-1"><a href="#lst-model-fit-lasso-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here is the raw glmnet result object:</span></span>
<span id="lst-model-fit-lasso-2"><a href="#lst-model-fit-lasso-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(sl_lasso<span class="sc">$</span>fitLibrary<span class="sc">$</span>SL.glmnet_All<span class="sc">$</span>object, <span class="at">max.level =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 12
 $ lambda    : num [1:90] 0.317 0.289 0.263 0.24 0.218 ...
 $ cvm       : num [1:90] 1.34 1.28 1.21 1.16 1.1 ...
 $ cvsd      : num [1:90] 0.0359 0.033 0.0304 0.0292 0.0291 ...
 $ cvup      : num [1:90] 1.38 1.31 1.24 1.18 1.13 ...
 $ cvlo      : num [1:90] 1.31 1.24 1.18 1.13 1.08 ...
 $ nzero     : Named int [1:90] 0 1 1 1 1 1 2 2 2 2 ...
  ..- attr(*, "names")= chr [1:90] "s0" "s1" "s2" "s3" ...
 $ call      : language glmnet::cv.glmnet(x = X, y = Y, weights = obsWeights, lambda = NULL, type.measure = loss,      nfolds = nfolds, f| __truncated__
 $ name      : Named chr "Binomial Deviance"
  ..- attr(*, "names")= chr "deviance"
 $ glmnet.fit:List of 13
  ..- attr(*, "class")= chr [1:2] "lognet" "glmnet"
 $ lambda.min: num 0.0161
 $ lambda.1se: num 0.0652
 $ index     : int [1:2, 1] 33 18
  ..- attr(*, "dimnames")=List of 2
 - attr(*, "class")= chr "cv.glmnet"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit random forest.</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>sl_rf <span class="ot">=</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">SL.library =</span> <span class="st">"SL.ranger"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>sl_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
SuperLearner(Y = y_train, X = x_train, family = binomial(), SL.library = "SL.ranger") 

                    Risk Coef
SL.ranger_All 0.07620479    1</code></pre>
</div>
</div>
</section>
<section id="fit-multiple-models" class="level2">
<h2 class="anchored" data-anchor-id="fit-multiple-models">Fit multiple models</h2>
<div class="cell">
<div id="lst-fit-multiple-models" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-fit-multiple-models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;17: lst fit multiple models
</figcaption>
<div aria-describedby="lst-fit-multiple-models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-fit-multiple-models"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-fit-multiple-models-1"><a href="#lst-fit-multiple-models-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="lst-fit-multiple-models-2"><a href="#lst-fit-multiple-models-2" aria-hidden="true" tabindex="-1"></a>sl <span class="ot">=</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="lst-fit-multiple-models-3"><a href="#lst-fit-multiple-models-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.ranger"</span>))</span>
<span id="lst-fit-multiple-models-4"><a href="#lst-fit-multiple-models-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-fit-multiple-models-5"><a href="#lst-fit-multiple-models-5" aria-hidden="true" tabindex="-1"></a>sl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
SuperLearner(Y = y_train, X = x_train, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", "SL.ranger")) 

                    Risk       Coef
SL.mean_All   0.23773937 0.00000000
SL.glmnet_All 0.08847869 0.02212495
SL.ranger_All 0.07053788 0.97787505</code></pre>
</div>
<div id="lst-fit-multiple-models" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-fit-multiple-models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;18: lst fit multiple models
</figcaption>
<div aria-describedby="lst-fit-multiple-models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-fit-multiple-models"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-fit-multiple-models-1"><a href="#lst-fit-multiple-models-1" aria-hidden="true" tabindex="-1"></a>sl<span class="sc">$</span>times<span class="sc">$</span>everything</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  1.324   0.016   1.346 </code></pre>
</div>
</div>
<p>Again, the coefficient is how much weight SuperLearner puts on that model in the weighted-average. So if coefficient = 0 it means that model is not used at all. Here we see that random forest is given the most weight, following by lasso.</p>
<p>So we have an automatic ensemble of multiple learners based on the cross-validated performance of those learners, nice!</p>
</section>
<section id="predict-on-new-data" class="level1">
<h1>Predict on new data</h1>
<p>Now that we have an ensemble let’s predict back on our holdout dataset and review the results.</p>
<div class="cell">
<div id="lst-predict" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;19: predict
</figcaption>
<div aria-describedby="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-predict"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-predict-1"><a href="#lst-predict-1" aria-hidden="true" tabindex="-1"></a><span class="co"># onlySL is set to TRUE so we don't fit algorithms that had weight = 0, saving computation.</span></span>
<span id="lst-predict-2"><a href="#lst-predict-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">predict</span>(sl, x_holdout, <span class="at">onlySL =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: glmnet</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: ranger</code></pre>
</div>
<div id="lst-predict" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;20: predict
</figcaption>
<div aria-describedby="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-predict"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-predict-1"><a href="#lst-predict-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the structure of this prediction object.</span></span>
<span id="lst-predict-2"><a href="#lst-predict-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ pred           : num [1:356, 1] 0.577 0.891 0.939 0.943 0.853 ...
 $ library.predict: num [1:356, 1:3] 0 0 0 0 0 0 0 0 0 0 ...</code></pre>
</div>
<div id="lst-predict" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;21: predict
</figcaption>
<div aria-describedby="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-predict"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-predict-1"><a href="#lst-predict-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the columns of $library.predict.</span></span>
<span id="lst-predict-2"><a href="#lst-predict-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pred<span class="sc">$</span>library.predict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       V1          V2                 V3           
 Min.   :0   Min.   :0.000008   Min.   :0.0002625  
 1st Qu.:0   1st Qu.:0.026812   1st Qu.:0.0484115  
 Median :0   Median :0.310300   Median :0.3057313  
 Mean   :0   Mean   :0.404139   Mean   :0.4124046  
 3rd Qu.:0   3rd Qu.:0.782474   3rd Qu.:0.8181667  
 Max.   :0   Max.   :0.998259   Max.   :0.9980000  </code></pre>
</div>
<div id="lst-predict" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;22: predict
</figcaption>
<div aria-describedby="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-predict"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-predict-1"><a href="#lst-predict-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="lst-predict-2"><a href="#lst-predict-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qplot</span>(pred<span class="sc">$</span>pred[, <span class="dv">1</span>]) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `qplot()` was deprecated in ggplot2 3.4.0.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/lst-predict-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/lst-predict-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div id="lst-predict" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;23: predict
</figcaption>
<div aria-describedby="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-predict"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-predict-1"><a href="#lst-predict-1" aria-hidden="true" tabindex="-1"></a><span class="do">## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span>
<span id="lst-predict-2"><a href="#lst-predict-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-predict-3"><a href="#lst-predict-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot of original values (0, 1) and predicted values.</span></span>
<span id="lst-predict-4"><a href="#lst-predict-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ideally we would use jitter or slight transparency to deal with overlap.</span></span>
<span id="lst-predict-5"><a href="#lst-predict-5" aria-hidden="true" tabindex="-1"></a><span class="fu">qplot</span>(y_holdout, pred<span class="sc">$</span>pred[, <span class="dv">1</span>]) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/lst-predict-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/lst-predict-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div id="lst-predict" class="r cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;24: predict
</figcaption>
<div aria-describedby="lst-predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-predict"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="lst-predict-1"><a href="#lst-predict-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review AUC - Area Under Curve</span></span>
<span id="lst-predict-2"><a href="#lst-predict-2" aria-hidden="true" tabindex="-1"></a>pred_rocr <span class="ot">=</span> ROCR<span class="sc">::</span><span class="fu">prediction</span>(pred<span class="sc">$</span>pred, y_holdout)</span>
<span id="lst-predict-3"><a href="#lst-predict-3" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">=</span> ROCR<span class="sc">::</span><span class="fu">performance</span>(pred_rocr, <span class="at">measure =</span> <span class="st">"auc"</span>, <span class="at">x.measure =</span> <span class="st">"cutoff"</span>)<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="lst-predict-4"><a href="#lst-predict-4" aria-hidden="true" tabindex="-1"></a>auc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9443598</code></pre>
</div>
</div>
</section>
<section id="fit-ensemble-with-external-cross-validation" class="level1">
<h1>Fit ensemble with external cross-validation</h1>
<p>What we don’t have yet is an estimate of the performance of the ensemble itself. Right now we are just hopeful that the ensemble weights are successful in improving over the best single algorithm.</p>
<p>In order to estimate the performance of the SuperLearner ensemble we need an “external” layer of cross-validation, also called <strong>nested cross-validation</strong>. We generate a separate holdout sample that we don’t use to fit the SuperLearner, which allows it to be a good estimate of the SuperLearner’s performance on unseen data. Typically we would run 10 or 20-fold external cross-validation, but even 5-fold is reasonable.</p>
<p>Another nice result is that we get standard errors on the performance of the individual algorithms and can compare them to the SuperLearner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't have timing info for the CV.SuperLearner unfortunately.</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># So we need to time it manually.</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This will take about 2x as long as the previous SuperLearner.</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.ranger"</span>))</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  5.235   0.143   5.400 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We run summary on the cv_sl object rather than simply printing the object.</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", "SL.ranger")) 

Risk is based on: Mean Squared Error

All risk estimates are based on V =  3 

     Algorithm      Ave       se      Min      Max
 Super Learner 0.074388 0.011392 0.064595 0.084275
   Discrete SL 0.077512 0.011293 0.067146 0.086532
   SL.mean_All 0.251267 0.010352 0.228500 0.289600
 SL.glmnet_All 0.081595 0.014502 0.072729 0.095522
 SL.ranger_All 0.077512 0.011293 0.067146 0.086532</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the distribution of the best single learner as external CV folds.</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">simplify2array</span>(cv_sl<span class="sc">$</span>whichDiscreteSL))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
SL.ranger_All 
            3 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the performance with 95% CIs (use a better ggplot theme).</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_sl) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-7-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"SuperLearner.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Saving 7 x 5 in image</code></pre>
</div>
</div>
<section id="customize-a-model-hyperparameter" class="level2">
<h2 class="anchored" data-anchor-id="customize-a-model-hyperparameter">Customize a model hyperparameter</h2>
<p>Hyperparameters are the configuration settings for an algorithm. OLS has no hyperparameters but essentially every other algorithm does.</p>
<p>There are two ways to customize a hyperparameter: make a new learner function, or use create.Learner().</p>
<p>Let’s make a variant of random forest that fits more trees, which may increase our accuracy and can’t hurt it (outside of small random variation).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the function argument defaults at the top.</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>SL.ranger</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (Y, X, newX, family, obsWeights, num.trees = 500, mtry = floor(sqrt(ncol(X))), 
    write.forest = TRUE, probability = family$family == "binomial", 
    min.node.size = ifelse(family$family == "gaussian", 5, 1), 
    replace = TRUE, sample.fraction = ifelse(replace, 1, 0.632), 
    num.threads = 1, verbose = T, ...) 
{
    .SL.require("ranger")
    if (family$family == "binomial") {
        Y = as.factor(Y)
    }
    if (is.matrix(X)) {
        X = data.frame(X)
    }
    fit &lt;- ranger::ranger(`_Y` ~ ., data = cbind(`_Y` = Y, X), 
        num.trees = num.trees, mtry = mtry, min.node.size = min.node.size, 
        replace = replace, sample.fraction = sample.fraction, 
        case.weights = obsWeights, write.forest = write.forest, 
        probability = probability, num.threads = num.threads, 
        verbose = verbose)
    pred &lt;- predict(fit, data = newX)$predictions
    if (family$family == "binomial") {
        pred = pred[, "1"]
    }
    fit &lt;- list(object = fit, verbose = verbose)
    class(fit) &lt;- c("SL.ranger")
    out &lt;- list(pred = pred, fit = fit)
    return(out)
}
&lt;bytecode: 0x5f8eb7044c60&gt;
&lt;environment: namespace:SuperLearner&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new function that changes just the ntree argument.</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (We could do this in a single line.)</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># "..." means "all other arguments that were sent to the function"</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>SL.rf.better <span class="ot">=</span> <span class="cf">function</span>(...) {</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SL.randomForest</span>(..., <span class="at">num.trees =</span> <span class="dv">1000</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the CV.SuperLearner.</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co"># We use V = 3 to save computation time; for a real analysis use V = 10 or 20.</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.rf.better"</span>, <span class="st">"SL.ranger"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: glmnet</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: randomForest</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: ranger</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", "SL.rf.better", "SL.ranger")) 

Risk is based on: Mean Squared Error

All risk estimates are based on V =  3 

        Algorithm      Ave       se      Min      Max
    Super Learner 0.075382 0.011316 0.066279 0.085697
      Discrete SL 0.078154 0.011304 0.065446 0.090042
      SL.mean_All 0.251267 0.010352 0.228500 0.289600
    SL.glmnet_All 0.080752 0.014631 0.076383 0.088697
 SL.rf.better_All 0.078075 0.011301 0.065446 0.089805
    SL.ranger_All 0.080011 0.011452 0.066660 0.090042</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize the defaults for random forest.</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">create.Learner</span>(<span class="st">"SL.ranger"</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">num.trees =</span> <span class="dv">1000</span>))</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the object.</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>learners</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$grid
NULL

$names
[1] "SL.ranger_1"

$base_learner
[1] "SL.ranger"

$params
$params$num.trees
[1] 1000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List the functions that were created</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>learners<span class="sc">$</span>names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SL.ranger_1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the code that was automatically generated for the function.</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Notice that it's exactly the same as the function we made manually.</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>SL.ranger_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (...) 
SL.ranger(..., num.trees = 1000)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the CV.SuperLearner.</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We use V = 3 to save computation time; for a real analysis use V = 10 or 20.</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", learners$names, "SL.ranger")) 

Risk is based on: Mean Squared Error

All risk estimates are based on V =  3 

       Algorithm      Ave       se      Min      Max
   Super Learner 0.073994 0.010872 0.065059 0.083029
     Discrete SL 0.077243 0.011034 0.065593 0.089188
     SL.mean_All 0.251267 0.010352 0.228500 0.289600
   SL.glmnet_All 0.080148 0.013766 0.076383 0.087422
 SL.ranger_1_All 0.077687 0.011077 0.065593 0.089188
   SL.ranger_All 0.077231 0.011078 0.065675 0.089071</code></pre>
</div>
</div>
</section>
<section id="test-algorithm-with-multiple-hyperparameter-settings" class="level2">
<h2 class="anchored" data-anchor-id="test-algorithm-with-multiple-hyperparameter-settings">Test algorithm with multiple hyperparameter settings</h2>
<p>The performance of an algorithm varies based on its hyperparamters, which again are its configuration settings. Some algorithms may not vary much, and others might have far better or worse performance for certain settings. Often we focus our attention on 1 or 2 hyperparameters for a given algorithm because they are the most important ones.</p>
<p>For random forest there are two particularly important hyperparameters: mtry and maximum leaf nodes. Mtry is how many features are randomly chosen within each decision tree node - in other words, each time the tree considers making a split. Maximum leaf nodes controls how complex each tree can get.</p>
<p>Let’s try 3 different mtry options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sqrt(p) is the default value of mtry for classification.</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(x_train)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 3</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's try 3 multiplies of this default: 0.5, 1, and 2.</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>(<span class="at">mtry_seq =</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(x_train)) <span class="sc">*</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 3 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1 3 7</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">create.Learner</span>(<span class="st">"SL.ranger"</span>, <span class="at">tune =</span> <span class="fu">list</span>(<span class="at">mtry =</span> mtry_seq))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the resulting object</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>learners</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$grid
  mtry
1    1
2    3
3    7

$names
[1] "SL.ranger_1" "SL.ranger_2" "SL.ranger_3"

$base_learner
[1] "SL.ranger"

$params
list()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>SL.ranger_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (...) 
SL.ranger(..., mtry = 1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>SL.ranger_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (...) 
SL.ranger(..., mtry = 3)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>SL.ranger_3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (...) 
SL.ranger(..., mtry = 7)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the CV.SuperLearner.</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We use V = 3 to save computation time; for a real analysis use V = 10 or 20.</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">V =</span> <span class="dv">3</span>, </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: glmnet</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: ranger</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", learners$names, "SL.ranger")) 

Risk is based on: Mean Squared Error

All risk estimates are based on V =  3 

       Algorithm      Ave       se      Min      Max
   Super Learner 0.067516 0.011105 0.056210 0.081632
     Discrete SL 0.071761 0.011897 0.057843 0.092998
     SL.mean_All 0.251267 0.010352 0.228500 0.289600
   SL.glmnet_All 0.078227 0.015002 0.070147 0.087422
 SL.ranger_1_All 0.102194 0.011360 0.089415 0.111369
 SL.ranger_2_All 0.078006 0.011196 0.064298 0.093298
 SL.ranger_3_All 0.071761 0.011897 0.057843 0.092998
   SL.ranger_All 0.078469 0.011270 0.065888 0.089501</code></pre>
</div>
</div>
<p>We see here that mtry = 7 performed a little bit better than mtry = 1 or mtry = 3, although the difference is not significant. If we used more data and more cross-validation folds we might see more drastic differences. A higher mtry does better when a small percentage of variables are predictive of the outcome, because it gives each tree a better chance of finding a useful variable.</p>
<p>Note that SL.ranger and SL.ranger_2 have the same settings, and their performance is very similar - statistically a tie. It’s not exactly equivalent due to random variation in the two forests.</p>
<p>A key difference with SuperLearner over caret or other frameworks is that we are not trying to choose the single best hyperparameter or model. Instead, we usually want the best weighted average. So we are including all of the different settings in our SuperLearner, and we may choose a weighted average that includes the same model multiple times but with different settings. That can give us better performance than choosing only the single best settings for a given algorithm, which has some random noise in any case.</p>
<p>Multicore parallelization SuperLearner makes it easy to use multiple CPU cores on your computer to speed up the calculations. We first need to setup R for multiple cores, then tell CV.SuperLearner to divide its computations across those cores.</p>
<p>There are two ways to use multiple cores in R: the “multicore” system and the “snow” system. Windows only supports the “snow” system, which is more difficult to use, whereas macOS and Linux can use either one.</p>
<p>First we show the “multicore” system version:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup parallel computation - use all cores on our computer.</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>(<span class="at">num_cores =</span> RhpcBLASctl<span class="sc">::</span><span class="fu">get_num_cores</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use 2 of those cores for parallel SuperLearner.</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace "2" with "num_cores" (without quotes) to use all cores.</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="dv">2</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check how many parallel workers we are using (on macOS/Linux).</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="fu">getOption</span>(<span class="st">"mc.cores"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to set a different type of seed that works across cores.</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Otherwise the other cores will go rogue and we won't get repeatable results.</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This version is for the "multicore" parallel system in R.</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>, <span class="st">"L'Ecuyer-CMRG"</span>)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co"># While this is running check CPU using in Activity Monitor / Task Manager.</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">parallel =</span> <span class="st">"multicore"</span>,</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: parallel</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  1.918   0.272   4.835 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", learners$names, "SL.ranger"), parallel = "multicore") 

Risk is based on: Mean Squared Error

All risk estimates are based on V =  3 

       Algorithm      Ave        se      Min      Max
   Super Learner 0.089148 0.0149989 0.053080 0.107932
     Discrete SL 0.097739 0.0174582 0.059888 0.125348
     SL.mean_All 0.242600 0.0095617 0.226900 0.260500
   SL.glmnet_All 0.103421 0.0164995 0.059888 0.125348
 SL.ranger_1_All 0.093995 0.0107773 0.070773 0.106005
 SL.ranger_2_All 0.080877 0.0120526 0.053931 0.099784
 SL.ranger_3_All 0.084269 0.0142342 0.044643 0.107982
   SL.ranger_All 0.081619 0.0120937 0.052445 0.101650</code></pre>
</div>
</div>
<p>Here is the “snow” equivalent:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a snow cluster</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Again, replace 2 with num_cores to use all available cores.</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>cluster <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">makeCluster</span>(<span class="dv">2</span>)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the cluster object.</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>cluster</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>socket cluster with 2 nodes on host 'localhost'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the SuperLearner package on all workers so they can find</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SuperLearner::All(), the default screening function which keeps all variables.</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterEvalQ</span>(cluster, <span class="fu">library</span>(SuperLearner))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
 [1] "SuperLearner" "gam"          "foreach"      "splines"      "nnls"        
 [6] "stats"        "graphics"     "grDevices"    "utils"        "datasets"    
[11] "methods"      "base"        

[[2]]
 [1] "SuperLearner" "gam"          "foreach"      "splines"      "nnls"        
 [6] "stats"        "graphics"     "grDevices"    "utils"        "datasets"    
[11] "methods"      "base"        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to explictly export our custom learner functions to the workers.</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterExport</span>(cluster, learners<span class="sc">$</span>names)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to set a different type of seed that works across cores.</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This version is for SNOW parallelization.</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Otherwise the other cores will go rogue and we won't get repeatable results.</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterSetRNGStream</span>(cluster, <span class="dv">1</span>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co"># While this is running check CPU using in Activity Monitor / Task Manager.</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>  cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">parallel =</span> cluster,</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.007   0.000   5.484 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", learners$names, "SL.ranger"), parallel = cluster) 

Risk is based on: Mean Squared Error

All risk estimates are based on V =  3 

       Algorithm      Ave        se      Min      Max
   Super Learner 0.074781 0.0141069 0.063216 0.091040
     Discrete SL 0.070968 0.0132823 0.063216 0.079742
     SL.mean_All 0.238600 0.0091846 0.229300 0.246100
   SL.glmnet_All 0.097299 0.0185871 0.072560 0.120085
 SL.ranger_1_All 0.097233 0.0113360 0.093720 0.101704
 SL.ranger_2_All 0.076001 0.0119746 0.068762 0.082897
 SL.ranger_3_All 0.070968 0.0132823 0.063216 0.079742
   SL.ranger_All 0.076301 0.0118938 0.069590 0.082703</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop the cluster workers now that we're done.</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">stopCluster</span>(cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we want to use multiple cores for normal SuperLearner, not CV.SuperLearner (i.e.&nbsp;external cross-validation to estimate performance), we need to change the function name to mcSuperLearner (“multicore” version) or snowSuperLearner (“snow” version).</p>
<p>First the “multicore” version (won’t be parallel on Windows):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set multicore compatible seed.</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>, <span class="st">"L'Ecuyer-CMRG"</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the SuperLearner.</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>(<span class="at">sl =</span> <span class="fu">mcSuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
mcSuperLearner(Y = y_train, X = x_train, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", learners$names, "SL.ranger")) 

                      Risk       Coef
SL.mean_All     0.24253498 0.00000000
SL.glmnet_All   0.09181320 0.02471622
SL.ranger_1_All 0.09498042 0.00000000
SL.ranger_2_All 0.07428239 0.00000000
SL.ranger_3_All 0.07102085 0.92627825
SL.ranger_All   0.07388773 0.04900552</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We see the time is reduced over our initial single-core superlearner.</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>sl<span class="sc">$</span>times<span class="sc">$</span>everything</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  2.749   0.358   1.888 </code></pre>
</div>
</div>
<p>Now the “snow” version, which should be parallel on all operating systems.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a snow cluster</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Reminder: change "2" to "num_cores" (without quotes) to use all available cores.</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>(<span class="at">cluster =</span> parallel<span class="sc">::</span><span class="fu">makeCluster</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>socket cluster with 2 nodes on host 'localhost'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="do">## socket cluster with 2 nodes on host 'localhost'</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the SuperLearner package on all workers so they can find</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="co"># SuperLearner::All(), the default screening function which keeps all variables.</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterEvalQ</span>(cluster, <span class="fu">library</span>(SuperLearner))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
 [1] "SuperLearner" "gam"          "foreach"      "splines"      "nnls"        
 [6] "stats"        "graphics"     "grDevices"    "utils"        "datasets"    
[11] "methods"      "base"        

[[2]]
 [1] "SuperLearner" "gam"          "foreach"      "splines"      "nnls"        
 [6] "stats"        "graphics"     "grDevices"    "utils"        "datasets"    
[11] "methods"      "base"        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to explictly export our custom learner functions to the workers.</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterExport</span>(cluster, learners<span class="sc">$</span>names)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to set a different type of seed that works across cores.</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This version is for SNOW parallelization.</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Otherwise the other cores will go rogue and we won't get repeatable results.</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterSetRNGStream</span>(cluster, <span class="dv">1</span>)</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the SuperLearner.</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>(<span class="at">sl =</span> <span class="fu">snowSuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cluster =</span> cluster,</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
snowSuperLearner(cluster = cluster, Y = y_train, X = x_train, family = binomial(),  
    SL.library = c("SL.mean", "SL.glmnet", learners$names, "SL.ranger")) 

                      Risk       Coef
SL.mean_All     0.23878189 0.00000000
SL.glmnet_All   0.08486885 0.13188912
SL.ranger_1_All 0.09253551 0.00000000
SL.ranger_2_All 0.07253553 0.01627661
SL.ranger_3_All 0.06974784 0.85183427
SL.ranger_All   0.07397735 0.00000000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We see the time is reduced over our initial single-core superlearner.</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>sl<span class="sc">$</span>times<span class="sc">$</span>everything</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.356   0.036   2.624 </code></pre>
</div>
</div>
<p>SuperLearner also supports running across multiple computers at a time, called “multi-node” or “cluster” computing. We will skip that for now.</p>
</section>
<section id="weight-distribution-for-superlearner" class="level2">
<h2 class="anchored" data-anchor-id="weight-distribution-for-superlearner">Weight distribution for SuperLearner</h2>
<p>The weights or coefficients of the SuperLearner are stochastic - they will change as the data changes. So we don’t necessarily trust a given set of weights as being the “true” weights, but when we use CV.SuperLearner we at least have multiple samples from the distribution of the weights.</p>
<p>We can write a little function to extract the weights at each CV.SuperLearner iteration and summarize the distribution of those weights. This may be added to the SuperLearner package sometime in the future.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review meta-weights (coefficients) from a CV.SuperLearner object</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>review_weights <span class="ot">=</span> <span class="cf">function</span>(cv_sl) {</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  meta_weights <span class="ot">=</span> <span class="fu">coef</span>(cv_sl)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  means <span class="ot">=</span> <span class="fu">colMeans</span>(meta_weights)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  sds <span class="ot">=</span> <span class="fu">apply</span>(meta_weights, <span class="at">MARGIN =</span> <span class="dv">2</span>,  <span class="at">FUN =</span> sd)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  mins <span class="ot">=</span> <span class="fu">apply</span>(meta_weights, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> min)</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  maxs <span class="ot">=</span> <span class="fu">apply</span>(meta_weights, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> max)</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine the stats into a single matrix.</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  sl_stats <span class="ot">=</span> <span class="fu">cbind</span>(<span class="st">"mean(weight)"</span> <span class="ot">=</span> means, <span class="st">"sd"</span> <span class="ot">=</span> sds, <span class="st">"min"</span> <span class="ot">=</span> mins, <span class="st">"max"</span> <span class="ot">=</span> maxs)</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by decreasing mean weight.</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  sl_stats[<span class="fu">order</span>(sl_stats[, <span class="dv">1</span>], <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">review_weights</span>(cv_sl), <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                mean(weight)     sd   min   max
SL.ranger_3_All       0.6907 0.2955 0.411 1.000
SL.glmnet_All         0.2588 0.2295 0.000 0.437
SL.ranger_2_All       0.0504 0.0874 0.000 0.151
SL.mean_All           0.0000 0.0000 0.000 0.000
SL.ranger_1_All       0.0000 0.0000 0.000 0.000
SL.ranger_All         0.0000 0.0000 0.000 0.000</code></pre>
</div>
</div>
<p>Notice that in this case the ensemble never uses the mean nor the randomForest with mtry = 1. Also the LASSO (glmnet) was only used on a subset of the folds. Adding multiple configurations of randomForest was helpful because mtry = 7 was used. However, based on the minimum column we can see that no algorithm was used every single time.</p>
<p>We recommend reviewing the weight distribution for any SuperLearner project to better understand which algorithms are chosen for the ensemble.</p>
</section>
<section id="feature-selection-screening" class="level2">
<h2 class="anchored" data-anchor-id="feature-selection-screening">Feature selection (screening)</h2>
<p>When datasets have many covariates our algorithms may benefit from first choosing a subset of available covariates, a step called feature selection. Then we pass only those variables to the modeling algorithm, and it may be less likely to overfit to variables that are not related to the outcome.</p>
<p>Let’s revisit listWrappers() and check out the bottom section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">listWrappers</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>All prediction algorithm wrappers in SuperLearner:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "SL.bartMachine"      "SL.bayesglm"         "SL.biglasso"        
 [4] "SL.caret"            "SL.caret.rpart"      "SL.cforest"         
 [7] "SL.earth"            "SL.gam"              "SL.gbm"             
[10] "SL.glm"              "SL.glm.interaction"  "SL.glmnet"          
[13] "SL.ipredbagg"        "SL.kernelKnn"        "SL.knn"             
[16] "SL.ksvm"             "SL.lda"              "SL.leekasso"        
[19] "SL.lm"               "SL.loess"            "SL.logreg"          
[22] "SL.mean"             "SL.nnet"             "SL.nnls"            
[25] "SL.polymars"         "SL.qda"              "SL.randomForest"    
[28] "SL.ranger"           "SL.ridge"            "SL.rpart"           
[31] "SL.rpartPrune"       "SL.speedglm"         "SL.speedlm"         
[34] "SL.step"             "SL.step.forward"     "SL.step.interaction"
[37] "SL.stepAIC"          "SL.svm"              "SL.template"        
[40] "SL.xgboost"         </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
All screening algorithm wrappers in SuperLearner:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "All"
[1] "screen.corP"           "screen.corRank"        "screen.glmnet"        
[4] "screen.randomForest"   "screen.SIS"            "screen.template"      
[7] "screen.ttest"          "write.screen.template"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review code for corP, which is based on univariate correlation.</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>screen.corP</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (Y, X, family, obsWeights, id, method = "pearson", minPvalue = 0.1, 
    minscreen = 2, ...) 
{
    listp &lt;- apply(X, 2, function(x, Y, method) {
        ifelse(var(x) &lt;= 0, 1, cor.test(x, y = Y, method = method)$p.value)
    }, Y = Y, method = method)
    whichVariable &lt;- (listp &lt;= minPvalue)
    if (sum(whichVariable) &lt; minscreen) {
        warning("number of variables with p value less than minPvalue is less than minscreen")
        whichVariable[rank(listp) &lt;= minscreen] &lt;- TRUE
    }
    return(whichVariable)
}
&lt;bytecode: 0x60a974ffbef0&gt;
&lt;environment: namespace:SuperLearner&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the SuperLearner.</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to use list() instead of c().</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">parallel =</span> <span class="st">"multicore"</span>,</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">list</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="fu">c</span>(<span class="st">"SL.glmnet"</span>, <span class="st">"screen.corP"</span>)))</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = list("SL.mean",  
    "SL.glmnet", c("SL.glmnet", "screen.corP")), parallel = "multicore") 

Risk is based on: Mean Squared Error

All risk estimates are based on V =  3 

             Algorithm     Ave        se      Min     Max
         Super Learner 0.10463 0.0168593 0.065549 0.12602
           Discrete SL 0.10492 0.0170909 0.066405 0.12602
           SL.mean_All 0.24260 0.0095617 0.226900 0.26050
         SL.glmnet_All 0.10492 0.0170909 0.066405 0.12602
 SL.glmnet_screen.corP 0.10392 0.0163746 0.066405 0.12303</code></pre>
</div>
</div>
<p>We see a small performance boost by first screening by univarate correlation with our outcome, and only keeping variables with a p-value less than 0.10. Try using some of the other screening algorithms as they may do even better for a particular dataset.</p>
</section>
<section id="optimize-for-auc" class="level2">
<h2 class="anchored" data-anchor-id="optimize-for-auc">Optimize for AUC</h2>
<p>For binary prediction we are typically trying to maximize AUC, which can be the best performance metric when our outcome variable has some imbalance. In other words, we don’t have exactly 50% 1s and 50% 0s in our outcome. Our SuperLearner is not targeting AUC by default, but it can if we tell it to by specifying our method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">method =</span> <span class="st">"method.AUC"</span>,</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">list</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="fu">c</span>(<span class="st">"SL.glmnet"</span>, <span class="st">"screen.corP"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: cvAUC</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Loading required package: cvAUC</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = list("SL.mean",  
    "SL.glmnet", c("SL.glmnet", "screen.corP")), method = "method.AUC") 

Risk is based on: Area under ROC curve (AUC)

All risk estimates are based on V =  3 

             Algorithm     Ave se     Min     Max
         Super Learner 0.92045 NA 0.89372 0.95429
           Discrete SL 0.91989 NA 0.89372 0.95429
           SL.mean_All 0.50000 NA 0.50000 0.50000
         SL.glmnet_All 0.92322 NA 0.89372 0.95429
 SL.glmnet_screen.corP 0.91989 NA 0.89372 0.95429</code></pre>
</div>
</div>
<p>This conveniently shows us the AUC for each algorithm without us having to calculate it manually. But we aren’t getting SEs sadly.</p>
<p>Another important optimizer to consider is negative log likelihood, which is intended for binary outcomes and will often work better than NNLS (the default). This is specified by method = “NNloglik”.</p>
</section>
<section id="xgboost-hyperparameter-exploration" class="level2">
<h2 class="anchored" data-anchor-id="xgboost-hyperparameter-exploration">XGBoost hyperparameter exploration</h2>
<p>XGBoost is a version of GBM that is even faster and has some extra settings. GBM’s adaptivity is determined by its configuration, so we want to thoroughly test a wide range of configurations for any given problem. Let’s do 27 now. This will take a good amount of time (~7 minutes on my computer) so we need to at least use multiple cores, if not multiple computers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 * 3 * 3 = 27 different configurations.</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="co"># For a real analysis we would do 100, 500, or 1000 trees - this is just a demo.</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>tune <span class="ot">=</span> <span class="fu">list</span>(<span class="at">ntrees =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>),</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_depth =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">shrinkage =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>))</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set detailed names = T so we can see the configuration for each function.</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Also shorten the name prefix.</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">create.Learner</span>(<span class="st">"SL.xgboost"</span>, <span class="at">tune =</span> tune, <span class="at">detailed_names =</span> <span class="cn">TRUE</span>, <span class="at">name_prefix =</span> <span class="st">"xgb"</span>)</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 27 configurations - not too shabby.</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(learners<span class="sc">$</span>names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 27</code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>learners<span class="sc">$</span>names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "xgb_10_1_0.001" "xgb_20_1_0.001" "xgb_50_1_0.001" "xgb_10_2_0.001"
 [5] "xgb_20_2_0.001" "xgb_50_2_0.001" "xgb_10_3_0.001" "xgb_20_3_0.001"
 [9] "xgb_50_3_0.001" "xgb_10_1_0.01"  "xgb_20_1_0.01"  "xgb_50_1_0.01" 
[13] "xgb_10_2_0.01"  "xgb_20_2_0.01"  "xgb_50_2_0.01"  "xgb_10_3_0.01" 
[17] "xgb_20_3_0.01"  "xgb_50_3_0.01"  "xgb_10_1_0.1"   "xgb_20_1_0.1"  
[21] "xgb_50_1_0.1"   "xgb_10_2_0.1"   "xgb_20_2_0.1"   "xgb_50_2_0.1"  
[25] "xgb_10_3_0.1"   "xgb_20_3_0.1"   "xgb_50_3_0.1"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm we have multiple cores configured. This should be &gt; 1.</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="fu">getOption</span>(<span class="st">"mc.cores"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remember to set multicore-compatible seed.</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>, <span class="st">"L'Ecuyer-CMRG"</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the CV.SuperLearner.</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">parallel =</span> <span class="st">"multicore"</span>,</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
333.391   0.667  48.655 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
CV.SuperLearner(Y = y_train, X = x_train, V = 3, family = binomial(), SL.library = c("SL.mean",  
    "SL.glmnet", learners$names, "SL.ranger"), parallel = "multicore") 

Risk is based on: Mean Squared Error

All risk estimates are based on V =  3 

          Algorithm      Ave         se      Min     Max
      Super Learner 0.089735 0.01523004 0.052813 0.11879
        Discrete SL 0.095907 0.01699764 0.064775 0.12535
        SL.mean_All 0.242600 0.00956173 0.226900 0.26050
      SL.glmnet_All 0.104150 0.01673952 0.064775 0.12535
 xgb_10_1_0.001_All 0.247864 0.00022090 0.247406 0.24828
 xgb_20_1_0.001_All 0.245773 0.00043925 0.244861 0.24661
 xgb_50_1_0.001_All 0.239599 0.00103601 0.237065 0.24182
 xgb_10_2_0.001_All 0.247864 0.00022090 0.247406 0.24828
 xgb_20_2_0.001_All 0.245773 0.00043925 0.244861 0.24661
 xgb_50_2_0.001_All 0.239599 0.00103601 0.237065 0.24182
 xgb_10_3_0.001_All 0.247864 0.00022090 0.247406 0.24828
 xgb_20_3_0.001_All 0.245773 0.00043925 0.244861 0.24661
 xgb_50_3_0.001_All 0.239599 0.00103601 0.237065 0.24182
  xgb_10_1_0.01_All 0.229984 0.00200462 0.224800 0.23455
  xgb_20_1_0.01_All 0.213539 0.00380533 0.203477 0.22257
  xgb_50_1_0.01_All 0.179899 0.00791583 0.154434 0.20141
  xgb_10_2_0.01_All 0.229984 0.00200462 0.224800 0.23455
  xgb_20_2_0.01_All 0.213539 0.00380533 0.203477 0.22257
  xgb_50_2_0.01_All 0.179899 0.00791583 0.154434 0.20141
  xgb_10_3_0.01_All 0.229984 0.00200462 0.224800 0.23455
  xgb_20_3_0.01_All 0.213539 0.00380533 0.203477 0.22257
  xgb_50_3_0.01_All 0.179899 0.00791583 0.154434 0.20141
   xgb_10_1_0.1_All 0.149806 0.01102873 0.113512 0.18562
   xgb_20_1_0.1_All 0.138650 0.01162345 0.093478 0.18195
   xgb_50_1_0.1_All 0.139119 0.01173685 0.092681 0.18077
   xgb_10_2_0.1_All 0.149806 0.01102873 0.113512 0.18562
   xgb_20_2_0.1_All 0.138650 0.01162345 0.093478 0.18195
   xgb_50_2_0.1_All 0.139119 0.01173685 0.092681 0.18077
   xgb_10_3_0.1_All 0.149806 0.01102873 0.113512 0.18562
   xgb_20_3_0.1_All 0.138650 0.01162345 0.093478 0.18195
   xgb_50_3_0.1_All 0.139119 0.01173685 0.092681 0.18077
      SL.ranger_All 0.079853 0.01187862 0.049206 0.09760</code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">review_weights</span>(cv_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mean(weight)        sd       min       max
SL.ranger_All         0.5323384 0.4480376 0.1069165 1.0000000
SL.glmnet_All         0.4676616 0.4480376 0.0000000 0.8930835
SL.mean_All           0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_1_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_1_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_1_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_2_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_2_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_2_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_3_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_3_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_3_0.001_All    0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_1_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_1_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_1_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_2_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_2_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_2_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_3_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_3_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_3_0.01_All     0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_1_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_1_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_1_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_2_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_2_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_2_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000
xgb_10_3_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000
xgb_20_3_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000
xgb_50_3_0.1_All      0.0000000 0.0000000 0.0000000 0.0000000</code></pre>
</div>
</div>
<p>We can see how stochastic the weights are for each individual execution of SuperLearner.</p>
<p>Finally, plot the performance for the different settings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_sl) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-18-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="troubleshooting">Troubleshooting</h2>
<p>If you get an error about predict for xgb.Booster, you probably need to install the latest version of XGBoost from github.</p>


<!-- -->

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{bochman2024,
  author = {Bochman, Oren},
  title = {SuperLearner},
  date = {2024-01-10},
  url = {https://orenbochman.github.io/blog//posts/2024/2024-01-10-superlearner},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-bochman2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Bochman, Oren. 2024. <span>“SuperLearner.”</span> January 10, 2024. <a href="https://orenbochman.github.io/blog//posts/2024/2024-01-10-superlearner">https://orenbochman.github.io/blog//posts/2024/2024-01-10-superlearner</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="OrenBochman/blogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb130" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2024-01-10</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> SuperLearner</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [demos,code,r]</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: False</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: True</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: True</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: kable</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: True</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a><span class="co">  capture: True</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto  # re-render only when source changes</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>This is a SuperLearner demo.</span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>SuperLearner is an ensableing library.</span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a>This page is taken out of the documenation</span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup dataset</span></span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-mass-data-set</span></span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-label: lst-mass-data-set</span></span>
<span id="cb130-32"><a href="#cb130-32" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-cap: dataset setup</span></span>
<span id="cb130-33"><a href="#cb130-33" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(c("SuperLearner","caret", "glmnet", "randomForest", "ggplot2", "RhpcBLASctl","xgboost","ranger"))</span></span>
<span id="cb130-34"><a href="#cb130-34" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Boston, <span class="at">package =</span> <span class="st">"MASS"</span>)</span>
<span id="cb130-35"><a href="#cb130-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-36"><a href="#cb130-36" aria-hidden="true" tabindex="-1"></a>?MASS<span class="sc">::</span>Boston  <span class="co"># Review info on the Boston dataset.&gt;</span></span>
<span id="cb130-37"><a href="#cb130-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-38"><a href="#cb130-38" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(Boston)) <span class="co"># Check for any missing data - looks like we don't have any.</span></span>
<span id="cb130-39"><a href="#cb130-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-40"><a href="#cb130-40" aria-hidden="true" tabindex="-1"></a>outcome <span class="ot">=</span> Boston<span class="sc">$</span>medv <span class="co">#Extract our outcome variable from the dataframe.</span></span>
<span id="cb130-41"><a href="#cb130-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-42"><a href="#cb130-42" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">subset</span>(Boston, <span class="at">select =</span> <span class="sc">-</span>medv) <span class="co"># Create a dataframe to contain our explanatory variables.</span></span>
<span id="cb130-43"><a href="#cb130-43" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span>
<span id="cb130-44"><a href="#cb130-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-45"><a href="#cb130-45" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(data) <span class="co"># Check structure of our dataframe.</span></span>
<span id="cb130-46"><a href="#cb130-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-47"><a href="#cb130-47" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(data) <span class="co"># Review our dimensions.</span></span>
<span id="cb130-48"><a href="#cb130-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-49"><a href="#cb130-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-50"><a href="#cb130-50" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)<span class="co"># Set a seed for reproducibility in this random sampling.</span></span>
<span id="cb130-51"><a href="#cb130-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-52"><a href="#cb130-52" aria-hidden="true" tabindex="-1"></a>train_obs <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="dv">150</span>) <span class="co"># Reduce to a dataset of 150 observations to speed up model fitting.</span></span>
<span id="cb130-53"><a href="#cb130-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-54"><a href="#cb130-54" aria-hidden="true" tabindex="-1"></a>x_train <span class="ot">=</span> data[train_obs, ] <span class="co"># X is our training sample.</span></span>
<span id="cb130-55"><a href="#cb130-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-56"><a href="#cb130-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-57"><a href="#cb130-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-58"><a href="#cb130-58" aria-hidden="true" tabindex="-1"></a>x_holdout <span class="ot">=</span> data[<span class="sc">-</span>train_obs, ] <span class="co"># Create a holdout set for evaluating model performance.</span></span>
<span id="cb130-59"><a href="#cb130-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: cross-validation is even better than a single holdout sample.</span></span>
<span id="cb130-60"><a href="#cb130-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-61"><a href="#cb130-61" aria-hidden="true" tabindex="-1"></a>outcome_bin <span class="ot">=</span> <span class="fu">as.numeric</span>(outcome <span class="sc">&gt;</span> <span class="dv">22</span>) <span class="co"># Create a binary outcome variable: towns in which median home value is &gt; 22,000.</span></span>
<span id="cb130-62"><a href="#cb130-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-63"><a href="#cb130-63" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">=</span> outcome_bin[train_obs]</span>
<span id="cb130-64"><a href="#cb130-64" aria-hidden="true" tabindex="-1"></a>y_holdout <span class="ot">=</span> outcome_bin[<span class="sc">-</span>train_obs]</span>
<span id="cb130-65"><a href="#cb130-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-66"><a href="#cb130-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-67"><a href="#cb130-67" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(y_train, <span class="at">useNA =</span> <span class="st">"ifany"</span>) <span class="co"># Review the outcome variable distribution.</span></span>
<span id="cb130-68"><a href="#cb130-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-69"><a href="#cb130-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-70"><a href="#cb130-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## Review available models</span></span>
<span id="cb130-71"><a href="#cb130-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-74"><a href="#cb130-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-75"><a href="#cb130-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-model-review</span></span>
<span id="cb130-76"><a href="#cb130-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-label: lst-model-review</span></span>
<span id="cb130-77"><a href="#cb130-77" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-cap: model review</span></span>
<span id="cb130-78"><a href="#cb130-78" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb130-79"><a href="#cb130-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-80"><a href="#cb130-80" aria-hidden="true" tabindex="-1"></a><span class="fu">listWrappers</span>() <span class="co"># Review available models.</span></span>
<span id="cb130-81"><a href="#cb130-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-82"><a href="#cb130-82" aria-hidden="true" tabindex="-1"></a>SL.glmnet</span>
<span id="cb130-83"><a href="#cb130-83" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-84"><a href="#cb130-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-85"><a href="#cb130-85" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit individual models</span></span>
<span id="cb130-86"><a href="#cb130-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-87"><a href="#cb130-87" aria-hidden="true" tabindex="-1"></a>Let’s fit 2 separate models: lasso (sparse, penalized OLS) and random forest. We specify family = binomial() because we are predicting a binary outcome, aka classification. With a continuous outcome we would specify family = gaussian().</span>
<span id="cb130-88"><a href="#cb130-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-91"><a href="#cb130-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-92"><a href="#cb130-92" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-model-fit-lasso</span></span>
<span id="cb130-93"><a href="#cb130-93" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-label: lst-model-fit-lasso</span></span>
<span id="cb130-94"><a href="#cb130-94" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-cap: fit lasso</span></span>
<span id="cb130-95"><a href="#cb130-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-96"><a href="#cb130-96" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>) <span class="co"># Set the seed for reproducibility.</span></span>
<span id="cb130-97"><a href="#cb130-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-98"><a href="#cb130-98" aria-hidden="true" tabindex="-1"></a>sl_lasso <span class="ot">=</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-99"><a href="#cb130-99" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="st">"SL.glmnet"</span>) <span class="co"># Fit lasso model.</span></span>
<span id="cb130-100"><a href="#cb130-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-101"><a href="#cb130-101" aria-hidden="true" tabindex="-1"></a>sl_lasso</span>
<span id="cb130-102"><a href="#cb130-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-103"><a href="#cb130-103" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sl_lasso)</span>
<span id="cb130-104"><a href="#cb130-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-105"><a href="#cb130-105" aria-hidden="true" tabindex="-1"></a>sl_lasso<span class="sc">$</span>cvRisk[<span class="fu">which.min</span>(sl_lasso<span class="sc">$</span>cvRisk)]</span>
<span id="cb130-106"><a href="#cb130-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-107"><a href="#cb130-107" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(sl_lasso<span class="sc">$</span>fitLibrary<span class="sc">$</span>SL.glmnet_All<span class="sc">$</span>object, <span class="at">max.level =</span> <span class="dv">1</span>)</span>
<span id="cb130-108"><a href="#cb130-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-109"><a href="#cb130-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-110"><a href="#cb130-110" aria-hidden="true" tabindex="-1"></a>sl_rf <span class="ot">=</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-111"><a href="#cb130-111" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SL.library =</span> <span class="st">"SL.ranger"</span>)</span>
<span id="cb130-112"><a href="#cb130-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-113"><a href="#cb130-113" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sl_lasso)</span>
<span id="cb130-114"><a href="#cb130-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-115"><a href="#cb130-115" aria-hidden="true" tabindex="-1"></a>sl_lasso<span class="sc">$</span>cvRisk[<span class="fu">which.min</span>(sl_lasso<span class="sc">$</span>cvRisk)]</span>
<span id="cb130-116"><a href="#cb130-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-117"><a href="#cb130-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-118"><a href="#cb130-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Here is the raw glmnet result object:</span></span>
<span id="cb130-119"><a href="#cb130-119" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(sl_lasso<span class="sc">$</span>fitLibrary<span class="sc">$</span>SL.glmnet_All<span class="sc">$</span>object, <span class="at">max.level =</span> <span class="dv">1</span>)</span>
<span id="cb130-120"><a href="#cb130-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-121"><a href="#cb130-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-122"><a href="#cb130-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-125"><a href="#cb130-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-126"><a href="#cb130-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit random forest.</span></span>
<span id="cb130-127"><a href="#cb130-127" aria-hidden="true" tabindex="-1"></a>sl_rf <span class="ot">=</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">SL.library =</span> <span class="st">"SL.ranger"</span>)</span>
<span id="cb130-128"><a href="#cb130-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-129"><a href="#cb130-129" aria-hidden="true" tabindex="-1"></a>sl_rf</span>
<span id="cb130-130"><a href="#cb130-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-131"><a href="#cb130-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-132"><a href="#cb130-132" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit multiple models</span></span>
<span id="cb130-133"><a href="#cb130-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-136"><a href="#cb130-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-137"><a href="#cb130-137" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-fit-multiple-models</span></span>
<span id="cb130-138"><a href="#cb130-138" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-label: lst-fit-multiple-models</span></span>
<span id="cb130-139"><a href="#cb130-139" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-cap: lst fit multiple models</span></span>
<span id="cb130-140"><a href="#cb130-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-141"><a href="#cb130-141" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb130-142"><a href="#cb130-142" aria-hidden="true" tabindex="-1"></a>sl <span class="ot">=</span> <span class="fu">SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-143"><a href="#cb130-143" aria-hidden="true" tabindex="-1"></a>  <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.ranger"</span>))</span>
<span id="cb130-144"><a href="#cb130-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-145"><a href="#cb130-145" aria-hidden="true" tabindex="-1"></a>sl</span>
<span id="cb130-146"><a href="#cb130-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-147"><a href="#cb130-147" aria-hidden="true" tabindex="-1"></a>sl<span class="sc">$</span>times<span class="sc">$</span>everything</span>
<span id="cb130-148"><a href="#cb130-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-149"><a href="#cb130-149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-150"><a href="#cb130-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-151"><a href="#cb130-151" aria-hidden="true" tabindex="-1"></a>Again, the coefficient is how much weight SuperLearner puts on that model in the weighted-average. So if coefficient = 0 it means that model is not used at all. Here we see that random forest is given the most weight, following by lasso.</span>
<span id="cb130-152"><a href="#cb130-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-153"><a href="#cb130-153" aria-hidden="true" tabindex="-1"></a>So we have an automatic ensemble of multiple learners based on the cross-validated performance of those learners, nice!</span>
<span id="cb130-154"><a href="#cb130-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-155"><a href="#cb130-155" aria-hidden="true" tabindex="-1"></a><span class="fu">#  Predict on new data</span></span>
<span id="cb130-156"><a href="#cb130-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-157"><a href="#cb130-157" aria-hidden="true" tabindex="-1"></a>Now that we have an ensemble let’s predict back on our holdout dataset and review the results.</span>
<span id="cb130-158"><a href="#cb130-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-161"><a href="#cb130-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-162"><a href="#cb130-162" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-predict</span></span>
<span id="cb130-163"><a href="#cb130-163" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-label: lst-predict</span></span>
<span id="cb130-164"><a href="#cb130-164" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-cap: predict</span></span>
<span id="cb130-165"><a href="#cb130-165" aria-hidden="true" tabindex="-1"></a><span class="co">#| # Predict back on the holdout dataset.</span></span>
<span id="cb130-166"><a href="#cb130-166" aria-hidden="true" tabindex="-1"></a><span class="co"># onlySL is set to TRUE so we don't fit algorithms that had weight = 0, saving computation.</span></span>
<span id="cb130-167"><a href="#cb130-167" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">predict</span>(sl, x_holdout, <span class="at">onlySL =</span> <span class="cn">TRUE</span>)</span>
<span id="cb130-168"><a href="#cb130-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-169"><a href="#cb130-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the structure of this prediction object.</span></span>
<span id="cb130-170"><a href="#cb130-170" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(pred)</span>
<span id="cb130-171"><a href="#cb130-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-172"><a href="#cb130-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the columns of $library.predict.</span></span>
<span id="cb130-173"><a href="#cb130-173" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pred<span class="sc">$</span>library.predict)</span>
<span id="cb130-174"><a href="#cb130-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-175"><a href="#cb130-175" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb130-176"><a href="#cb130-176" aria-hidden="true" tabindex="-1"></a><span class="fu">qplot</span>(pred<span class="sc">$</span>pred[, <span class="dv">1</span>]) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span>
<span id="cb130-177"><a href="#cb130-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-178"><a href="#cb130-178" aria-hidden="true" tabindex="-1"></a><span class="do">## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span>
<span id="cb130-179"><a href="#cb130-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-180"><a href="#cb130-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatterplot of original values (0, 1) and predicted values.</span></span>
<span id="cb130-181"><a href="#cb130-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Ideally we would use jitter or slight transparency to deal with overlap.</span></span>
<span id="cb130-182"><a href="#cb130-182" aria-hidden="true" tabindex="-1"></a><span class="fu">qplot</span>(y_holdout, pred<span class="sc">$</span>pred[, <span class="dv">1</span>]) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span>
<span id="cb130-183"><a href="#cb130-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-184"><a href="#cb130-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Review AUC - Area Under Curve</span></span>
<span id="cb130-185"><a href="#cb130-185" aria-hidden="true" tabindex="-1"></a>pred_rocr <span class="ot">=</span> ROCR<span class="sc">::</span><span class="fu">prediction</span>(pred<span class="sc">$</span>pred, y_holdout)</span>
<span id="cb130-186"><a href="#cb130-186" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">=</span> ROCR<span class="sc">::</span><span class="fu">performance</span>(pred_rocr, <span class="at">measure =</span> <span class="st">"auc"</span>, <span class="at">x.measure =</span> <span class="st">"cutoff"</span>)<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb130-187"><a href="#cb130-187" aria-hidden="true" tabindex="-1"></a>auc</span>
<span id="cb130-188"><a href="#cb130-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-189"><a href="#cb130-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-190"><a href="#cb130-190" aria-hidden="true" tabindex="-1"></a><span class="fu"># Fit ensemble with external cross-validation</span></span>
<span id="cb130-191"><a href="#cb130-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-192"><a href="#cb130-192" aria-hidden="true" tabindex="-1"></a>What we don’t have yet is an estimate of the performance of the ensemble itself. Right now we are just hopeful that the ensemble weights are successful in improving over the best single algorithm.</span>
<span id="cb130-193"><a href="#cb130-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-194"><a href="#cb130-194" aria-hidden="true" tabindex="-1"></a>In order to estimate the performance of the SuperLearner ensemble we need an “external” layer of cross-validation, also called **nested cross-validation**. We generate a separate holdout sample that we don’t use to fit the SuperLearner, which allows it to be a good estimate of the SuperLearner’s performance on unseen data. Typically we would run 10 or 20-fold external cross-validation, but even 5-fold is reasonable.</span>
<span id="cb130-195"><a href="#cb130-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-196"><a href="#cb130-196" aria-hidden="true" tabindex="-1"></a>Another nice result is that we get standard errors on the performance of the individual algorithms and can compare them to the SuperLearner.</span>
<span id="cb130-197"><a href="#cb130-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-200"><a href="#cb130-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-201"><a href="#cb130-201" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb130-202"><a href="#cb130-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-203"><a href="#cb130-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't have timing info for the CV.SuperLearner unfortunately.</span></span>
<span id="cb130-204"><a href="#cb130-204" aria-hidden="true" tabindex="-1"></a><span class="co"># So we need to time it manually.</span></span>
<span id="cb130-205"><a href="#cb130-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-206"><a href="#cb130-206" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb130-207"><a href="#cb130-207" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This will take about 2x as long as the previous SuperLearner.</span></span>
<span id="cb130-208"><a href="#cb130-208" aria-hidden="true" tabindex="-1"></a>  cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-209"><a href="#cb130-209" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb130-210"><a href="#cb130-210" aria-hidden="true" tabindex="-1"></a>                          <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb130-211"><a href="#cb130-211" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.ranger"</span>))</span>
<span id="cb130-212"><a href="#cb130-212" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb130-213"><a href="#cb130-213" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb130-214"><a href="#cb130-214" aria-hidden="true" tabindex="-1"></a><span class="co"># We run summary on the cv_sl object rather than simply printing the object.</span></span>
<span id="cb130-215"><a href="#cb130-215" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-216"><a href="#cb130-216" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb130-217"><a href="#cb130-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the distribution of the best single learner as external CV folds.</span></span>
<span id="cb130-218"><a href="#cb130-218" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">simplify2array</span>(cv_sl<span class="sc">$</span>whichDiscreteSL))</span>
<span id="cb130-219"><a href="#cb130-219" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb130-220"><a href="#cb130-220" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the performance with 95% CIs (use a better ggplot theme).</span></span>
<span id="cb130-221"><a href="#cb130-221" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_sl) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span>
<span id="cb130-222"><a href="#cb130-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-223"><a href="#cb130-223" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"SuperLearner.png"</span>)</span>
<span id="cb130-224"><a href="#cb130-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-225"><a href="#cb130-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-226"><a href="#cb130-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-227"><a href="#cb130-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-228"><a href="#cb130-228" aria-hidden="true" tabindex="-1"></a><span class="fu">## Customize a model hyperparameter</span></span>
<span id="cb130-229"><a href="#cb130-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-230"><a href="#cb130-230" aria-hidden="true" tabindex="-1"></a>Hyperparameters are the configuration settings for an algorithm. OLS has no hyperparameters but essentially every other algorithm does.</span>
<span id="cb130-231"><a href="#cb130-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-232"><a href="#cb130-232" aria-hidden="true" tabindex="-1"></a>There are two ways to customize a hyperparameter: make a new learner function, or use create.Learner().</span>
<span id="cb130-233"><a href="#cb130-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-234"><a href="#cb130-234" aria-hidden="true" tabindex="-1"></a>Let’s make a variant of random forest that fits more trees, which may increase our accuracy and can’t hurt it (outside of small random variation).</span>
<span id="cb130-235"><a href="#cb130-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-238"><a href="#cb130-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-239"><a href="#cb130-239" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the function argument defaults at the top.</span></span>
<span id="cb130-240"><a href="#cb130-240" aria-hidden="true" tabindex="-1"></a>SL.ranger</span>
<span id="cb130-241"><a href="#cb130-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-242"><a href="#cb130-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new function that changes just the ntree argument.</span></span>
<span id="cb130-243"><a href="#cb130-243" aria-hidden="true" tabindex="-1"></a><span class="co"># (We could do this in a single line.)</span></span>
<span id="cb130-244"><a href="#cb130-244" aria-hidden="true" tabindex="-1"></a><span class="co"># "..." means "all other arguments that were sent to the function"</span></span>
<span id="cb130-245"><a href="#cb130-245" aria-hidden="true" tabindex="-1"></a>SL.rf.better <span class="ot">=</span> <span class="cf">function</span>(...) {</span>
<span id="cb130-246"><a href="#cb130-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SL.randomForest</span>(..., <span class="at">num.trees =</span> <span class="dv">1000</span>)</span>
<span id="cb130-247"><a href="#cb130-247" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-248"><a href="#cb130-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-249"><a href="#cb130-249" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb130-250"><a href="#cb130-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-251"><a href="#cb130-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the CV.SuperLearner.</span></span>
<span id="cb130-252"><a href="#cb130-252" aria-hidden="true" tabindex="-1"></a><span class="co"># We use V = 3 to save computation time; for a real analysis use V = 10 or 20.</span></span>
<span id="cb130-253"><a href="#cb130-253" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb130-254"><a href="#cb130-254" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="st">"SL.rf.better"</span>, <span class="st">"SL.ranger"</span>))</span>
<span id="cb130-255"><a href="#cb130-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-256"><a href="#cb130-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb130-257"><a href="#cb130-257" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-258"><a href="#cb130-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-259"><a href="#cb130-259" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize the defaults for random forest.</span></span>
<span id="cb130-260"><a href="#cb130-260" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">create.Learner</span>(<span class="st">"SL.ranger"</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">num.trees =</span> <span class="dv">1000</span>))</span>
<span id="cb130-261"><a href="#cb130-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-262"><a href="#cb130-262" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the object.</span></span>
<span id="cb130-263"><a href="#cb130-263" aria-hidden="true" tabindex="-1"></a>learners</span>
<span id="cb130-264"><a href="#cb130-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-265"><a href="#cb130-265" aria-hidden="true" tabindex="-1"></a><span class="co"># List the functions that were created</span></span>
<span id="cb130-266"><a href="#cb130-266" aria-hidden="true" tabindex="-1"></a>learners<span class="sc">$</span>names</span>
<span id="cb130-267"><a href="#cb130-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-268"><a href="#cb130-268" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the code that was automatically generated for the function.</span></span>
<span id="cb130-269"><a href="#cb130-269" aria-hidden="true" tabindex="-1"></a><span class="co"># Notice that it's exactly the same as the function we made manually.</span></span>
<span id="cb130-270"><a href="#cb130-270" aria-hidden="true" tabindex="-1"></a>SL.ranger_1</span>
<span id="cb130-271"><a href="#cb130-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-272"><a href="#cb130-272" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb130-273"><a href="#cb130-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-274"><a href="#cb130-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the CV.SuperLearner.</span></span>
<span id="cb130-275"><a href="#cb130-275" aria-hidden="true" tabindex="-1"></a><span class="co"># We use V = 3 to save computation time; for a real analysis use V = 10 or 20.</span></span>
<span id="cb130-276"><a href="#cb130-276" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-277"><a href="#cb130-277" aria-hidden="true" tabindex="-1"></a>                        <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb130-278"><a href="#cb130-278" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb130-279"><a href="#cb130-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-280"><a href="#cb130-280" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb130-281"><a href="#cb130-281" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-282"><a href="#cb130-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-283"><a href="#cb130-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-284"><a href="#cb130-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-285"><a href="#cb130-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-286"><a href="#cb130-286" aria-hidden="true" tabindex="-1"></a><span class="fu">## Test algorithm with multiple hyperparameter settings</span></span>
<span id="cb130-287"><a href="#cb130-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-288"><a href="#cb130-288" aria-hidden="true" tabindex="-1"></a>The performance of an algorithm varies based on its hyperparamters, which again are its configuration settings. Some algorithms may not vary much, and others might have far better or worse performance for certain settings. Often we focus our attention on 1 or 2 hyperparameters for a given algorithm because they are the most important ones.</span>
<span id="cb130-289"><a href="#cb130-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-290"><a href="#cb130-290" aria-hidden="true" tabindex="-1"></a>For random forest there are two particularly important hyperparameters: mtry and maximum leaf nodes. Mtry is how many features are randomly chosen within each decision tree node - in other words, each time the tree considers making a split. Maximum leaf nodes controls how complex each tree can get.</span>
<span id="cb130-291"><a href="#cb130-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-292"><a href="#cb130-292" aria-hidden="true" tabindex="-1"></a>Let’s try 3 different mtry options.</span>
<span id="cb130-293"><a href="#cb130-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-296"><a href="#cb130-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-297"><a href="#cb130-297" aria-hidden="true" tabindex="-1"></a><span class="co"># sqrt(p) is the default value of mtry for classification.</span></span>
<span id="cb130-298"><a href="#cb130-298" aria-hidden="true" tabindex="-1"></a><span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(x_train)))</span>
<span id="cb130-299"><a href="#cb130-299" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 3</span></span>
<span id="cb130-300"><a href="#cb130-300" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's try 3 multiplies of this default: 0.5, 1, and 2.</span></span>
<span id="cb130-301"><a href="#cb130-301" aria-hidden="true" tabindex="-1"></a>(<span class="at">mtry_seq =</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(x_train)) <span class="sc">*</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>)))</span>
<span id="cb130-302"><a href="#cb130-302" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1 3 7</span></span>
<span id="cb130-303"><a href="#cb130-303" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">create.Learner</span>(<span class="st">"SL.ranger"</span>, <span class="at">tune =</span> <span class="fu">list</span>(<span class="at">mtry =</span> mtry_seq))</span>
<span id="cb130-304"><a href="#cb130-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-305"><a href="#cb130-305" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the resulting object</span></span>
<span id="cb130-306"><a href="#cb130-306" aria-hidden="true" tabindex="-1"></a>learners</span>
<span id="cb130-307"><a href="#cb130-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-308"><a href="#cb130-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-309"><a href="#cb130-309" aria-hidden="true" tabindex="-1"></a>SL.ranger_1</span>
<span id="cb130-310"><a href="#cb130-310" aria-hidden="true" tabindex="-1"></a>SL.ranger_2</span>
<span id="cb130-311"><a href="#cb130-311" aria-hidden="true" tabindex="-1"></a>SL.ranger_3</span>
<span id="cb130-312"><a href="#cb130-312" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb130-313"><a href="#cb130-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-314"><a href="#cb130-314" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the CV.SuperLearner.</span></span>
<span id="cb130-315"><a href="#cb130-315" aria-hidden="true" tabindex="-1"></a><span class="co"># We use V = 3 to save computation time; for a real analysis use V = 10 or 20.</span></span>
<span id="cb130-316"><a href="#cb130-316" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, </span>
<span id="cb130-317"><a href="#cb130-317" aria-hidden="true" tabindex="-1"></a>                        <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">V =</span> <span class="dv">3</span>, </span>
<span id="cb130-318"><a href="#cb130-318" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb130-319"><a href="#cb130-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-320"><a href="#cb130-320" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb130-321"><a href="#cb130-321" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-322"><a href="#cb130-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-323"><a href="#cb130-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-324"><a href="#cb130-324" aria-hidden="true" tabindex="-1"></a>We see here that mtry = 7 performed a little bit better than mtry = 1 or mtry = 3, although the difference is not significant. If we used more data and more cross-validation folds we might see more drastic differences. A higher mtry does better when a small percentage of variables are predictive of the outcome, because it gives each tree a better chance of finding a useful variable.</span>
<span id="cb130-325"><a href="#cb130-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-326"><a href="#cb130-326" aria-hidden="true" tabindex="-1"></a>Note that SL.ranger and SL.ranger_2 have the same settings, and their performance is very similar - statistically a tie. It’s not exactly equivalent due to random variation in the two forests.</span>
<span id="cb130-327"><a href="#cb130-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-328"><a href="#cb130-328" aria-hidden="true" tabindex="-1"></a>A key difference with SuperLearner over caret or other frameworks is that we are not trying to choose the single best hyperparameter or model. Instead, we usually want the best weighted average. So we are including all of the different settings in our SuperLearner, and we may choose a weighted average that includes the same model multiple times but with different settings. That can give us better performance than choosing only the single best settings for a given algorithm, which has some random noise in any case.</span>
<span id="cb130-329"><a href="#cb130-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-330"><a href="#cb130-330" aria-hidden="true" tabindex="-1"></a>Multicore parallelization</span>
<span id="cb130-331"><a href="#cb130-331" aria-hidden="true" tabindex="-1"></a>SuperLearner makes it easy to use multiple CPU cores on your computer to speed up the calculations. We first need to setup R for multiple cores, then tell CV.SuperLearner to divide its computations across those cores.</span>
<span id="cb130-332"><a href="#cb130-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-333"><a href="#cb130-333" aria-hidden="true" tabindex="-1"></a>There are two ways to use multiple cores in R: the “multicore” system and the “snow” system. Windows only supports the “snow” system, which is more difficult to use, whereas macOS and Linux can use either one.</span>
<span id="cb130-334"><a href="#cb130-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-335"><a href="#cb130-335" aria-hidden="true" tabindex="-1"></a>First we show the “multicore” system version:</span>
<span id="cb130-336"><a href="#cb130-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-339"><a href="#cb130-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-340"><a href="#cb130-340" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup parallel computation - use all cores on our computer.</span></span>
<span id="cb130-341"><a href="#cb130-341" aria-hidden="true" tabindex="-1"></a>(<span class="at">num_cores =</span> RhpcBLASctl<span class="sc">::</span><span class="fu">get_num_cores</span>())</span>
<span id="cb130-342"><a href="#cb130-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-343"><a href="#cb130-343" aria-hidden="true" tabindex="-1"></a><span class="co"># Use 2 of those cores for parallel SuperLearner.</span></span>
<span id="cb130-344"><a href="#cb130-344" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace "2" with "num_cores" (without quotes) to use all cores.</span></span>
<span id="cb130-345"><a href="#cb130-345" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="dv">2</span>)</span>
<span id="cb130-346"><a href="#cb130-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-347"><a href="#cb130-347" aria-hidden="true" tabindex="-1"></a><span class="co"># Check how many parallel workers we are using (on macOS/Linux).</span></span>
<span id="cb130-348"><a href="#cb130-348" aria-hidden="true" tabindex="-1"></a><span class="fu">getOption</span>(<span class="st">"mc.cores"</span>)</span>
<span id="cb130-349"><a href="#cb130-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-350"><a href="#cb130-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-351"><a href="#cb130-351" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to set a different type of seed that works across cores.</span></span>
<span id="cb130-352"><a href="#cb130-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Otherwise the other cores will go rogue and we won't get repeatable results.</span></span>
<span id="cb130-353"><a href="#cb130-353" aria-hidden="true" tabindex="-1"></a><span class="co"># This version is for the "multicore" parallel system in R.</span></span>
<span id="cb130-354"><a href="#cb130-354" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>, <span class="st">"L'Ecuyer-CMRG"</span>)</span>
<span id="cb130-355"><a href="#cb130-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-356"><a href="#cb130-356" aria-hidden="true" tabindex="-1"></a><span class="co"># While this is running check CPU using in Activity Monitor / Task Manager.</span></span>
<span id="cb130-357"><a href="#cb130-357" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb130-358"><a href="#cb130-358" aria-hidden="true" tabindex="-1"></a>  cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-359"><a href="#cb130-359" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb130-360"><a href="#cb130-360" aria-hidden="true" tabindex="-1"></a>                          <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb130-361"><a href="#cb130-361" aria-hidden="true" tabindex="-1"></a>                          <span class="at">parallel =</span> <span class="st">"multicore"</span>,</span>
<span id="cb130-362"><a href="#cb130-362" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb130-363"><a href="#cb130-363" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb130-364"><a href="#cb130-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-365"><a href="#cb130-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb130-366"><a href="#cb130-366" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-367"><a href="#cb130-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-368"><a href="#cb130-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-369"><a href="#cb130-369" aria-hidden="true" tabindex="-1"></a>Here is the “snow” equivalent:</span>
<span id="cb130-370"><a href="#cb130-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-373"><a href="#cb130-373" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-374"><a href="#cb130-374" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a snow cluster</span></span>
<span id="cb130-375"><a href="#cb130-375" aria-hidden="true" tabindex="-1"></a><span class="co"># Again, replace 2 with num_cores to use all available cores.</span></span>
<span id="cb130-376"><a href="#cb130-376" aria-hidden="true" tabindex="-1"></a>cluster <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">makeCluster</span>(<span class="dv">2</span>)</span>
<span id="cb130-377"><a href="#cb130-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-378"><a href="#cb130-378" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the cluster object.</span></span>
<span id="cb130-379"><a href="#cb130-379" aria-hidden="true" tabindex="-1"></a>cluster</span>
<span id="cb130-380"><a href="#cb130-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-381"><a href="#cb130-381" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the SuperLearner package on all workers so they can find</span></span>
<span id="cb130-382"><a href="#cb130-382" aria-hidden="true" tabindex="-1"></a><span class="co"># SuperLearner::All(), the default screening function which keeps all variables.</span></span>
<span id="cb130-383"><a href="#cb130-383" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterEvalQ</span>(cluster, <span class="fu">library</span>(SuperLearner))</span>
<span id="cb130-384"><a href="#cb130-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-385"><a href="#cb130-385" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to explictly export our custom learner functions to the workers.</span></span>
<span id="cb130-386"><a href="#cb130-386" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterExport</span>(cluster, learners<span class="sc">$</span>names)</span>
<span id="cb130-387"><a href="#cb130-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-388"><a href="#cb130-388" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to set a different type of seed that works across cores.</span></span>
<span id="cb130-389"><a href="#cb130-389" aria-hidden="true" tabindex="-1"></a><span class="co"># This version is for SNOW parallelization.</span></span>
<span id="cb130-390"><a href="#cb130-390" aria-hidden="true" tabindex="-1"></a><span class="co"># Otherwise the other cores will go rogue and we won't get repeatable results.</span></span>
<span id="cb130-391"><a href="#cb130-391" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterSetRNGStream</span>(cluster, <span class="dv">1</span>)</span>
<span id="cb130-392"><a href="#cb130-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-393"><a href="#cb130-393" aria-hidden="true" tabindex="-1"></a><span class="co"># While this is running check CPU using in Activity Monitor / Task Manager.</span></span>
<span id="cb130-394"><a href="#cb130-394" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb130-395"><a href="#cb130-395" aria-hidden="true" tabindex="-1"></a>  cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-396"><a href="#cb130-396" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb130-397"><a href="#cb130-397" aria-hidden="true" tabindex="-1"></a>                          <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb130-398"><a href="#cb130-398" aria-hidden="true" tabindex="-1"></a>                          <span class="at">parallel =</span> cluster,</span>
<span id="cb130-399"><a href="#cb130-399" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb130-400"><a href="#cb130-400" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb130-401"><a href="#cb130-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-402"><a href="#cb130-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb130-403"><a href="#cb130-403" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-404"><a href="#cb130-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-405"><a href="#cb130-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop the cluster workers now that we're done.</span></span>
<span id="cb130-406"><a href="#cb130-406" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">stopCluster</span>(cluster)</span>
<span id="cb130-407"><a href="#cb130-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-408"><a href="#cb130-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-409"><a href="#cb130-409" aria-hidden="true" tabindex="-1"></a>If we want to use multiple cores for normal SuperLearner, not CV.SuperLearner (i.e. external cross-validation to estimate performance), we need to change the function name to mcSuperLearner (“multicore” version) or snowSuperLearner (“snow” version).</span>
<span id="cb130-410"><a href="#cb130-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-411"><a href="#cb130-411" aria-hidden="true" tabindex="-1"></a>First the “multicore” version (won’t be parallel on Windows):</span>
<span id="cb130-412"><a href="#cb130-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-415"><a href="#cb130-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-416"><a href="#cb130-416" aria-hidden="true" tabindex="-1"></a><span class="co"># Set multicore compatible seed.</span></span>
<span id="cb130-417"><a href="#cb130-417" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>, <span class="st">"L'Ecuyer-CMRG"</span>)</span>
<span id="cb130-418"><a href="#cb130-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-419"><a href="#cb130-419" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the SuperLearner.</span></span>
<span id="cb130-420"><a href="#cb130-420" aria-hidden="true" tabindex="-1"></a>(<span class="at">sl =</span> <span class="fu">mcSuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-421"><a href="#cb130-421" aria-hidden="true" tabindex="-1"></a>                    <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>)))</span>
<span id="cb130-422"><a href="#cb130-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-423"><a href="#cb130-423" aria-hidden="true" tabindex="-1"></a><span class="co"># We see the time is reduced over our initial single-core superlearner.</span></span>
<span id="cb130-424"><a href="#cb130-424" aria-hidden="true" tabindex="-1"></a>sl<span class="sc">$</span>times<span class="sc">$</span>everything</span>
<span id="cb130-425"><a href="#cb130-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-426"><a href="#cb130-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-427"><a href="#cb130-427" aria-hidden="true" tabindex="-1"></a>Now the “snow” version, which should be parallel on all operating systems.</span>
<span id="cb130-428"><a href="#cb130-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-431"><a href="#cb130-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-432"><a href="#cb130-432" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a snow cluster</span></span>
<span id="cb130-433"><a href="#cb130-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Reminder: change "2" to "num_cores" (without quotes) to use all available cores.</span></span>
<span id="cb130-434"><a href="#cb130-434" aria-hidden="true" tabindex="-1"></a>(<span class="at">cluster =</span> parallel<span class="sc">::</span><span class="fu">makeCluster</span>(<span class="dv">2</span>))</span>
<span id="cb130-435"><a href="#cb130-435" aria-hidden="true" tabindex="-1"></a><span class="do">## socket cluster with 2 nodes on host 'localhost'</span></span>
<span id="cb130-436"><a href="#cb130-436" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the SuperLearner package on all workers so they can find</span></span>
<span id="cb130-437"><a href="#cb130-437" aria-hidden="true" tabindex="-1"></a><span class="co"># SuperLearner::All(), the default screening function which keeps all variables.</span></span>
<span id="cb130-438"><a href="#cb130-438" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterEvalQ</span>(cluster, <span class="fu">library</span>(SuperLearner))</span>
<span id="cb130-439"><a href="#cb130-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-440"><a href="#cb130-440" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to explictly export our custom learner functions to the workers.</span></span>
<span id="cb130-441"><a href="#cb130-441" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterExport</span>(cluster, learners<span class="sc">$</span>names)</span>
<span id="cb130-442"><a href="#cb130-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-443"><a href="#cb130-443" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to set a different type of seed that works across cores.</span></span>
<span id="cb130-444"><a href="#cb130-444" aria-hidden="true" tabindex="-1"></a><span class="co"># This version is for SNOW parallelization.</span></span>
<span id="cb130-445"><a href="#cb130-445" aria-hidden="true" tabindex="-1"></a><span class="co"># Otherwise the other cores will go rogue and we won't get repeatable results.</span></span>
<span id="cb130-446"><a href="#cb130-446" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">clusterSetRNGStream</span>(cluster, <span class="dv">1</span>)</span>
<span id="cb130-447"><a href="#cb130-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-448"><a href="#cb130-448" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the SuperLearner.</span></span>
<span id="cb130-449"><a href="#cb130-449" aria-hidden="true" tabindex="-1"></a>(<span class="at">sl =</span> <span class="fu">snowSuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-450"><a href="#cb130-450" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cluster =</span> cluster,</span>
<span id="cb130-451"><a href="#cb130-451" aria-hidden="true" tabindex="-1"></a>                      <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>)))</span>
<span id="cb130-452"><a href="#cb130-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-453"><a href="#cb130-453" aria-hidden="true" tabindex="-1"></a><span class="co"># We see the time is reduced over our initial single-core superlearner.</span></span>
<span id="cb130-454"><a href="#cb130-454" aria-hidden="true" tabindex="-1"></a>sl<span class="sc">$</span>times<span class="sc">$</span>everything</span>
<span id="cb130-455"><a href="#cb130-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-456"><a href="#cb130-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-457"><a href="#cb130-457" aria-hidden="true" tabindex="-1"></a>SuperLearner also supports running across multiple computers at a time, called “multi-node” or “cluster” computing. We will skip that for now.</span>
<span id="cb130-458"><a href="#cb130-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-459"><a href="#cb130-459" aria-hidden="true" tabindex="-1"></a><span class="fu">## Weight distribution for SuperLearner</span></span>
<span id="cb130-460"><a href="#cb130-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-461"><a href="#cb130-461" aria-hidden="true" tabindex="-1"></a>The weights or coefficients of the SuperLearner are stochastic - they will change as the data changes. So we don’t necessarily trust a given set of weights as being the “true” weights, but when we use CV.SuperLearner we at least have multiple samples from the distribution of the weights.</span>
<span id="cb130-462"><a href="#cb130-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-463"><a href="#cb130-463" aria-hidden="true" tabindex="-1"></a>We can write a little function to extract the weights at each CV.SuperLearner iteration and summarize the distribution of those weights. This may be added to the SuperLearner package sometime in the future.</span>
<span id="cb130-464"><a href="#cb130-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-467"><a href="#cb130-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-468"><a href="#cb130-468" aria-hidden="true" tabindex="-1"></a><span class="co"># Review meta-weights (coefficients) from a CV.SuperLearner object</span></span>
<span id="cb130-469"><a href="#cb130-469" aria-hidden="true" tabindex="-1"></a>review_weights <span class="ot">=</span> <span class="cf">function</span>(cv_sl) {</span>
<span id="cb130-470"><a href="#cb130-470" aria-hidden="true" tabindex="-1"></a>  meta_weights <span class="ot">=</span> <span class="fu">coef</span>(cv_sl)</span>
<span id="cb130-471"><a href="#cb130-471" aria-hidden="true" tabindex="-1"></a>  means <span class="ot">=</span> <span class="fu">colMeans</span>(meta_weights)</span>
<span id="cb130-472"><a href="#cb130-472" aria-hidden="true" tabindex="-1"></a>  sds <span class="ot">=</span> <span class="fu">apply</span>(meta_weights, <span class="at">MARGIN =</span> <span class="dv">2</span>,  <span class="at">FUN =</span> sd)</span>
<span id="cb130-473"><a href="#cb130-473" aria-hidden="true" tabindex="-1"></a>  mins <span class="ot">=</span> <span class="fu">apply</span>(meta_weights, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> min)</span>
<span id="cb130-474"><a href="#cb130-474" aria-hidden="true" tabindex="-1"></a>  maxs <span class="ot">=</span> <span class="fu">apply</span>(meta_weights, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> max)</span>
<span id="cb130-475"><a href="#cb130-475" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine the stats into a single matrix.</span></span>
<span id="cb130-476"><a href="#cb130-476" aria-hidden="true" tabindex="-1"></a>  sl_stats <span class="ot">=</span> <span class="fu">cbind</span>(<span class="st">"mean(weight)"</span> <span class="ot">=</span> means, <span class="st">"sd"</span> <span class="ot">=</span> sds, <span class="st">"min"</span> <span class="ot">=</span> mins, <span class="st">"max"</span> <span class="ot">=</span> maxs)</span>
<span id="cb130-477"><a href="#cb130-477" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by decreasing mean weight.</span></span>
<span id="cb130-478"><a href="#cb130-478" aria-hidden="true" tabindex="-1"></a>  sl_stats[<span class="fu">order</span>(sl_stats[, <span class="dv">1</span>], <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb130-479"><a href="#cb130-479" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-480"><a href="#cb130-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-481"><a href="#cb130-481" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">review_weights</span>(cv_sl), <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb130-482"><a href="#cb130-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-483"><a href="#cb130-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-484"><a href="#cb130-484" aria-hidden="true" tabindex="-1"></a>Notice that in this case the ensemble never uses the mean nor the randomForest with mtry = 1. Also the LASSO (glmnet) was only used on a subset of the folds. Adding multiple configurations of randomForest was helpful because mtry = 7 was used. However, based on the minimum column we can see that no algorithm was used every single time.</span>
<span id="cb130-485"><a href="#cb130-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-486"><a href="#cb130-486" aria-hidden="true" tabindex="-1"></a>We recommend reviewing the weight distribution for any SuperLearner project to better understand which algorithms are chosen for the ensemble.</span>
<span id="cb130-487"><a href="#cb130-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-488"><a href="#cb130-488" aria-hidden="true" tabindex="-1"></a><span class="fu">## Feature selection (screening)</span></span>
<span id="cb130-489"><a href="#cb130-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-490"><a href="#cb130-490" aria-hidden="true" tabindex="-1"></a>When datasets have many covariates our algorithms may benefit from first choosing a subset of available covariates, a step called feature selection. Then we pass only those variables to the modeling algorithm, and it may be less likely to overfit to variables that are not related to the outcome.</span>
<span id="cb130-491"><a href="#cb130-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-492"><a href="#cb130-492" aria-hidden="true" tabindex="-1"></a>Let’s revisit listWrappers() and check out the bottom section.</span>
<span id="cb130-493"><a href="#cb130-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-496"><a href="#cb130-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-497"><a href="#cb130-497" aria-hidden="true" tabindex="-1"></a><span class="fu">listWrappers</span>()</span>
<span id="cb130-498"><a href="#cb130-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-499"><a href="#cb130-499" aria-hidden="true" tabindex="-1"></a><span class="co"># Review code for corP, which is based on univariate correlation.</span></span>
<span id="cb130-500"><a href="#cb130-500" aria-hidden="true" tabindex="-1"></a>screen.corP</span>
<span id="cb130-501"><a href="#cb130-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-502"><a href="#cb130-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-503"><a href="#cb130-503" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb130-504"><a href="#cb130-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-505"><a href="#cb130-505" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the SuperLearner.</span></span>
<span id="cb130-506"><a href="#cb130-506" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to use list() instead of c().</span></span>
<span id="cb130-507"><a href="#cb130-507" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-508"><a href="#cb130-508" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb130-509"><a href="#cb130-509" aria-hidden="true" tabindex="-1"></a>                        <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb130-510"><a href="#cb130-510" aria-hidden="true" tabindex="-1"></a>                        <span class="at">parallel =</span> <span class="st">"multicore"</span>,</span>
<span id="cb130-511"><a href="#cb130-511" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">list</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="fu">c</span>(<span class="st">"SL.glmnet"</span>, <span class="st">"screen.corP"</span>)))</span>
<span id="cb130-512"><a href="#cb130-512" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-513"><a href="#cb130-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-514"><a href="#cb130-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-515"><a href="#cb130-515" aria-hidden="true" tabindex="-1"></a>We see a small performance boost by first screening by univarate correlation with our outcome, and only keeping variables with a p-value less than 0.10. Try using some of the other screening algorithms as they may do even better for a particular dataset.</span>
<span id="cb130-516"><a href="#cb130-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-517"><a href="#cb130-517" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optimize for AUC</span></span>
<span id="cb130-518"><a href="#cb130-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-519"><a href="#cb130-519" aria-hidden="true" tabindex="-1"></a>For binary prediction we are typically trying to maximize AUC, which can be the best performance metric when our outcome variable has some imbalance. In other words, we don’t have exactly 50% 1s and 50% 0s in our outcome. Our SuperLearner is not targeting AUC by default, but it can if we tell it to by specifying our method.</span>
<span id="cb130-520"><a href="#cb130-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-523"><a href="#cb130-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-524"><a href="#cb130-524" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb130-525"><a href="#cb130-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-526"><a href="#cb130-526" aria-hidden="true" tabindex="-1"></a>cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-527"><a href="#cb130-527" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb130-528"><a href="#cb130-528" aria-hidden="true" tabindex="-1"></a>                        <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb130-529"><a href="#cb130-529" aria-hidden="true" tabindex="-1"></a>                        <span class="at">method =</span> <span class="st">"method.AUC"</span>,</span>
<span id="cb130-530"><a href="#cb130-530" aria-hidden="true" tabindex="-1"></a>                        <span class="at">SL.library =</span> <span class="fu">list</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, <span class="fu">c</span>(<span class="st">"SL.glmnet"</span>, <span class="st">"screen.corP"</span>)))</span>
<span id="cb130-531"><a href="#cb130-531" aria-hidden="true" tabindex="-1"></a><span class="do">## Loading required package: cvAUC</span></span>
<span id="cb130-532"><a href="#cb130-532" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-533"><a href="#cb130-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-534"><a href="#cb130-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-535"><a href="#cb130-535" aria-hidden="true" tabindex="-1"></a>This conveniently shows us the AUC for each algorithm without us having to calculate it manually. But we aren’t getting SEs sadly.</span>
<span id="cb130-536"><a href="#cb130-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-537"><a href="#cb130-537" aria-hidden="true" tabindex="-1"></a>Another important optimizer to consider is negative log likelihood, which is intended for binary outcomes and will often work better than NNLS (the default). This is specified by method = “NNloglik”.</span>
<span id="cb130-538"><a href="#cb130-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-539"><a href="#cb130-539" aria-hidden="true" tabindex="-1"></a><span class="fu">## XGBoost hyperparameter exploration</span></span>
<span id="cb130-540"><a href="#cb130-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-541"><a href="#cb130-541" aria-hidden="true" tabindex="-1"></a>XGBoost is a version of GBM that is even faster and has some extra settings. GBM’s adaptivity is determined by its configuration, so we want to thoroughly test a wide range of configurations for any given problem. Let’s do 27 now. This will take a good amount of time (~7 minutes on my computer) so we need to at least use multiple cores, if not multiple computers.</span>
<span id="cb130-542"><a href="#cb130-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-545"><a href="#cb130-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-546"><a href="#cb130-546" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 * 3 * 3 = 27 different configurations.</span></span>
<span id="cb130-547"><a href="#cb130-547" aria-hidden="true" tabindex="-1"></a><span class="co"># For a real analysis we would do 100, 500, or 1000 trees - this is just a demo.</span></span>
<span id="cb130-548"><a href="#cb130-548" aria-hidden="true" tabindex="-1"></a>tune <span class="ot">=</span> <span class="fu">list</span>(<span class="at">ntrees =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>),</span>
<span id="cb130-549"><a href="#cb130-549" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_depth =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb130-550"><a href="#cb130-550" aria-hidden="true" tabindex="-1"></a>            <span class="at">shrinkage =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>))</span>
<span id="cb130-551"><a href="#cb130-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-552"><a href="#cb130-552" aria-hidden="true" tabindex="-1"></a><span class="co"># Set detailed names = T so we can see the configuration for each function.</span></span>
<span id="cb130-553"><a href="#cb130-553" aria-hidden="true" tabindex="-1"></a><span class="co"># Also shorten the name prefix.</span></span>
<span id="cb130-554"><a href="#cb130-554" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">create.Learner</span>(<span class="st">"SL.xgboost"</span>, <span class="at">tune =</span> tune, <span class="at">detailed_names =</span> <span class="cn">TRUE</span>, <span class="at">name_prefix =</span> <span class="st">"xgb"</span>)</span>
<span id="cb130-555"><a href="#cb130-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-556"><a href="#cb130-556" aria-hidden="true" tabindex="-1"></a><span class="co"># 27 configurations - not too shabby.</span></span>
<span id="cb130-557"><a href="#cb130-557" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(learners<span class="sc">$</span>names)</span>
<span id="cb130-558"><a href="#cb130-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-559"><a href="#cb130-559" aria-hidden="true" tabindex="-1"></a>learners<span class="sc">$</span>names</span>
<span id="cb130-560"><a href="#cb130-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-561"><a href="#cb130-561" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm we have multiple cores configured. This should be &gt; 1.</span></span>
<span id="cb130-562"><a href="#cb130-562" aria-hidden="true" tabindex="-1"></a><span class="fu">getOption</span>(<span class="st">"mc.cores"</span>)</span>
<span id="cb130-563"><a href="#cb130-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-564"><a href="#cb130-564" aria-hidden="true" tabindex="-1"></a><span class="co"># Remember to set multicore-compatible seed.</span></span>
<span id="cb130-565"><a href="#cb130-565" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>, <span class="st">"L'Ecuyer-CMRG"</span>)</span>
<span id="cb130-566"><a href="#cb130-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-567"><a href="#cb130-567" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the CV.SuperLearner.</span></span>
<span id="cb130-568"><a href="#cb130-568" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb130-569"><a href="#cb130-569" aria-hidden="true" tabindex="-1"></a>  cv_sl <span class="ot">=</span> <span class="fu">CV.SuperLearner</span>(<span class="at">Y =</span> y_train, <span class="at">X =</span> x_train, <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb130-570"><a href="#cb130-570" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># For a real analysis we would use V = 10.</span></span>
<span id="cb130-571"><a href="#cb130-571" aria-hidden="true" tabindex="-1"></a>                          <span class="at">V =</span> <span class="dv">3</span>,</span>
<span id="cb130-572"><a href="#cb130-572" aria-hidden="true" tabindex="-1"></a>                          <span class="at">parallel =</span> <span class="st">"multicore"</span>,</span>
<span id="cb130-573"><a href="#cb130-573" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SL.library =</span> <span class="fu">c</span>(<span class="st">"SL.mean"</span>, <span class="st">"SL.glmnet"</span>, learners<span class="sc">$</span>names, <span class="st">"SL.ranger"</span>))</span>
<span id="cb130-574"><a href="#cb130-574" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb130-575"><a href="#cb130-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-576"><a href="#cb130-576" aria-hidden="true" tabindex="-1"></a><span class="co"># Review results.</span></span>
<span id="cb130-577"><a href="#cb130-577" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cv_sl)</span>
<span id="cb130-578"><a href="#cb130-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-579"><a href="#cb130-579" aria-hidden="true" tabindex="-1"></a><span class="fu">review_weights</span>(cv_sl)</span>
<span id="cb130-580"><a href="#cb130-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-581"><a href="#cb130-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-582"><a href="#cb130-582" aria-hidden="true" tabindex="-1"></a>We can see how stochastic the weights are for each individual execution of SuperLearner.</span>
<span id="cb130-583"><a href="#cb130-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-584"><a href="#cb130-584" aria-hidden="true" tabindex="-1"></a>Finally, plot the performance for the different settings.</span>
<span id="cb130-587"><a href="#cb130-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb130-588"><a href="#cb130-588" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv_sl) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span>
<span id="cb130-589"><a href="#cb130-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb130-590"><a href="#cb130-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-591"><a href="#cb130-591" aria-hidden="true" tabindex="-1"></a><span class="fu">## Troubleshooting</span></span>
<span id="cb130-592"><a href="#cb130-592" aria-hidden="true" tabindex="-1"></a>If you get an error about predict for xgb.Booster, you probably need to install the latest version of XGBoost from github.</span>
<span id="cb130-593"><a href="#cb130-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-594"><a href="#cb130-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-595"><a href="#cb130-595" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Copyright 2024, Oren Bochman
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../about.html">
<p>About</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../license.html">
<p>License</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../trademark.html">
<p>Trademark</p>
</a>
  </li>  
</ul>
    <div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","selector":".lightbox","openEffect":"zoom","descPosition":"bottom","loop":false});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>